import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Qe,K as _,A as qe,B as et,C as Fe,J as tt,am as U,F as te,D as j,w as u,M as g,G as oe,ao as ot}from"../chunks/Ehb9Q6W5.js";import{o as nt,e as B,h as rt}from"../chunks/BKIJojkU.js";import{s as Ee}from"../chunks/yJVuIktW.js";import{b as ve}from"../chunks/m2zDNTuv.js";import{i as st}from"../chunks/D631TkqT.js";import{S as at,m as J,M as it}from"../chunks/VYvS0YDk.js";import{o as lt}from"../chunks/CUZUMNKG.js";import{Y as _e}from"../chunks/Br037vyA.js";var ct=qe('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function ut(ne,G){Qe(G,!1);let Y=_(),V=_(),N=_(),s,p,re=_(50),q=!1,C=null,se=null;function we(e){g(re,e),se&&cancelAnimationFrame(se),se=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let ae=_({lng:4.5,lat:50.5}),be=_(8);const xe=new WeakMap;function Pe(e){let o=xe.get(e);return o||(o=new Set,xe.set(e,o)),o}function Be(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let Te=new Set;function Ne(e,o,a=3e3){return new Promise(d=>{let i=!1;const I=()=>{i||(i=!0,P(),Te.delete(b),d())},b=()=>{i||(console.log("Tile wait cancelled - user is interacting"),I())};Te.add(b);const l=()=>{o.every(Q=>{const ee=Q.replace(/-layer$/,"");return!!e.getSource(ee)&&e.isSourceLoaded(ee)})&&e.areTilesLoaded()&&I()},$=()=>{console.log("Map movement detected - finishing tile wait early"),I()},F=setTimeout(I,a),P=()=>{e.off("idle",l),e.off("movestart",$),clearTimeout(F)};e.on("idle",l),e.on("movestart",$),l()})}function Re(e,o,a=512){const d=o.id,i=`${o.id}-layer`;return e.getSource(d)||e.addSource(d,{type:"raster",tiles:[Be(o,a)],tileSize:a,maxzoom:18}),e.getLayer(i)||e.addLayer({id:i,type:"raster",source:d,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),i}const m=lt.orthophotos.reduce((e,o)=>{const a=o.year.split(" ")[0],d=e.find(i=>i.year===a);return d?d.layers.push(o):e.push({id:a,year:a,displayYear:a,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,a)=>{const d=i=>/Printemps/i.test(i)?0:/Été|Ete/i.test(i)?1:2;return d(o.year)-d(a.year)})}));let M=_(m[0].id),z=_(m[m.length-1].id);function A(){q=!1,C!==null&&(clearTimeout(C),C=null)}function ke(e){e.preventDefault(),e.stopPropagation(),q=!0,C!==null&&clearTimeout(C),C=window.setTimeout(()=>{console.warn("Drag timeout - forcing reset"),A()},1e4)}function We(e){if(!q||!u(N))return;e.preventDefault();const o=u(N).getBoundingClientRect(),a=e.clientX-o.left;we(Math.max(0,Math.min(100,a/o.width*100)))}function De(){A()}function Ge(e){q=!0,C!==null&&clearTimeout(C),C=window.setTimeout(()=>{console.warn("Touch timeout - forcing reset"),A()},1e4)}function Ye(e){if(!q||!u(N))return;if(!e.touches||e.touches.length===0){A();return}const o=u(N).getBoundingClientRect(),a=e.touches[0].clientX-o.left;we(Math.max(0,Math.min(100,a/o.width*100)))}function Oe(){A()}function Ze(){A()}function Ce(){document.hidden&&q&&(console.log("Page hidden - resetting drag state"),A())}const ie=new WeakMap;async function R(e,o){const a=ie.get(e);a&&(console.log("Waiting for previous layer change to complete..."),await a);const d=(async()=>{const i=Pe(e),I=[...i],b=o.layers.map(l=>Re(e,l,512));requestAnimationFrame(()=>{b.forEach(l=>{e.getLayer(l)&&e.moveLayer(l)})}),await Ne(e,b,1500),requestAnimationFrame(()=>{b.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",1)}),I.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",0)})}),setTimeout(()=>{I.forEach(l=>{if(!b.includes(l)){const $=l.replace(/-layer$/,"");e.getLayer(l)&&e.removeLayer(l),e.getSource($)&&e.removeSource($),i.delete(l)}}),b.forEach(l=>i.add(l))},400)})();ie.set(e,d),await d,ie.delete(e)}let O=null;function He(e){if(!s)return;const o=m.find(a=>a.id===e);o&&(R(s,o),g(M,e),O&&O(!0))}function Ue(e){if(!p)return;const o=m.find(a=>a.id===e);o&&(R(p,o),g(z,e),O&&O(!0))}nt(()=>{let e=!1;const o=new Map,a=[[2.75,49.45],[6.5,50.85]],d=[[2,49],[7.2,51.3]];let i=null;(()=>{if(typeof window>"u")return!1;const n=window.location.hash.slice(1);if(!n)return!1;const t=n.split(",");if(t.length>=3){const r=parseFloat(t[0]),c=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(r)&&!isNaN(c)&&!isNaN(h)){if(i={center:[c,r],zoom:h},t.length>=5){const L=t[3],E=t[4];m.find(y=>y.id===L)&&g(M,L),m.find(y=>y.id===E)&&g(z,E)}return!0}}return!1})();const b=m.find(n=>n.id===u(M)),l=m.find(n=>n.id===u(z)),$={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},F={container:u(Y),style:$,minZoom:7,maxZoom:17,maxBounds:d,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(F.center=i.center,F.zoom=i.zoom):(F.bounds=a,F.fitBoundsOptions={padding:-50}),s=new J.Map(F);const P={container:u(V),style:JSON.parse(JSON.stringify($)),minZoom:7,maxZoom:17,maxBounds:d,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(P.center=i.center,P.zoom=i.zoom):(P.bounds=a,P.fitBoundsOptions={padding:-50}),p=new J.Map(P);const ue=new Map,Q=n=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const r=ue.get(t.sourceId)||0;r<2&&(ue.set(t.sourceId,r+1),setTimeout(()=>{const c=n.getSource(t.sourceId);c&&"reload"in c&&c.reload()},1e3*(r+1)))}};s.on("error",Q(s)),p.on("error",Q(p)),s.once("load",()=>R(s,b)),p.once("load",()=>R(p,l)),s.addControl(new J.NavigationControl,"bottom-left"),s.addControl(new J.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const ee={forwardGeocode:async n=>{const t=(n.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const r=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:r};const L=`https://nominatim.openstreetmap.org/search?q=${h}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,y=await(await fetch(L,{headers:{"Accept-Language":"fr"}})).json(),H=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of y.features??[]){const he=v.properties?.address?.state,Xe=v.properties?.address?.county;if(!(he==="Wallonie"||he==="Région wallonne"||H.some(T=>Xe?.includes(T)||he?.includes(T))))continue;const ge=v.bbox,S=Array.isArray(ge)&&ge.length===4?ge.map(Number):void 0;let W;if(S)W=[S[0]+(S[2]-S[0])/2,S[1]+(S[3]-S[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))W=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const T=[],$e=f=>{f&&(f.type==="Point"?T.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>T.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>T.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>T.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach($e))};if($e(v.geometry),T.length){const f=T.map(ye=>ye[0]),w=T.map(ye=>ye[1]),D=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];W=[D[0]+(D[2]-D[0])/2,D[1]+(D[3]-D[1])/2]}else W=[4.4699,50.5039]}r.push({type:"Feature",geometry:{type:"Point",coordinates:W},place_name:v.properties?.display_name,properties:{...v.properties,bbox:S},text:v.properties?.display_name,place_type:["place"],center:W,bbox:S})}}catch(h){console.error("forwardGeocode error:",h)}const c={type:"FeatureCollection",features:r};if(o.size>=50){const h=o.keys().next().value;h!==void 0&&o.delete(h)}return o.set(t,c),c}},k=new it(ee,{maplibregl:J,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});s.addControl(k,"top-left");const ze=n=>{const t=n.bbox??n.properties?.bbox;t&&Array.isArray(t)&&t.length===4?s.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):s.flyTo({center:n.center,zoom:15,duration:1200})};let Z=[],x=0;k.on("results",n=>{Z=n.features||[],x=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(r=>r.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&n.addEventListener("keydown",t=>{const r=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&Z.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const c=Z[x];c&&(ze(c),t.target.value="",k.clear(),Z=[])}else t.key==="ArrowDown"&&r.length>0?(t.preventDefault(),x=Math.min(x+1,Z.length-1),r.forEach(c=>c.classList.remove("active")),r[x]&&r[x].classList.add("active")):t.key==="ArrowUp"&&r.length>0&&(t.preventDefault(),x=Math.max(x-1,0),r.forEach(c=>c.classList.remove("active")),r[x]&&r[x].classList.add("active"))},!0)},100),k.on("result",n=>{const t=n.result;ze(t),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&(r.value=""),k.clear()},100)});const Ve=(n,t)=>{e||(e=!0,t.jumpTo({center:n.getCenter(),zoom:n.getZoom(),bearing:n.getBearing(),pitch:n.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let de=null,Ae="";const fe=(n=!1)=>{if(typeof window>"u"||!s)return;const t=s.getCenter(),r=s.getZoom(),c=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${r.toFixed(2)}z,${u(M)},${u(z)}`;c!==Ae&&(Ae=c,n?window.location.hash=c:history.replaceState(null,"",`#${c}`))};O=fe,s.on("move",()=>{!q&&!e&&Ve(s,p);const n=s.getCenter();g(ae,{lng:n.lng,lat:n.lat}),g(be,s.getZoom()),fe(!1),de&&clearTimeout(de),de=window.setTimeout(()=>{fe(!0)},1e3)});let pe=null;const me=()=>{pe||(pe=window.setTimeout(()=>{s&&s.resize(),p&&p.resize(),pe=null},250))};setTimeout(me,100),window.addEventListener("resize",me);const Ie=()=>{if(typeof window>"u")return;const n=window.location.hash.slice(1);if(!n)return;const t=n.split(",");if(t.length>=3){const r=parseFloat(t[0]),c=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(r)&&!isNaN(c)&&!isNaN(h)&&(s&&s.flyTo({center:[c,r],zoom:h,duration:1e3}),t.length>=5)){const L=t[3],E=t[4];if(L&&L!==u(M)){const y=m.find(H=>H.id===L);y&&(g(M,L),R(s,y))}if(E&&E!==u(z)){const y=m.find(H=>H.id===E);y&&(g(z,E),R(p,y))}}}};window.addEventListener("hashchange",Ie),document.addEventListener("visibilitychange",Ce);const Ke=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",me),window.removeEventListener("hashchange",Ie),document.removeEventListener("visibilitychange",Ce),clearInterval(Ke),A(),s.remove(),p.remove()}}),st();var le=ct();B("mousemove",U,We),B("mouseup",U,De),B("touchmove",U,Ye),B("touchend",U,Oe),B("touchcancel",U,Ze);var K=te(le),Le=te(K);ve(Le,e=>g(Y,e),()=>u(Y));var ce=j(Le,2);ve(ce,e=>g(V,e),()=>u(V));var X=j(ce,2),Se=te(X);oe(X);var je=j(X,2);at(je,{get lat(){return u(ae).lat},get lng(){return u(ae).lng},get zoom(){return u(be)},get yearBefore(){return u(M)},get yearAfter(){return u(z)},shareText:""}),oe(K),ve(K,e=>g(N,e),()=>u(N));var Me=j(K,2);_e(Me,{side:"left",get groups(){return m},get selectedId(){return u(M)},$$events:{select:e=>He(e.detail.id)}});var Je=j(Me,2);_e(Je,{side:"right",get groups(){return m},get selectedId(){return u(z)},$$events:{select:e=>Ue(e.detail.id)}}),oe(le),et(()=>{Ee(ce,`clip-path: inset(0 0 0 calc(${u(re)??""}% - 0.5px))`),Ee(X,`left: ${u(re)??""}%`)}),B("mousedown",Se,ke),B("touchstart",Se,Ge),Fe(ne,le),tt()}var dt=qe('<div class="page-container svelte-q4ucql"><!></div>');function Ct(ne){var G=dt();rt(V=>{ot.title="Timelapse - Comparaison d'orthophotos"});var Y=te(G);ut(Y,{}),oe(G),Fe(ne,G)}export{Ct as component};
