import"../chunks/DsnmJJEf.js";import"../chunks/Cflq-a96.js";import{as as Me,D as J,F as te,G as X,at as Se,z as a,J as x,K as g,I as H,a6 as Z,R as q,u as ne,A as qe,aq as Ae,W as Te,aw as ie,av as je}from"../chunks/Dlg-gMpp.js";import{h as ke}from"../chunks/IuQqTbrd.js";import{c as Pe,e as A,s as le,o as Re}from"../chunks/COQ8bC4V.js";import{e as Be,i as De,s as ge}from"../chunks/DXLIkSof.js";import{b as ye}from"../chunks/5YV8zeCu.js";import{i as Ie}from"../chunks/DMWEl-21.js";import{s as be,o as Ge,m as W,M as We}from"../chunks/B22aiAXe.js";import{i as Ze}from"../chunks/B6TdcFSY.js";import{s as Le}from"../chunks/C074pVVv.js";import{p as he}from"../chunks/B-TxigSj.js";var Ye=J('<span class="year-line svelte-7ujlbc"> </span> <span class="year-line svelte-7ujlbc"> </span>',1),Fe=J('<span class="year-line svelte-7ujlbc"> </span>'),Ne=J('<div role="button" tabindex="0"><div class="circle svelte-7ujlbc"><div class="year-label svelte-7ujlbc"><!></div></div></div>'),Oe=J('<div><button class="expand-button svelte-7ujlbc"> </button> <div></div></div>');function Ce(K,_){Me(_,!1);let P=he(_,"side",8,"left"),T=he(_,"groups",24,()=>[]),M=he(_,"selectedId",8);const s=Pe();let c=Z(!1);function R(B){s("select",{id:B}),q(c,!1)}function S(){q(c,!a(c))}Ie();var m=Oe();let Y;var I=x(m),j=x(I,!0);g(I);var V=H(I,2);let re;Be(V,5,T,De,(B,y,ce)=>{var z=Ne();let D;var ae=x(z),oe=x(ae),Q=x(oe);{var F=b=>{const E=Te(()=>{const[i,n]=(a(y),ne(()=>a(y).displayYear.split("-")));return{start:i,end:n}});var G=Ye(),N=Ae(G),de=x(N,!0);g(N);var e=H(N,2),o=x(e,!0);g(e),te(()=>{le(de,a(E).start),le(o,a(E).end)}),X(b,G)},se=b=>{var E=Fe(),G=x(E,!0);g(E),te(()=>le(G,(a(y),ne(()=>a(y).displayYear)))),X(b,E)};Ze(Q,b=>{a(y),ne(()=>a(y).displayYear.includes("-"))?b(F):b(se,!1)})}g(oe),g(ae),g(z),te(b=>{D=be(z,1,"year-circle svelte-7ujlbc",null,D,b),ge(z,`--index: ${ce}; --total: ${qe(T()),ne(()=>T().length)??""}`)},[()=>({selected:M()===a(y).id,"is-selected-year":M()===a(y).id})]),A("click",z,()=>R(a(y).id)),A("keydown",z,b=>b.key==="Enter"&&R(a(y).id)),X(B,z)}),g(V),g(m),te((B,y)=>{Y=be(m,1,"year-picker-wrapper svelte-7ujlbc",null,Y,B),Le(m,"data-side",P()),Le(I,"title",a(c)?"Collapse":"Expand"),le(j,a(c)?"−":"+"),re=be(V,1,"year-circles svelte-7ujlbc",null,re,y)},[()=>({expanded:a(c)}),()=>({expanded:a(c)})]),A("click",I,S),X(K,m),Se()}var Ue=J('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div></div> <!> <!></div>');function Xe(K,_){Me(_,!1);let P=Z(),T=Z(),M=Z(),s,c,R=Z(50),S=!1;const m=Ge.orthophotos.reduce((e,o)=>{const i=o.year.split(" ")[0],n=e.find(d=>d.year===i);return n?n.layers.push(o):e.push({id:i,year:i,displayYear:i,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,i)=>{const n=d=>/Printemps/i.test(d)?0:/Été|Ete/i.test(d)?1:2;return n(o.year)-n(i.year)})}));let Y=Z(m[0].id),I=Z(m[m.length-1].id),j={};function V(e){e.preventDefault(),e.stopPropagation(),S=!0}function re(e){if(!S||!a(M))return;e.preventDefault();const o=a(M).getBoundingClientRect(),i=e.clientX-o.left;q(R,Math.max(0,Math.min(100,i/o.width*100)))}function B(){S=!1}function y(e){e.preventDefault(),e.stopPropagation(),S=!0}function ce(e){if(!S||!a(M))return;e.preventDefault();const o=a(M).getBoundingClientRect(),i=e.touches[0].clientX-o.left;q(R,Math.max(0,Math.min(100,i/o.width*100)))}function z(){S=!1}function D(e,o){const i=e.getStyle();if(i?.layers)for(const n of i.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const d=n.source;d&&e.getSource(d)&&e.removeSource(d)}o.layers.forEach(n=>{const d=n.id,k=`${n.id}-layer`;e.getSource(d)||e.addSource(d,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(k)||e.addLayer({id:k,type:"raster",source:d,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),o.layers.forEach(n=>{const d=`${n.id}-layer`;e.getLayer(d)&&e.moveLayer(d)}),o.layers.forEach(n=>{const d=`${n.id}-layer`;e.setPaintProperty(d,"raster-opacity",1)})}function ae(e){if(!s)return;const o=m.find(i=>i.id===e);o&&(D(s,o),q(Y,e))}function oe(e){if(!c)return;const o=m.find(i=>i.id===e);o&&(D(c,o),q(I,e))}Re(()=>{let e=!1;const o=[[2.75,49.45],[6.5,50.85]],i=m.find(r=>r.id===a(Y)),n=m.find(r=>r.id===a(I));s=new W.Map({container:a(P),style:{version:8,sources:{},layers:[]},bounds:o,fitBoundsOptions:{padding:0},minZoom:8,maxZoom:17,attributionControl:!1}),c=new W.Map({container:a(T),style:{version:8,sources:{},layers:[]},bounds:o,fitBoundsOptions:{padding:0},minZoom:8,maxZoom:17,interactive:!1,attributionControl:!1}),s.once("load",()=>D(s,i)),c.once("load",()=>D(c,n)),s.addControl(new W.NavigationControl,"bottom-left"),s.addControl(new W.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const d={forwardGeocode:async r=>{const t=[];try{const l=encodeURIComponent((r.query??"").trim());if(!l)return{type:"FeatureCollection",features:t};const h=`https://nominatim.openstreetmap.org/search?q=${l}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,u=await(await fetch(h,{headers:{"Accept-Language":"fr"}})).json(),v=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const p of u.features??[]){const fe=p.properties?.address?.state,$e=p.properties?.address?.county;if(!(fe==="Wallonie"||fe==="Région wallonne"||v.some(C=>$e?.includes(C)||fe?.includes(C))))continue;const me=p.bbox,$=Array.isArray(me)&&me.length===4?me.map(Number):void 0;let O;if($)O=[$[0]+($[2]-$[0])/2,$[1]+($[3]-$[1])/2];else if(p.geometry?.type==="Point"&&Array.isArray(p.geometry.coordinates))O=[Number(p.geometry.coordinates[0]),Number(p.geometry.coordinates[1])];else{const C=[],Ee=f=>{f&&(f.type==="Point"?C.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>C.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>C.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>C.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(Ee))};if(Ee(p.geometry),C.length){const f=C.map(ve=>ve[0]),w=C.map(ve=>ve[1]),U=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];O=[U[0]+(U[2]-U[0])/2,U[1]+(U[3]-U[1])/2]}else O=[4.4699,50.5039]}t.push({type:"Feature",geometry:{type:"Point",coordinates:O},place_name:p.properties?.display_name,properties:{...p.properties,bbox:$},text:p.properties?.display_name,place_type:["place"],center:O,bbox:$})}}catch(l){console.error("forwardGeocode error:",l)}return{type:"FeatureCollection",features:t}}},k=new We(d,{maplibregl:W,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:200,minLength:2,showResultMarkers:!1});s.addControl(k,"top-left");const xe=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?s.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):s.flyTo({center:r.center,zoom:15,duration:1200})};let ee=[],L=0;k.on("results",r=>{ee=r.features||[],L=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(l=>l.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const l=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&ee.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const h=ee[L];h&&(xe(h),t.target.value="",k.clear(),ee=[])}else t.key==="ArrowDown"&&l.length>0?(t.preventDefault(),L=Math.min(L+1,ee.length-1),l.forEach(h=>h.classList.remove("active")),l[L]&&l[L].classList.add("active")):t.key==="ArrowUp"&&l.length>0&&(t.preventDefault(),L=Math.max(L-1,0),l.forEach(h=>h.classList.remove("active")),l[L]&&l[L].classList.add("active"))},!0)},100),k.on("result",r=>{const t=r.result;xe(t),setTimeout(()=>{const l=document.querySelector(".maplibregl-ctrl-geocoder input");l&&(l.value=""),k.clear()},100)});const ze=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};s.on("move",()=>{!S&&!e&&(ze(s,c),Object.values(j).forEach(r=>{r.jumpTo({center:s.getCenter(),zoom:s.getZoom(),bearing:s.getBearing(),pitch:s.getPitch()})}))});const we=()=>{m.forEach(r=>{const t=`before-${r.id}`,l=document.getElementById(`mini-${t}`);if(l&&!j[t])try{const u=new W.Map({container:l,style:{version:8,sources:{},layers:[]},center:s.getCenter(),zoom:s.getZoom(),interactive:!1,attributionControl:!1});u.once("load",()=>{r.layers.forEach(v=>{u.addSource(v.id,{type:"raster",tiles:[`${v.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),u.addLayer({id:`${v.id}-layer`,type:"raster",source:v.id,paint:{"raster-opacity":1,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(v=>{const p=`${v.id}-layer`;u.getLayer(p)&&u.moveLayer(p)})}),j[t]=u}catch(u){console.error("Error creating before minimap:",t,u)}const h=`after-${r.id}`,pe=document.getElementById(`mini-${h}`);if(pe&&!j[h])try{const u=new W.Map({container:pe,style:{version:8,sources:{},layers:[]},center:c.getCenter(),zoom:c.getZoom(),interactive:!1,attributionControl:!1});u.once("load",()=>{r.layers.forEach(v=>{u.addSource(v.id,{type:"raster",tiles:[`${v.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),u.addLayer({id:`${v.id}-layer`,type:"raster",source:v.id,paint:{"raster-opacity":1,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(v=>{const p=`${v.id}-layer`;u.getLayer(p)&&u.moveLayer(p)})}),j[h]=u}catch(u){console.error("Error creating after minimap:",h,u)}})};setTimeout(we,500);const _e=setInterval(()=>{we()},1e3);setTimeout(()=>clearInterval(_e),1e4);const ue=()=>{s&&s.resize(),c&&c.resize()};return setTimeout(ue,100),window.addEventListener("resize",ue),()=>{clearInterval(_e),window.removeEventListener("resize",ue),s.remove(),c.remove(),Object.values(j).forEach(r=>r.remove())}}),Ie();var Q=Ue();A("mousemove",ie,re),A("mouseup",ie,B),A("touchmove",ie,ce),A("touchend",ie,z);var F=x(Q),se=x(F);ye(se,e=>q(P,e),()=>a(P));var b=H(se,2);ye(b,e=>q(T,e),()=>a(T));var E=H(b,2),G=x(E);g(E),g(F),ye(F,e=>q(M,e),()=>a(M));var N=H(F,2);Ce(N,{side:"left",get groups(){return m},get selectedId(){return a(Y)},$$events:{select:e=>ae(e.detail.id)}});var de=H(N,2);Ce(de,{side:"right",get groups(){return m},get selectedId(){return a(I)},$$events:{select:e=>oe(e.detail.id)}}),g(Q),te(()=>{ge(b,`clip-path: inset(0 0 0 ${a(R)??""}%)`),ge(E,`left: ${a(R)??""}%`)}),A("mousedown",G,V),A("touchstart",G,y),X(K,Q),Se()}var He=J('<div class="page-container svelte-q4ucql"><!></div>');function ct(K){var _=He();ke(T=>{je.title="Timelapse - Comparaison d'orthophotos"});var P=x(_);Xe(P,{}),g(_),X(K,_)}export{ct as component};
