import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Ne,K as $,A as be,B as Me,C as xe,J as Fe,am as K,F as X,D as R,w as a,M as h,G as J,ao as Ie}from"../chunks/Ehb9Q6W5.js";import{o as ke,e as N,h as De}from"../chunks/BKIJojkU.js";import{s as ve}from"../chunks/yJVuIktW.js";import{b as de}from"../chunks/m2zDNTuv.js";import{i as Ge}from"../chunks/D631TkqT.js";import{S as Re,m as Y,M as Ye}from"../chunks/VYvS0YDk.js";import{o as We}from"../chunks/CUZUMNKG.js";import{Y as we}from"../chunks/Br037vyA.js";var Ze=be('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function He(V,M){Ne(M,!1);let F=$(),W=$(),E=$(),i,b,Z=$(50),A=!1,Q=$({lng:4.5,lat:50.5}),ue=$(8);const p=We.orthophotos.reduce((e,r)=>{const l=r.year.split(" ")[0],y=e.find(f=>f.year===l);return y?y.layers.push(r):e.push({id:l,year:l,displayYear:l,layers:[r]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((r,l)=>{const y=f=>/Printemps/i.test(f)?0:/Été|Ete/i.test(f)?1:2;return y(r.year)-y(l.year)})}));let S=$(p[0].id),T=$(p[p.length-1].id);function Le(e){e.preventDefault(),e.stopPropagation(),A=!0}function Ce(e){if(!A||!a(E))return;e.preventDefault();const r=a(E).getBoundingClientRect(),l=e.clientX-r.left;h(Z,Math.max(0,Math.min(100,l/r.width*100)))}function ze(){A=!1}function Se(e){e.preventDefault(),e.stopPropagation(),A=!0}function Te(e){if(!A||!a(E))return;e.preventDefault();const r=a(E).getBoundingClientRect(),l=e.touches[0].clientX-r.left;h(Z,Math.max(0,Math.min(100,l/r.width*100)))}function Pe(){A=!1}function _(e,r){const l=e.getStyle();if(l?.layers)for(const n of l.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const d=n.source;d&&e.getSource(d)&&e.removeSource(d)}r.layers.forEach(n=>{const d=n.id,k=`${n.id}-layer`;e.getSource(d)||e.addSource(d,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(k)||e.addLayer({id:k,type:"raster",source:d,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(n=>{const d=`${n.id}-layer`;e.getLayer(d)&&e.moveLayer(d)});const y=r.layers.map(n=>`${n.id}-layer`);let f=0;const O=y.length,oe=()=>{f++,f>=O&&y.forEach(n=>{e.getLayer(n)&&e.setPaintProperty(n,"raster-opacity",1)})},U=n=>{n.isSourceLoaded&&n.sourceId&&r.layers.some(d=>d.id===n.sourceId)&&oe()};e.on("sourcedata",U),setTimeout(()=>{e.off("sourcedata",U),y.forEach(n=>{e.getLayer(n)&&e.getPaintProperty(n,"raster-opacity")===0&&e.setPaintProperty(n,"raster-opacity",1)})},2e3)}let I=null;function $e(e){if(!i)return;const r=p.find(l=>l.id===e);r&&(_(i,r),h(S,e),I&&I(!0))}function Ae(e){if(!b)return;const r=p.find(l=>l.id===e);r&&(_(b,r),h(T,e),I&&I(!0))}ke(async()=>{let e=!1;const r=new Map,l=[[2.75,49.45],[6.5,50.85]],y=[[2,49],[7.2,51.3]];let f=null;const O=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),c=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(c)&&!isNaN(m)){if(f={center:[c,s],zoom:m},t.length>=5){const C=t[3],P=t[4];p.find(g=>g.id===C)&&h(S,C),p.find(g=>g.id===P)&&h(T,P)}return!0}}return!1};O()||(await new Promise(o=>setTimeout(o,10)),O());const oe=p.find(o=>o.id===a(S)),U=p.find(o=>o.id===a(T));i=new Y.Map({container:a(F),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:y,attributionControl:!1}),b=new Y.Map({container:a(W),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:y,interactive:!1,attributionControl:!1}),i.once("load",()=>_(i,oe)),b.once("load",()=>_(b,U)),i.addControl(new Y.NavigationControl,"bottom-left"),i.addControl(new Y.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const n={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(r.has(t))return r.get(t);const s=[];try{const m=encodeURIComponent(t);if(!m)return{type:"FeatureCollection",features:s};const C=`https://nominatim.openstreetmap.org/search?q=${m}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,g=await(await fetch(C,{headers:{"Accept-Language":"fr"}})).json(),G=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of g.features??[]){const ie=v.properties?.address?.state,Be=v.properties?.address?.county;if(!(ie==="Wallonie"||ie==="Région wallonne"||G.some(L=>Be?.includes(L)||ie?.includes(L))))continue;const le=v.bbox,z=Array.isArray(le)&&le.length===4?le.map(Number):void 0;let q;if(z)q=[z[0]+(z[2]-z[0])/2,z[1]+(z[3]-z[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))q=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const L=[],ge=u=>{u&&(u.type==="Point"?L.push([+u.coordinates[0],+u.coordinates[1]]):u.type==="LineString"||u.type==="MultiPoint"?u.coordinates.forEach(w=>L.push([+w[0],+w[1]])):u.type==="Polygon"||u.type==="MultiLineString"?u.coordinates.flat(1).forEach(w=>L.push([+w[0],+w[1]])):u.type==="MultiPolygon"?u.coordinates.flat(2).forEach(w=>L.push([+w[0],+w[1]])):u.type==="GeometryCollection"&&(u.geometries||[]).forEach(ge))};if(ge(v.geometry),L.length){const u=L.map(ce=>ce[0]),w=L.map(ce=>ce[1]),B=[Math.min(...u),Math.min(...w),Math.max(...u),Math.max(...w)];q=[B[0]+(B[2]-B[0])/2,B[1]+(B[3]-B[1])/2]}else q=[4.4699,50.5039]}s.push({type:"Feature",geometry:{type:"Point",coordinates:q},place_name:v.properties?.display_name,properties:{...v.properties,bbox:z},text:v.properties?.display_name,place_type:["place"],center:q,bbox:z})}}catch(m){console.error("forwardGeocode error:",m)}const c={type:"FeatureCollection",features:s};if(r.size>=50){const m=r.keys().next().value;m!==void 0&&r.delete(m)}return r.set(t,c),c}},d=new Ye(n,{maplibregl:Y,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});i.addControl(d,"top-left");const k=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?i.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):i.flyTo({center:o.center,zoom:15,duration:1200})};let D=[],x=0;d.on("results",o=>{D=o.features||[],x=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(s=>s.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const s=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&D.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const c=D[x];c&&(k(c),t.target.value="",d.clear(),D=[])}else t.key==="ArrowDown"&&s.length>0?(t.preventDefault(),x=Math.min(x+1,D.length-1),s.forEach(c=>c.classList.remove("active")),s[x]&&s[x].classList.add("active")):t.key==="ArrowUp"&&s.length>0&&(t.preventDefault(),x=Math.max(x-1,0),s.forEach(c=>c.classList.remove("active")),s[x]&&s[x].classList.add("active"))},!0)},100),d.on("result",o=>{const t=o.result;k(t),setTimeout(()=>{const s=document.querySelector(".maplibregl-ctrl-geocoder input");s&&(s.value=""),d.clear()},100)});const qe=(o,t)=>{e||(e=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let re=null,he="";const ne=(o=!1)=>{if(typeof window>"u"||!i)return;const t=i.getCenter(),s=i.getZoom(),c=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${s.toFixed(2)}z,${a(S)},${a(T)}`;c!==he&&(he=c,o?window.location.hash=c:history.replaceState(null,"",`#${c}`))};I=ne,i.on("move",()=>{!A&&!e&&qe(i,b);const o=i.getCenter();h(Q,{lng:o.lng,lat:o.lat}),h(ue,i.getZoom()),ne(!1),re&&clearTimeout(re),re=window.setTimeout(()=>{ne(!0)},1e3)});let se=null;const ae=()=>{se||(se=window.setTimeout(()=>{i&&i.resize(),b&&b.resize(),se=null},250))};setTimeout(ae,100),window.addEventListener("resize",ae);const ye=()=>{if(typeof window>"u")return;const o=window.location.hash.slice(1);if(!o)return;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),c=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(c)&&!isNaN(m)&&(i&&i.flyTo({center:[c,s],zoom:m,duration:1e3}),t.length>=5)){const C=t[3],P=t[4];if(C&&C!==a(S)){const g=p.find(G=>G.id===C);g&&(h(S,C),_(i,g))}if(P&&P!==a(T)){const g=p.find(G=>G.id===P);g&&(h(T,P),_(b,g))}}}};return window.addEventListener("hashchange",ye),()=>{window.removeEventListener("resize",ae),window.removeEventListener("hashchange",ye),i.remove(),b.remove()}}),Ge();var ee=Ze();N("mousemove",K,Ce),N("mouseup",K,ze),N("touchmove",K,Te),N("touchend",K,Pe);var H=X(ee),fe=X(H);de(fe,e=>h(F,e),()=>a(F));var te=R(fe,2);de(te,e=>h(W,e),()=>a(W));var j=R(te,2),pe=X(j);J(j);var Ee=R(j,2);Re(Ee,{get lat(){return a(Q).lat},get lng(){return a(Q).lng},get zoom(){return a(ue)},get yearBefore(){return a(S)},get yearAfter(){return a(T)},shareText:""}),J(H),de(H,e=>h(E,e),()=>a(E));var me=R(H,2);we(me,{side:"left",get groups(){return p},get selectedId(){return a(S)},$$events:{select:e=>$e(e.detail.id)}});var _e=R(me,2);we(_e,{side:"right",get groups(){return p},get selectedId(){return a(T)},$$events:{select:e=>Ae(e.detail.id)}}),J(ee),Me(()=>{ve(te,`clip-path: inset(0 0 0 ${a(Z)??""}%)`),ve(j,`left: ${a(Z)??""}%`)}),N("mousedown",pe,Le),N("touchstart",pe,Se),xe(V,ee),Fe()}var je=be('<div class="page-container svelte-q4ucql"><!></div>');function nt(V){var M=je();De(W=>{Ie.title="Timelapse - Comparaison d'orthophotos"});var F=X(M);He(F,{}),J(M),xe(V,M)}export{nt as component};
