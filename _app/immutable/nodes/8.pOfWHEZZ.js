import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Ke,K as $,A as $e,B as Xe,C as Ee,J as Qe,am as H,F as Q,D as U,w as c,M as g,G as ee,ao as et}from"../chunks/Ehb9Q6W5.js";import{o as tt,e as P,h as ot}from"../chunks/BKIJojkU.js";import{s as Ie}from"../chunks/yJVuIktW.js";import{b as ge}from"../chunks/m2zDNTuv.js";import{i as rt}from"../chunks/D631TkqT.js";import{S as nt,m as j,M as st}from"../chunks/VYvS0YDk.js";import{o as at}from"../chunks/CUZUMNKG.js";import{Y as Ae}from"../chunks/Br037vyA.js";var it=$e('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function lt(te,k){Ke(k,!1);let D=$(),J=$(),q=$(),a,p,oe=$(50),E=!1,T=null,re=null;function ye(e){g(oe,e),re&&cancelAnimationFrame(re),re=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let ne=$({lng:4.5,lat:50.5}),ve=$(8);const we=new WeakMap;function _e(e){let o=we.get(e);return o||(o=new Set,we.set(e,o)),o}function Pe(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}function qe(e,o,s=3e3){return new Promise(d=>{let i=!1;const u=()=>{i||(i=!0,X(),d())},I=()=>{o.every(_=>{const W=_.replace(/-layer$/,"");return!!e.getSource(W)&&e.isSourceLoaded(W)})&&e.areTilesLoaded()&&u()},ie=setTimeout(u,s),X=()=>{e.off("idle",I),clearTimeout(ie)};e.on("idle",I),I()})}function Be(e,o,s=512){const d=o.id,i=`${o.id}-layer`;return e.getSource(d)||e.addSource(d,{type:"raster",tiles:[Pe(o,s)],tileSize:s,maxzoom:18}),e.getLayer(i)||e.addLayer({id:i,type:"raster",source:d,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),i}const m=at.orthophotos.reduce((e,o)=>{const s=o.year.split(" ")[0],d=e.find(i=>i.year===s);return d?d.layers.push(o):e.push({id:s,year:s,displayYear:s,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,s)=>{const d=i=>/Printemps/i.test(i)?0:/Été|Ete/i.test(i)?1:2;return d(o.year)-d(s.year)})}));let M=$(m[0].id),S=$(m[m.length-1].id);function z(){E=!1,T!==null&&(clearTimeout(T),T=null)}function Fe(e){e.preventDefault(),e.stopPropagation(),E=!0,T!==null&&clearTimeout(T),T=window.setTimeout(()=>{console.warn("Drag timeout - forcing reset"),z()},1e4)}function Ne(e){if(!E||!c(q))return;e.preventDefault();const o=c(q).getBoundingClientRect(),s=e.clientX-o.left;ye(Math.max(0,Math.min(100,s/o.width*100)))}function Re(){z()}function ke(e){E=!0,T!==null&&clearTimeout(T),T=window.setTimeout(()=>{console.warn("Touch timeout - forcing reset"),z()},1e4)}function De(e){if(!E||!c(q))return;if(!e.touches||e.touches.length===0){z();return}const o=c(q).getBoundingClientRect(),s=e.touches[0].clientX-o.left;ye(Math.max(0,Math.min(100,s/o.width*100)))}function Ge(){z()}function We(){z()}function be(){document.hidden&&E&&(console.log("Page hidden - resetting drag state"),z())}async function B(e,o){const s=_e(e),d=[...s],i=o.layers.map(u=>Be(e,u,512));i.forEach(u=>e.moveLayer(u)),await qe(e,i,3e3),i.forEach(u=>{e.getLayer(u)&&e.setPaintProperty(u,"raster-opacity",1)}),d.forEach(u=>{e.getLayer(u)&&e.setPaintProperty(u,"raster-opacity",0)}),setTimeout(()=>{d.forEach(u=>{if(!i.includes(u)){const I=u.replace(/-layer$/,"");e.getLayer(u)&&e.removeLayer(u),e.getSource(I)&&e.removeSource(I),s.delete(u)}}),i.forEach(u=>s.add(u))},400)}let G=null;function Ye(e){if(!a)return;const o=m.find(s=>s.id===e);o&&(B(a,o),g(M,e),G&&G(!0))}function Oe(e){if(!p)return;const o=m.find(s=>s.id===e);o&&(B(p,o),g(S,e),G&&G(!0))}tt(()=>{let e=!1;const o=new Map,s=[[2.75,49.45],[6.5,50.85]],d=[[2,49],[7.2,51.3]];let i=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)){if(i={center:[l,n],zoom:h},t.length>=5){const C=t[3],A=t[4];m.find(y=>y.id===C)&&g(M,C),m.find(y=>y.id===A)&&g(S,A)}return!0}}return!1})();const I=m.find(r=>r.id===c(M)),ie=m.find(r=>r.id===c(S)),X={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},F={container:c(D),style:X,minZoom:7,maxZoom:17,maxBounds:d,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(F.center=i.center,F.zoom=i.zoom):(F.bounds=s,F.fitBoundsOptions={padding:-50}),a=new j.Map(F);const _={container:c(J),style:JSON.parse(JSON.stringify(X)),minZoom:7,maxZoom:17,maxBounds:d,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(_.center=i.center,_.zoom=i.zoom):(_.bounds=s,_.fitBoundsOptions={padding:-50}),p=new j.Map(_);const W=new Map,le=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=W.get(t.sourceId)||0;n<2&&(W.set(t.sourceId,n+1),setTimeout(()=>{const l=r.getSource(t.sourceId);l&&"reload"in l&&l.reload()},1e3*(n+1)))}};a.on("error",le(a)),p.on("error",le(p)),a.once("load",()=>B(a,I)),p.once("load",()=>B(p,ie)),a.addControl(new j.NavigationControl,"bottom-left"),a.addControl(new j.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const Ue={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:n};const C=`https://nominatim.openstreetmap.org/search?q=${h}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,y=await(await fetch(C,{headers:{"Accept-Language":"fr"}})).json(),Z=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of y.features??[]){const pe=v.properties?.address?.state,Ve=v.properties?.address?.county;if(!(pe==="Wallonie"||pe==="Région wallonne"||Z.some(x=>Ve?.includes(x)||pe?.includes(x))))continue;const me=v.bbox,L=Array.isArray(me)&&me.length===4?me.map(Number):void 0;let N;if(L)N=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))N=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const x=[],ze=f=>{f&&(f.type==="Point"?x.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>x.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>x.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>x.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(ze))};if(ze(v.geometry),x.length){const f=x.map(he=>he[0]),w=x.map(he=>he[1]),R=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];N=[R[0]+(R[2]-R[0])/2,R[1]+(R[3]-R[1])/2]}else N=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:N},place_name:v.properties?.display_name,properties:{...v.properties,bbox:L},text:v.properties?.display_name,place_type:["place"],center:N,bbox:L})}}catch(h){console.error("forwardGeocode error:",h)}const l={type:"FeatureCollection",features:n};if(o.size>=50){const h=o.keys().next().value;h!==void 0&&o.delete(h)}return o.set(t,l),l}},Y=new st(Ue,{maplibregl:j,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl(Y,"top-left");const Le=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:r.center,zoom:15,duration:1200})};let O=[],b=0;Y.on("results",r=>{O=r.features||[],b=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&O.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=O[b];l&&(Le(l),t.target.value="",Y.clear(),O=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),b=Math.min(b+1,O.length-1),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),b=Math.max(b-1,0),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active"))},!0)},100),Y.on("result",r=>{const t=r.result;Le(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),Y.clear()},100)});const je=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let ce=null,Me="";const ue=(r=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),n=a.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${c(M)},${c(S)}`;l!==Me&&(Me=l,r?window.location.hash=l:history.replaceState(null,"",`#${l}`))};G=ue,a.on("move",()=>{!E&&!e&&je(a,p);const r=a.getCenter();g(ne,{lng:r.lng,lat:r.lat}),g(ve,a.getZoom()),ue(!1),ce&&clearTimeout(ce),ce=window.setTimeout(()=>{ue(!0)},1e3)});let de=null;const fe=()=>{de||(de=window.setTimeout(()=>{a&&a.resize(),p&&p.resize(),de=null},250))};setTimeout(fe,100),window.addEventListener("resize",fe);const Se=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)&&(a&&a.flyTo({center:[l,n],zoom:h,duration:1e3}),t.length>=5)){const C=t[3],A=t[4];if(C&&C!==c(M)){const y=m.find(Z=>Z.id===C);y&&(g(M,C),B(a,y))}if(A&&A!==c(S)){const y=m.find(Z=>Z.id===A);y&&(g(S,A),B(p,y))}}}};window.addEventListener("hashchange",Se),document.addEventListener("visibilitychange",be);const Je=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",fe),window.removeEventListener("hashchange",Se),document.removeEventListener("visibilitychange",be),clearInterval(Je),z(),a.remove(),p.remove()}}),rt();var se=it();P("mousemove",H,Ne),P("mouseup",H,Re),P("touchmove",H,De),P("touchend",H,Ge),P("touchcancel",H,We);var V=Q(se),xe=Q(V);ge(xe,e=>g(D,e),()=>c(D));var ae=U(xe,2);ge(ae,e=>g(J,e),()=>c(J));var K=U(ae,2),Te=Q(K);ee(K);var Ze=U(K,2);nt(Ze,{get lat(){return c(ne).lat},get lng(){return c(ne).lng},get zoom(){return c(ve)},get yearBefore(){return c(M)},get yearAfter(){return c(S)},shareText:""}),ee(V),ge(V,e=>g(q,e),()=>c(q));var Ce=U(V,2);Ae(Ce,{side:"left",get groups(){return m},get selectedId(){return c(M)},$$events:{select:e=>Ye(e.detail.id)}});var He=U(Ce,2);Ae(He,{side:"right",get groups(){return m},get selectedId(){return c(S)},$$events:{select:e=>Oe(e.detail.id)}}),ee(se),Xe(()=>{Ie(ae,`clip-path: inset(0 0 0 calc(${c(oe)??""}% - 0.5px))`),Ie(K,`left: ${c(oe)??""}%`)}),P("mousedown",Te,Fe),P("touchstart",Te,ke),Ee(te,se),Qe()}var ct=$e('<div class="page-container svelte-q4ucql"><!></div>');function xt(te){var k=ct();ot(J=>{et.title="Timelapse - Comparaison d'orthophotos"});var D=Q(k);lt(D,{}),ee(k),Ee(te,k)}export{xt as component};
