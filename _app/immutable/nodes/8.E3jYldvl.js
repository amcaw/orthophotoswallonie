import"../chunks/DsnmJJEf.js";import"../chunks/CoDSuzm1.js";import{I as Ue,K as M,A as $e,B as je,C as _e,J as Je,F as ee,D as H,w as d,M as g,G as te,an as Ke}from"../chunks/BILf7VAl.js";import{o as Ve,e as Q,h as Xe}from"../chunks/XYDQtagk.js";import{s as Pe}from"../chunks/MQgf3nuD.js";import{b as ye}from"../chunks/B7CElIPH.js";import{i as Qe}from"../chunks/MHw7BI_m.js";import{S as et,m as Y,M as tt}from"../chunks/CccdXG49.js";import{o as ot}from"../chunks/CUZUMNKG.js";import{Y as Me}from"../chunks/gDwRjMFD.js";var rt=$e('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function nt(oe,B){Ue(B,!1);let R=M(),D=M(),O=M(),s,p,re=M(50),Z=!1,U=null,ne=null;function qe(e){g(re,e),ne&&cancelAnimationFrame(ne),ne=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let se=M({lng:4.5,lat:50.5}),ve=M(8);const we=new WeakMap;function Fe(e){let o=we.get(e);return o||(o=new Set,we.set(e,o)),o}function Ee(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let be=new Set;function Ne(e,o,c=3e3){return new Promise(u=>{let a=!1;const z=()=>{a||(a=!0,_(),be.delete(b),u())},b=()=>{a||(console.log("Tile wait cancelled - user is interacting"),z())};be.add(b);const i=()=>{o.every(V=>{const X=V.replace(/-layer$/,"");return!!e.getSource(X)&&e.isSourceLoaded(X)})&&e.areTilesLoaded()&&z()},A=()=>{console.log("Map movement detected - finishing tile wait early"),z()},$=setTimeout(z,c),_=()=>{e.off("idle",i),e.off("movestart",A),clearTimeout($)};e.on("idle",i),e.on("movestart",A),i()})}function Be(e,o,c=512){const u=o.id,a=`${o.id}-layer`;return e.getSource(u)||e.addSource(u,{type:"raster",tiles:[Ee(o,c)],tileSize:c,maxzoom:18}),e.getLayer(a)||e.addLayer({id:a,type:"raster",source:u,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),a}const m=ot.orthophotos.reduce((e,o)=>{const c=o.year.split(" ")[0],u=e.find(a=>a.year===c);return u?u.layers.push(o):e.push({id:c,year:c,displayYear:c,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,c)=>{const u=a=>/Printemps/i.test(a)?0:/Été|Ete/i.test(a)?1:2;return u(o.year)-u(c.year)})}));let I=M(m[0].id),S=M(m[m.length-1].id);function Re(e){e.currentTarget.setPointerCapture(e.pointerId),U=e.pointerId,Z=!0}function ke(e){if(!Z||U!==e.pointerId||!d(O))return;const o=d(O).getBoundingClientRect(),c=e.clientX-o.left;qe(Math.max(0,Math.min(100,c/o.width*100)))}function xe(e){if(U===e.pointerId){const o=e.currentTarget;try{o.releasePointerCapture(e.pointerId)}catch{}Z=!1,U=null}}const ae=new WeakMap;async function q(e,o){const c=ae.get(e);c&&(console.log("Waiting for previous layer change to complete..."),await c);const u=(async()=>{const a=Fe(e),z=[...a],b=o.layers.map(i=>Be(e,i,512));requestAnimationFrame(()=>{b.forEach(i=>{e.getLayer(i)&&e.moveLayer(i)})}),await Ne(e,b,1500),requestAnimationFrame(()=>{b.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",1)}),z.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",0)})}),setTimeout(()=>{z.forEach(i=>{if(!b.includes(i)){const A=i.replace(/-layer$/,"");e.getLayer(i)&&e.removeLayer(i),e.getSource(A)&&e.removeSource(A),a.delete(i)}}),b.forEach(i=>a.add(i))},400)})();ae.set(e,u),await u,ae.delete(e)}let k=null;function We(e){if(!s)return;const o=m.find(c=>c.id===e);o&&(q(s,o),g(I,e),k&&k(!0))}function Ge(e){if(!p)return;const o=m.find(c=>c.id===e);o&&(q(p,o),g(S,e),k&&k(!0))}Ve(()=>{let e=!1;const o=new Map,c=[[2.75,49.45],[6.5,50.85]],u=[[2,49],[7.2,51.3]];let a=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)){if(a={center:[l,n],zoom:h},t.length>=5){const L=t[3],P=t[4];m.find(y=>y.id===L)&&g(I,L),m.find(y=>y.id===P)&&g(S,P)}return!0}}return!1})();const b=m.find(r=>r.id===d(I)),i=m.find(r=>r.id===d(S)),A={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},$={container:d(R),style:A,minZoom:7,maxZoom:17,maxBounds:u,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};a?($.center=a.center,$.zoom=a.zoom):($.bounds=c,$.fitBoundsOptions={padding:-50}),s=new Y.Map($);const _={container:d(D),style:JSON.parse(JSON.stringify(A)),minZoom:7,maxZoom:17,maxBounds:u,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};a?(_.center=a.center,_.zoom=a.zoom):(_.bounds=c,_.fitBoundsOptions={padding:-50}),p=new Y.Map(_);const ce=new Map,V=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ce.get(t.sourceId)||0;n<2&&(ce.set(t.sourceId,n+1),setTimeout(()=>{const l=r.getSource(t.sourceId);l&&"reload"in l&&l.reload()},1e3*(n+1)))}};s.on("error",V(s)),p.on("error",V(p)),s.once("load",()=>q(s,b)),p.once("load",()=>q(p,i)),s.addControl(new Y.NavigationControl,"bottom-left"),s.addControl(new Y.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const X={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:n};const L=`https://nominatim.openstreetmap.org/search?q=${h}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,y=await(await fetch(L,{headers:{"Accept-Language":"fr"}})).json(),G=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of y.features??[]){const me=v.properties?.address?.state,Ze=v.properties?.address?.county;if(!(me==="Wallonie"||me==="Région wallonne"||G.some(C=>Ze?.includes(C)||me?.includes(C))))continue;const he=v.bbox,T=Array.isArray(he)&&he.length===4?he.map(Number):void 0;let E;if(T)E=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))E=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const C=[],Ae=f=>{f&&(f.type==="Point"?C.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>C.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>C.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>C.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(Ae))};if(Ae(v.geometry),C.length){const f=C.map(ge=>ge[0]),w=C.map(ge=>ge[1]),N=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];E=[N[0]+(N[2]-N[0])/2,N[1]+(N[3]-N[1])/2]}else E=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:E},place_name:v.properties?.display_name,properties:{...v.properties,bbox:T},text:v.properties?.display_name,place_type:["place"],center:E,bbox:T})}}catch(h){console.error("forwardGeocode error:",h)}const l={type:"FeatureCollection",features:n};if(o.size>=50){const h=o.keys().next().value;h!==void 0&&o.delete(h)}return o.set(t,l),l}},F=new tt(X,{maplibregl:Y,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});s.addControl(F,"top-left");const Te=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?s.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):s.flyTo({center:r.center,zoom:15,duration:1200})};let W=[],x=0;F.on("results",r=>{W=r.features||[],x=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&W.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=W[x];l&&(Te(l),t.target.value="",F.clear(),W=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),x=Math.min(x+1,W.length-1),n.forEach(l=>l.classList.remove("active")),n[x]&&n[x].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),x=Math.max(x-1,0),n.forEach(l=>l.classList.remove("active")),n[x]&&n[x].classList.add("active"))},!0)},100),F.on("result",r=>{const t=r.result;Te(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),F.clear()},100)});const De=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let de=null,Ie="";const ue=(r=!1)=>{if(typeof window>"u"||!s)return;const t=s.getCenter(),n=s.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${d(I)},${d(S)}`;l!==Ie&&(Ie=l,r?window.location.hash=l:history.replaceState(null,"",`#${l}`))};k=ue;let Se=0;s.on("move",()=>{!Z&&!e&&De(s,p);const r=s.getCenter();g(se,{lng:r.lng,lat:r.lat}),g(ve,s.getZoom());const t=performance.now();t-Se>120&&(ue(!1),Se=t),de&&clearTimeout(de),de=window.setTimeout(()=>{ue(!0)},800)});let fe=null;const pe=()=>{fe||(fe=window.setTimeout(()=>{s&&s.resize(),p&&p.resize(),fe=null},250))};setTimeout(pe,100),window.addEventListener("resize",pe);const ze=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)&&(s&&s.flyTo({center:[l,n],zoom:h,duration:1e3}),t.length>=5)){const L=t[3],P=t[4];if(L&&L!==d(I)){const y=m.find(G=>G.id===L);y&&(g(I,L),q(s,y))}if(P&&P!==d(S)){const y=m.find(G=>G.id===P);y&&(g(S,P),q(p,y))}}}};window.addEventListener("hashchange",ze);const Oe=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",pe),window.removeEventListener("hashchange",ze),clearInterval(Oe),s.remove(),p.remove()}}),Qe();var ie=rt(),j=ee(ie),Ce=ee(j);ye(Ce,e=>g(R,e),()=>d(R));var le=H(Ce,2);ye(le,e=>g(D,e),()=>d(D));var J=H(le,2),K=ee(J);te(J);var He=H(J,2);et(He,{get lat(){return d(se).lat},get lng(){return d(se).lng},get zoom(){return d(ve)},get yearBefore(){return d(I)},get yearAfter(){return d(S)},shareText:""}),te(j),ye(j,e=>g(O,e),()=>d(O));var Le=H(j,2);Me(Le,{side:"left",get groups(){return m},get selectedId(){return d(I)},$$events:{select:e=>We(e.detail.id)}});var Ye=H(Le,2);Me(Ye,{side:"right",get groups(){return m},get selectedId(){return d(S)},$$events:{select:e=>Ge(e.detail.id)}}),te(ie),je(()=>{Pe(le,`clip-path: inset(0 0 0 calc(${d(re)??""}% - 0.5px))`),Pe(J,`left: ${d(re)??""}%`)}),Q("pointerdown",K,Re),Q("pointermove",K,ke),Q("pointerup",K,xe),Q("pointercancel",K,xe),_e(oe,ie),Je()}var st=$e('<div class="page-container svelte-q4ucql"><!></div>');function yt(oe){var B=st();Xe(D=>{Ke.title="Timelapse - Comparaison d'orthophotos"});var R=ee(B);nt(R,{}),te(B),_e(oe,B)}export{yt as component};
