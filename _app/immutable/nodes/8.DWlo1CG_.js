import"../chunks/DsnmJJEf.js";import"../chunks/CQmyZwkG.js";import{I as rt,K as L,A as ke,B as nt,C as Re,J as at,F as re,D as _,w as a,M as m,G as ne,an as st}from"../chunks/CwdBl0A7.js";import{o as it,e as oe,h as lt}from"../chunks/CWmqxiNW.js";import{s as Ne}from"../chunks/CWYEOFQC.js";import{b as R}from"../chunks/Cgb6JafD.js";import{i as ct}from"../chunks/Ci2bA8W4.js";import{S as dt,m as Y,M as ut}from"../chunks/B8IqOMgz.js";import{o as ft}from"../chunks/CUZUMNKG.js";import{Y as Be}from"../chunks/BZ0HtTU2.js";var pt=ke('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="geocoder-overlay svelte-qt8w5r"></div> <div class="navigation-overlay svelte-qt8w5r"></div> <div class="attribution-overlay svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function mt(ae,W){rt(W,!1);let G=L(),O=L(),Z=L(),U=L(),j=L(),J=L(),i,h,se=L(50),K=!1,V=null,ie=null;function We(e){m(se,e),ie&&cancelAnimationFrame(ie),ie=requestAnimationFrame(()=>{h&&h.triggerRepaint()})}let le=L({lng:4.5,lat:50.5}),Le=L(8);const xe=new WeakMap;function Ge(e){let o=xe.get(e);return o||(o=new Set,xe.set(e,o)),o}function He(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let Se=new Set;function De(e,o,d=3e3){return new Promise(f=>{let l=!1;const z=()=>{l||(l=!0,$(),Se.delete(x),f())},x=()=>{l||(console.log("Tile wait cancelled - user is interacting"),z())};Se.add(x);const c=()=>{o.every(te=>{const pe=te.replace(/-layer$/,"");return!!e.getSource(pe)&&e.isSourceLoaded(pe)})&&e.areTilesLoaded()&&z()},P=()=>{console.log("Map movement detected - finishing tile wait early"),z()},M=setTimeout(z,d),$=()=>{e.off("idle",c),e.off("movestart",P),clearTimeout(M)};e.on("idle",c),e.on("movestart",P),c()})}function Ye(e,o,d=512){const f=o.id,l=`${o.id}-layer`;return e.getSource(f)||e.addSource(f,{type:"raster",tiles:[He(o,d)],tileSize:d,maxzoom:18}),e.getLayer(l)||e.addLayer({id:l,type:"raster",source:f,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),l}const g=ft.orthophotos.reduce((e,o)=>{const d=o.year.split(" ")[0],f=e.find(l=>l.year===d);return f?f.layers.push(o):e.push({id:d,year:d,displayYear:d,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,d)=>{const f=l=>/Printemps/i.test(l)?0:/Été|Ete/i.test(l)?1:2;return f(o.year)-f(d.year)})}));let A=L(g[0].id),E=L(g[g.length-1].id);function Oe(e){e.currentTarget.setPointerCapture(e.pointerId),V=e.pointerId,K=!0}function Ze(e){if(!K||V!==e.pointerId||!a(Z))return;const o=a(Z).getBoundingClientRect(),d=e.clientX-o.left;We(Math.max(0,Math.min(100,d/o.width*100)))}function Te(e){if(V===e.pointerId){const o=e.currentTarget;try{o.releasePointerCapture(e.pointerId)}catch{}K=!1,V=null}}const ce=new WeakMap;async function F(e,o){const d=ce.get(e);d&&(console.log("Waiting for previous layer change to complete..."),await d);const f=(async()=>{const l=Ge(e),z=[...l],x=o.layers.map(c=>Ye(e,c,512));requestAnimationFrame(()=>{x.forEach(c=>{e.getLayer(c)&&e.moveLayer(c)})}),await De(e,x,1500),requestAnimationFrame(()=>{x.forEach(c=>{e.getLayer(c)&&e.setPaintProperty(c,"raster-opacity",1)}),z.forEach(c=>{e.getLayer(c)&&e.setPaintProperty(c,"raster-opacity",0)})}),setTimeout(()=>{z.forEach(c=>{if(!x.includes(c)){const P=c.replace(/-layer$/,"");e.getLayer(c)&&e.removeLayer(c),e.getSource(P)&&e.removeSource(P),l.delete(c)}}),x.forEach(c=>l.add(c))},400)})();ce.set(e,f),await f,ce.delete(e)}let H=null;function Ue(e){if(!i)return;const o=g.find(d=>d.id===e);o&&(F(i,o),m(A,e),H&&H(!0))}function je(e){if(!h)return;const o=g.find(d=>d.id===e);o&&(F(h,o),m(E,e),H&&H(!0))}it(()=>{let e=!1;const o=new Map,d=[[2.75,49.45],[6.5,50.85]],f=[[2,49],[7.2,51.3]];let l=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)){if(l={center:[s,n],zoom:u},t.length>=5){const v=t[3],y=t[4];g.find(w=>w.id===v)&&m(A,v),g.find(w=>w.id===y)&&m(E,y)}return!0}}return!1})();const x=g.find(r=>r.id===a(A)),c=g.find(r=>r.id===a(E)),P={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},M={container:a(G),style:P,minZoom:7,maxZoom:17,maxBounds:f,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};l?(M.center=l.center,M.zoom=l.zoom):(M.bounds=d,M.fitBoundsOptions={padding:-50}),i=new Y.Map(M);const $={container:a(O),style:JSON.parse(JSON.stringify(P)),minZoom:7,maxZoom:17,maxBounds:f,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};l?($.center=l.center,$.zoom=l.zoom):($.bounds=d,$.fitBoundsOptions={padding:-50}),h=new Y.Map($);const fe=new Map,te=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=fe.get(t.sourceId)||0;n<2&&(fe.set(t.sourceId,n+1),setTimeout(()=>{const s=r.getSource(t.sourceId);s&&"reload"in s&&s.reload()},1e3*(n+1)))}};i.on("error",te(i)),h.on("error",te(h)),i.once("load",()=>F(i,x)),h.once("load",()=>F(h,c));const qe=new Y.NavigationControl().onAdd(i);a(j)&&a(j).appendChild(qe);const Ve=new Y.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}).onAdd(i);a(J)&&a(J).appendChild(Ve);const Xe={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const u=encodeURIComponent(t);if(!u)return{type:"FeatureCollection",features:n};const v=`https://nominatim.openstreetmap.org/search?q=${u}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,w=await(await fetch(v,{headers:{"Accept-Language":"fr"}})).json(),D=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const b of w.features??[]){const we=b.properties?.address?.state,ot=b.properties?.address?.county;if(!(we==="Wallonie"||we==="Région wallonne"||D.some(T=>ot?.includes(T)||we?.includes(T))))continue;const be=b.bbox,I=Array.isArray(be)&&be.length===4?be.map(Number):void 0;let B;if(I)B=[I[0]+(I[2]-I[0])/2,I[1]+(I[3]-I[1])/2];else if(b.geometry?.type==="Point"&&Array.isArray(b.geometry.coordinates))B=[Number(b.geometry.coordinates[0]),Number(b.geometry.coordinates[1])];else{const T=[],Fe=p=>{p&&(p.type==="Point"?T.push([+p.coordinates[0],+p.coordinates[1]]):p.type==="LineString"||p.type==="MultiPoint"?p.coordinates.forEach(C=>T.push([+C[0],+C[1]])):p.type==="Polygon"||p.type==="MultiLineString"?p.coordinates.flat(1).forEach(C=>T.push([+C[0],+C[1]])):p.type==="MultiPolygon"?p.coordinates.flat(2).forEach(C=>T.push([+C[0],+C[1]])):p.type==="GeometryCollection"&&(p.geometries||[]).forEach(Fe))};if(Fe(b.geometry),T.length){const p=T.map(Ce=>Ce[0]),C=T.map(Ce=>Ce[1]),k=[Math.min(...p),Math.min(...C),Math.max(...p),Math.max(...C)];B=[k[0]+(k[2]-k[0])/2,k[1]+(k[3]-k[1])/2]}else B=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:B},place_name:b.properties?.display_name,properties:{...b.properties,bbox:I},text:b.properties?.display_name,place_type:["place"],center:B,bbox:I})}}catch(u){console.error("forwardGeocode error:",u)}const s={type:"FeatureCollection",features:n};if(o.size>=50){const u=o.keys().next().value;u!==void 0&&o.delete(u)}return o.set(t,s),s}},N=new ut(Xe,{maplibregl:Y,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1}),Qe=N.onAdd(i);a(U)&&a(U).appendChild(Qe);const me=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?i.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):i.flyTo({center:r.center,zoom:15,duration:1200})};let q=[],S=0;N.on("results",r=>{q=r.features||[],S=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"),t.forEach((n,s)=>{const u=v=>{if(v.preventDefault(),v.stopPropagation(),q[s]){const y=document.querySelector(".maplibregl-ctrl-geocoder input");y&&y.blur(),me(q[s]),setTimeout(()=>{y&&(y.value=""),N.clear(),q=[]},100)}};n.removeEventListener("touchend",u),n.removeEventListener("click",u),n.addEventListener("touchend",u,{passive:!1}),n.addEventListener("click",u)}))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&q.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const s=q[S];s&&(me(s),t.target.value="",N.clear(),q=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),S=Math.min(S+1,q.length-1),n.forEach(s=>s.classList.remove("active")),n[S]&&n[S].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),S=Math.max(S-1,0),n.forEach(s=>s.classList.remove("active")),n[S]&&n[S].classList.add("active"))},!0)},100),N.on("result",r=>{const t=r.result;me(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),N.clear()},100)});const et=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let he=null,_e="";const ge=(r=!1)=>{if(typeof window>"u"||!i)return;const t=i.getCenter(),n=i.getZoom(),s=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${a(A)},${a(E)}`;s!==_e&&(_e=s,r?window.location.hash=s:history.replaceState(null,"",`#${s}`))};H=ge;let Me=0;i.on("move",()=>{!K&&!e&&et(i,h);const r=i.getCenter();m(le,{lng:r.lng,lat:r.lat}),m(Le,i.getZoom());const t=performance.now();t-Me>120&&(ge(!1),Me=t),he&&clearTimeout(he),he=window.setTimeout(()=>{ge(!0)},800)});let ye=null;const ve=()=>{ye||(ye=window.setTimeout(()=>{i&&i.resize(),h&&h.resize(),ye=null},250))};setTimeout(ve,100),window.addEventListener("resize",ve);const $e=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)&&(i&&i.flyTo({center:[s,n],zoom:u,duration:1e3}),t.length>=5)){const v=t[3],y=t[4];if(v&&v!==a(A)){const w=g.find(D=>D.id===v);w&&(m(A,v),F(i,w))}if(y&&y!==a(E)){const w=g.find(D=>D.id===y);w&&(m(E,y),F(h,w))}}}};window.addEventListener("hashchange",$e);const tt=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",ve),window.removeEventListener("hashchange",$e),clearInterval(tt),i.remove(),h.remove()}}),ct();var de=pt(),X=re(de),Ie=re(X);R(Ie,e=>m(G,e),()=>a(G));var ue=_(Ie,2);R(ue,e=>m(O,e),()=>a(O));var Ae=_(ue,2);R(Ae,e=>m(U,e),()=>a(U));var Ee=_(Ae,2);R(Ee,e=>m(j,e),()=>a(j));var ze=_(Ee,2);R(ze,e=>m(J,e),()=>a(J));var Q=_(ze,2),ee=re(Q);ne(Q);var Je=_(Q,2);dt(Je,{get lat(){return a(le).lat},get lng(){return a(le).lng},get zoom(){return a(Le)},get yearBefore(){return a(A)},get yearAfter(){return a(E)},shareText:""}),ne(X),R(X,e=>m(Z,e),()=>a(Z));var Pe=_(X,2);Be(Pe,{side:"left",get groups(){return g},get selectedId(){return a(A)},$$events:{select:e=>Ue(e.detail.id)}});var Ke=_(Pe,2);Be(Ke,{side:"right",get groups(){return g},get selectedId(){return a(E)},$$events:{select:e=>je(e.detail.id)}}),ne(de),nt(()=>{Ne(ue,`clip-path: inset(0 0 0 calc(${a(se)??""}% - 0.5px))`),Ne(Q,`left: ${a(se)??""}%`)}),oe("pointerdown",ee,Oe),oe("pointermove",ee,Ze),oe("pointerup",ee,Te),oe("pointercancel",ee,Te),Re(ae,de),at()}var ht=ke('<div class="page-container svelte-q4ucql"><!></div>');function Et(ae){var W=ht();lt(O=>{st.title="Timelapse - Comparaison d'orthophotos"});var G=re(W);mt(G,{}),ne(W),Re(ae,W)}export{Et as component};
