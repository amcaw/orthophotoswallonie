import"../chunks/DsnmJJEf.js";import"../chunks/T5vn-GjU.js";import{I as et,K as S,A as Ne,B as tt,C as ke,J as ot,F as oe,D as $,w as a,M as v,G as re,ap as rt}from"../chunks/HUyCGl9y.js";import{o as nt,e as te,h as st}from"../chunks/Ba58zEHK.js";import{s as $e}from"../chunks/_YLpWADv.js";import{b as B}from"../chunks/BIZiTCpg.js";import{i as at}from"../chunks/7nCQ08Wj.js";import{m as Y,M as it}from"../chunks/DvzMNcMn.js";import{o as lt}from"../chunks/CUZUMNKG.js";import{Y as Fe}from"../chunks/BkavPja8.js";var ct=Ne('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="geocoder-overlay svelte-qt8w5r"></div> <div class="navigation-overlay svelte-qt8w5r"></div> <div class="attribution-overlay svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div></div> <!> <!></div>');function dt(ne,W){et(W,!1);let G=S(),O=S(),Z=S(),U=S(),j=S(),J=S(),c,m,se=S(50),K=!1,V=null,ae=null;function Re(e){v(se,e),ae&&cancelAnimationFrame(ae),ae=requestAnimationFrame(()=>{m&&m.triggerRepaint()})}const Ce=new WeakMap;function Be(e){let o=Ce.get(e);return o||(o=new Set,Ce.set(e,o)),o}function We(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let Le=new Set;function Ge(e,o,d=3e3){return new Promise(p=>{let i=!1;const A=()=>{i||(i=!0,M(),Le.delete(L),p())},L=()=>{i||(console.log("Tile wait cancelled - user is interacting"),A())};Le.add(L);const l=()=>{o.every(ee=>{const pe=ee.replace(/-layer$/,"");return!!e.getSource(pe)&&e.isSourceLoaded(pe)})&&e.areTilesLoaded()&&A()},E=()=>{console.log("Map movement detected - finishing tile wait early"),A()},_=setTimeout(A,d),M=()=>{e.off("idle",l),e.off("movestart",E),clearTimeout(_)};e.on("idle",l),e.on("movestart",E),l()})}function He(e,o,d=512){const p=o.id,i=`${o.id}-layer`;return e.getSource(p)||e.addSource(p,{type:"raster",tiles:[We(o,d)],tileSize:d,maxzoom:18}),e.getLayer(i)||e.addLayer({id:i,type:"raster",source:p,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),i}const h=lt.orthophotos.reduce((e,o)=>{const d=o.year.split(" ")[0],p=e.find(i=>i.year===d);return p?p.layers.push(o):e.push({id:d,year:d,displayYear:d,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,d)=>{const p=i=>/Printemps/i.test(i)?0:/Été|Ete/i.test(i)?1:2;return p(o.year)-p(d.year)})}));let q=S(h[0].id),z=S(h[h.length-1].id);function De(e){e.currentTarget.setPointerCapture(e.pointerId),V=e.pointerId,K=!0}function Ye(e){if(!K||V!==e.pointerId||!a(Z))return;const o=a(Z).getBoundingClientRect(),d=e.clientX-o.left;Re(Math.max(0,Math.min(100,d/o.width*100)))}function xe(e){if(V===e.pointerId){const o=e.currentTarget;try{o.releasePointerCapture(e.pointerId)}catch{}K=!1,V=null}}const ie=new WeakMap;async function F(e,o){const d=ie.get(e);d&&(console.log("Waiting for previous layer change to complete..."),await d);const p=(async()=>{const i=Be(e),A=[...i],L=o.layers.map(l=>He(e,l,512));requestAnimationFrame(()=>{L.forEach(l=>{e.getLayer(l)&&e.moveLayer(l)})}),await Ge(e,L,1500),requestAnimationFrame(()=>{L.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",1)}),A.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",0)})}),setTimeout(()=>{A.forEach(l=>{if(!L.includes(l)){const E=l.replace(/-layer$/,"");e.getLayer(l)&&e.removeLayer(l),e.getSource(E)&&e.removeSource(E),i.delete(l)}}),L.forEach(l=>i.add(l))},400)})();ie.set(e,p),await p,ie.delete(e)}let H=null;function Oe(e){if(!c)return;const o=h.find(d=>d.id===e);o&&(F(c,o),v(q,e),H&&H(!0))}function Ze(e){if(!m)return;const o=h.find(d=>d.id===e);o&&(F(m,o),v(z,e),H&&H(!0))}nt(()=>{let e=!1;const o=new Map,d=[[2.75,49.45],[6.5,50.85]],p=[[2,49],[7.2,51.3]];let i=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)){if(i={center:[s,n],zoom:u},t.length>=5){const g=t[3],y=t[4];h.find(w=>w.id===g)&&v(q,g),h.find(w=>w.id===y)&&v(z,y)}return!0}}return!1})();const L=h.find(r=>r.id===a(q)),l=h.find(r=>r.id===a(z)),E={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},_={container:a(G),style:E,minZoom:7,maxZoom:17,maxBounds:p,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(_.center=i.center,_.zoom=i.zoom):(_.bounds=d,_.fitBoundsOptions={padding:-50}),c=new Y.Map(_);const M={container:a(O),style:JSON.parse(JSON.stringify(E)),minZoom:7,maxZoom:17,maxBounds:p,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(M.center=i.center,M.zoom=i.zoom):(M.bounds=d,M.fitBoundsOptions={padding:-50}),m=new Y.Map(M);const ue=new Map,ee=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ue.get(t.sourceId)||0;n<2&&(ue.set(t.sourceId,n+1),setTimeout(()=>{const s=r.getSource(t.sourceId);s&&"reload"in s&&s.reload()},1e3*(n+1)))}};c.on("error",ee(c)),m.on("error",ee(m)),c.once("load",()=>F(c,L)),m.once("load",()=>F(m,l));const Pe=new Y.NavigationControl().onAdd(c);a(j)&&a(j).appendChild(Pe);const je=new Y.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}).onAdd(c);a(J)&&a(J).appendChild(je);const Je={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const u=encodeURIComponent(t);if(!u)return{type:"FeatureCollection",features:n};const g=`https://nominatim.openstreetmap.org/search?q=${u}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,w=await(await fetch(g,{headers:{"Accept-Language":"fr"}})).json(),D=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const b of w.features??[]){const ge=b.properties?.address?.state,Qe=b.properties?.address?.county;if(!(ge==="Wallonie"||ge==="Région wallonne"||D.some(T=>Qe?.includes(T)||ge?.includes(T))))continue;const we=b.bbox,I=Array.isArray(we)&&we.length===4?we.map(Number):void 0;let k;if(I)k=[I[0]+(I[2]-I[0])/2,I[1]+(I[3]-I[1])/2];else if(b.geometry?.type==="Point"&&Array.isArray(b.geometry.coordinates))k=[Number(b.geometry.coordinates[0]),Number(b.geometry.coordinates[1])];else{const T=[],Me=f=>{f&&(f.type==="Point"?T.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(C=>T.push([+C[0],+C[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(C=>T.push([+C[0],+C[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(C=>T.push([+C[0],+C[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(Me))};if(Me(b.geometry),T.length){const f=T.map(be=>be[0]),C=T.map(be=>be[1]),R=[Math.min(...f),Math.min(...C),Math.max(...f),Math.max(...C)];k=[R[0]+(R[2]-R[0])/2,R[1]+(R[3]-R[1])/2]}else k=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:k},place_name:b.properties?.display_name,properties:{...b.properties,bbox:I},text:b.properties?.display_name,place_type:["place"],center:k,bbox:I})}}catch(u){console.error("forwardGeocode error:",u)}const s={type:"FeatureCollection",features:n};if(o.size>=50){const u=o.keys().next().value;u!==void 0&&o.delete(u)}return o.set(t,s),s}},N=new it(Je,{maplibregl:Y,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1}),Ke=N.onAdd(c);a(U)&&a(U).appendChild(Ke);const fe=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?c.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):c.flyTo({center:r.center,zoom:15,duration:1200})};let P=[],x=0;N.on("results",r=>{P=r.features||[],x=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"),t.forEach((n,s)=>{const u=g=>{if(g.preventDefault(),g.stopPropagation(),P[s]){const y=document.querySelector(".maplibregl-ctrl-geocoder input");y&&y.blur(),fe(P[s]),setTimeout(()=>{y&&(y.value=""),N.clear(),P=[]},100)}};n.removeEventListener("touchend",u),n.removeEventListener("click",u),n.addEventListener("touchend",u,{passive:!1}),n.addEventListener("click",u)}))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&P.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const s=P[x];s&&(fe(s),t.target.value="",N.clear(),P=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),x=Math.min(x+1,P.length-1),n.forEach(s=>s.classList.remove("active")),n[x]&&n[x].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),x=Math.max(x-1,0),n.forEach(s=>s.classList.remove("active")),n[x]&&n[x].classList.add("active"))},!0)},100),N.on("result",r=>{const t=r.result;fe(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),N.clear()},100)});const Ve=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let me=null,qe="";const he=(r=!1)=>{if(typeof window>"u"||!c)return;const t=c.getCenter(),n=c.getZoom(),s=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${a(q)},${a(z)}`;s!==qe&&(qe=s,r?window.location.hash=s:history.replaceState(null,"",`#${s}`))};H=he;let ze=0;c.on("move",()=>{!K&&!e&&Ve(c,m);const r=performance.now();r-ze>120&&(he(!1),ze=r),me&&clearTimeout(me),me=window.setTimeout(()=>{he(!0)},800)});let ye=null;const ve=()=>{ye||(ye=window.setTimeout(()=>{c&&c.resize(),m&&m.resize(),ye=null},250))};setTimeout(ve,100),window.addEventListener("resize",ve);const _e=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)&&(c&&c.flyTo({center:[s,n],zoom:u,duration:1e3}),t.length>=5)){const g=t[3],y=t[4];if(g&&g!==a(q)){const w=h.find(D=>D.id===g);w&&(v(q,g),F(c,w))}if(y&&y!==a(z)){const w=h.find(D=>D.id===y);w&&(v(z,y),F(m,w))}}}};window.addEventListener("hashchange",_e);const Xe=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",ve),window.removeEventListener("hashchange",_e),clearInterval(Xe),c.remove(),m.remove()}}),at();var le=ct(),X=oe(le),Te=oe(X);B(Te,e=>v(G,e),()=>a(G));var ce=$(Te,2);B(ce,e=>v(O,e),()=>a(O));var Ie=$(ce,2);B(Ie,e=>v(U,e),()=>a(U));var Se=$(Ie,2);B(Se,e=>v(j,e),()=>a(j));var Ae=$(Se,2);B(Ae,e=>v(J,e),()=>a(J));var de=$(Ae,2),Q=oe(de);re(de),re(X),B(X,e=>v(Z,e),()=>a(Z));var Ee=$(X,2);Fe(Ee,{side:"left",get groups(){return h},get selectedId(){return a(q)},$$events:{select:e=>Oe(e.detail.id)}});var Ue=$(Ee,2);Fe(Ue,{side:"right",get groups(){return h},get selectedId(){return a(z)},$$events:{select:e=>Ze(e.detail.id)}}),re(le),tt(()=>{$e(ce,`clip-path: inset(0 0 0 calc(${a(se)??""}% - 0.5px))`),$e(de,`left: ${a(se)??""}%`)}),te("pointerdown",Q,De),te("pointermove",Q,Ye),te("pointerup",Q,xe),te("pointercancel",Q,xe),ke(ne,le),ot()}var ut=Ne('<div class="page-container svelte-q4ucql"><!></div>');function Tt(ne){var W=ut();st(O=>{rt.title="Timelapse - Comparaison d'orthophotos"});var G=oe(W);dt(G,{}),re(W),ke(ne,W)}export{Tt as component};
