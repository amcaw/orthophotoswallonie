import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Ue,K as $,A as ze,B as je,C as Ae,J as Je,am as O,F as V,D as Z,w as c,M as y,G as X,ao as Ke}from"../chunks/Ehb9Q6W5.js";import{o as Ve,e as I,h as Xe}from"../chunks/BKIJojkU.js";import{s as Me}from"../chunks/yJVuIktW.js";import{b as me}from"../chunks/m2zDNTuv.js";import{i as Qe}from"../chunks/D631TkqT.js";import{S as et,m as H,M as tt}from"../chunks/VYvS0YDk.js";import{o as ot}from"../chunks/CUZUMNKG.js";import{Y as Se}from"../chunks/Br037vyA.js";var rt=ze('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function nt(Q,P){Ue(P,!1);let R=$(),U=$(),E=$(),a,p,ee=$(50),T=!1,te=null;function he(e){y(ee,e),te&&cancelAnimationFrame(te),te=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let oe=$({lng:4.5,lat:50.5}),ye=$(8);const ge=new WeakMap;function $e(e){let o=ge.get(e);return o||(o=new Set,ge.set(e,o)),o}function _e(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}function Ie(e,o,s=3e3){return new Promise(u=>{let i=!1;const d=()=>{i||(i=!0,K(),u())},z=()=>{o.every(_=>{const G=_.replace(/-layer$/,"");return!!e.getSource(G)&&e.isSourceLoaded(G)})&&e.areTilesLoaded()&&d()},se=setTimeout(d,s),K=()=>{e.off("idle",z),clearTimeout(se)};e.on("idle",z),z()})}function Ee(e,o,s=512){const u=o.id,i=`${o.id}-layer`;return e.getSource(u)||e.addSource(u,{type:"raster",tiles:[_e(o,s)],tileSize:s,maxzoom:18}),e.getLayer(i)||e.addLayer({id:i,type:"raster",source:u,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),i}const m=ot.orthophotos.reduce((e,o)=>{const s=o.year.split(" ")[0],u=e.find(i=>i.year===s);return u?u.layers.push(o):e.push({id:s,year:s,displayYear:s,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,s)=>{const u=i=>/Printemps/i.test(i)?0:/Été|Ete/i.test(i)?1:2;return u(o.year)-u(s.year)})}));let M=$(m[0].id),S=$(m[m.length-1].id);function qe(e){e.preventDefault(),e.stopPropagation(),T=!0}function Be(e){if(!T||!c(E))return;e.preventDefault();const o=c(E).getBoundingClientRect(),s=e.clientX-o.left;he(Math.max(0,Math.min(100,s/o.width*100)))}function Fe(){T=!1}function Ne(e){T=!0}function Pe(e){if(!T||!c(E))return;const o=c(E).getBoundingClientRect(),s=e.touches[0].clientX-o.left;he(Math.max(0,Math.min(100,s/o.width*100)))}function Re(){T=!1}function ke(){T=!1}async function q(e,o){const s=$e(e),u=[...s],i=o.layers.map(d=>Ee(e,d,512));i.forEach(d=>e.moveLayer(d)),await Ie(e,i,3e3),i.forEach(d=>{e.getLayer(d)&&e.setPaintProperty(d,"raster-opacity",1)}),u.forEach(d=>{e.getLayer(d)&&e.setPaintProperty(d,"raster-opacity",0)}),setTimeout(()=>{u.forEach(d=>{if(!i.includes(d)){const z=d.replace(/-layer$/,"");e.getLayer(d)&&e.removeLayer(d),e.getSource(z)&&e.removeSource(z),s.delete(d)}}),i.forEach(d=>s.add(d))},400)}let k=null;function Ge(e){if(!a)return;const o=m.find(s=>s.id===e);o&&(q(a,o),y(M,e),k&&k(!0))}function De(e){if(!p)return;const o=m.find(s=>s.id===e);o&&(q(p,o),y(S,e),k&&k(!0))}Ve(()=>{let e=!1;const o=new Map,s=[[2.75,49.45],[6.5,50.85]],u=[[2,49],[7.2,51.3]];let i=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)){if(i={center:[l,n],zoom:h},t.length>=5){const C=t[3],A=t[4];m.find(g=>g.id===C)&&y(M,C),m.find(g=>g.id===A)&&y(S,A)}return!0}}return!1})();const z=m.find(r=>r.id===c(M)),se=m.find(r=>r.id===c(S)),K={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},B={container:c(R),style:K,minZoom:7,maxZoom:17,maxBounds:u,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(B.center=i.center,B.zoom=i.zoom):(B.bounds=s,B.fitBoundsOptions={padding:-50}),a=new H.Map(B);const _={container:c(U),style:JSON.parse(JSON.stringify(K)),minZoom:7,maxZoom:17,maxBounds:u,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(_.center=i.center,_.zoom=i.zoom):(_.bounds=s,_.fitBoundsOptions={padding:-50}),p=new H.Map(_);const G=new Map,ae=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=G.get(t.sourceId)||0;n<2&&(G.set(t.sourceId,n+1),setTimeout(()=>{const l=r.getSource(t.sourceId);l&&"reload"in l&&l.reload()},1e3*(n+1)))}};a.on("error",ae(a)),p.on("error",ae(p)),a.once("load",()=>q(a,z)),p.once("load",()=>q(p,se)),a.addControl(new H.NavigationControl,"bottom-left"),a.addControl(new H.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const Oe={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:n};const C=`https://nominatim.openstreetmap.org/search?q=${h}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,g=await(await fetch(C,{headers:{"Accept-Language":"fr"}})).json(),Y=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of g.features??[]){const ue=v.properties?.address?.state,He=v.properties?.address?.county;if(!(ue==="Wallonie"||ue==="Région wallonne"||Y.some(x=>He?.includes(x)||ue?.includes(x))))continue;const fe=v.bbox,L=Array.isArray(fe)&&fe.length===4?fe.map(Number):void 0;let F;if(L)F=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))F=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const x=[],Te=f=>{f&&(f.type==="Point"?x.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>x.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>x.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>x.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(Te))};if(Te(v.geometry),x.length){const f=x.map(pe=>pe[0]),w=x.map(pe=>pe[1]),N=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];F=[N[0]+(N[2]-N[0])/2,N[1]+(N[3]-N[1])/2]}else F=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:F},place_name:v.properties?.display_name,properties:{...v.properties,bbox:L},text:v.properties?.display_name,place_type:["place"],center:F,bbox:L})}}catch(h){console.error("forwardGeocode error:",h)}const l={type:"FeatureCollection",features:n};if(o.size>=50){const h=o.keys().next().value;h!==void 0&&o.delete(h)}return o.set(t,l),l}},D=new tt(Oe,{maplibregl:H,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl(D,"top-left");const xe=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:r.center,zoom:15,duration:1200})};let W=[],b=0;D.on("results",r=>{W=r.features||[],b=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&W.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=W[b];l&&(xe(l),t.target.value="",D.clear(),W=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),b=Math.min(b+1,W.length-1),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),b=Math.max(b-1,0),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active"))},!0)},100),D.on("result",r=>{const t=r.result;xe(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),D.clear()},100)});const Ze=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let ie=null,Ce="";const le=(r=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),n=a.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${c(M)},${c(S)}`;l!==Ce&&(Ce=l,r?window.location.hash=l:history.replaceState(null,"",`#${l}`))};k=le,a.on("move",()=>{!T&&!e&&Ze(a,p);const r=a.getCenter();y(oe,{lng:r.lng,lat:r.lat}),y(ye,a.getZoom()),le(!1),ie&&clearTimeout(ie),ie=window.setTimeout(()=>{le(!0)},1e3)});let ce=null;const de=()=>{ce||(ce=window.setTimeout(()=>{a&&a.resize(),p&&p.resize(),ce=null},250))};setTimeout(de,100),window.addEventListener("resize",de);const Le=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)&&(a&&a.flyTo({center:[l,n],zoom:h,duration:1e3}),t.length>=5)){const C=t[3],A=t[4];if(C&&C!==c(M)){const g=m.find(Y=>Y.id===C);g&&(y(M,C),q(a,g))}if(A&&A!==c(S)){const g=m.find(Y=>Y.id===A);g&&(y(S,A),q(p,g))}}}};return window.addEventListener("hashchange",Le),()=>{window.removeEventListener("resize",de),window.removeEventListener("hashchange",Le),a.remove(),p.remove()}}),Qe();var re=rt();I("mousemove",O,Be),I("mouseup",O,Fe),I("touchmove",O,Pe),I("touchend",O,Re),I("touchcancel",O,ke);var j=V(re),ve=V(j);me(ve,e=>y(R,e),()=>c(R));var ne=Z(ve,2);me(ne,e=>y(U,e),()=>c(U));var J=Z(ne,2),we=V(J);X(J);var We=Z(J,2);et(We,{get lat(){return c(oe).lat},get lng(){return c(oe).lng},get zoom(){return c(ye)},get yearBefore(){return c(M)},get yearAfter(){return c(S)},shareText:""}),X(j),me(j,e=>y(E,e),()=>c(E));var be=Z(j,2);Se(be,{side:"left",get groups(){return m},get selectedId(){return c(M)},$$events:{select:e=>Ge(e.detail.id)}});var Ye=Z(be,2);Se(Ye,{side:"right",get groups(){return m},get selectedId(){return c(S)},$$events:{select:e=>De(e.detail.id)}}),X(re),je(()=>{Me(ne,`clip-path: inset(0 0 0 calc(${c(ee)??""}% - 0.5px))`),Me(J,`left: ${c(ee)??""}%`)}),I("mousedown",we,qe),I("touchstart",we,Ne),Ae(Q,re),Je()}var st=ze('<div class="page-container svelte-q4ucql"><!></div>');function gt(Q){var P=st();Xe(U=>{Ke.title="Timelapse - Comparaison d'orthophotos"});var R=V(P);nt(R,{}),X(P),Ae(Q,P)}export{gt as component};
