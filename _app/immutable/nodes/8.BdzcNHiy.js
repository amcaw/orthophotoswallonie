import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Te,K as z,A as me,B as _e,C as ye,J as qe,am as O,F as U,D as I,w as n,M as g,G as H,ao as Be}from"../chunks/Ehb9Q6W5.js";import{o as Ee,e as _,h as Fe}from"../chunks/BKIJojkU.js";import{s as fe}from"../chunks/yJVuIktW.js";import{b as ae}from"../chunks/m2zDNTuv.js";import{i as Me}from"../chunks/D631TkqT.js";import{S as Ie,m as k,M as ke}from"../chunks/VYvS0YDk.js";import{o as De}from"../chunks/CUZUMNKG.js";import{Y as pe}from"../chunks/Br037vyA.js";var Re=me('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function Ne(K,q){Te(q,!1);let B=z(),D=z(),P=z(),a,x,R=z(50),S=!1,X=z({lng:4.5,lat:50.5}),J=z(8);const m=De.orthophotos.reduce((e,r)=>{const s=r.year.split(" ")[0],u=e.find(f=>f.year===s);return u?u.layers.push(r):e.push({id:s,year:s,displayYear:s,layers:[r]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((r,s)=>{const u=f=>/Printemps/i.test(f)?0:/Été|Ete/i.test(f)?1:2;return u(r.year)-u(s.year)})}));let C=z(m[0].id),L=z(m[m.length-1].id);function he(e){e.preventDefault(),e.stopPropagation(),S=!0}function ge(e){if(!S||!n(P))return;e.preventDefault();const r=n(P).getBoundingClientRect(),s=e.clientX-r.left;g(R,Math.max(0,Math.min(100,s/r.width*100)))}function ve(){S=!1}function we(e){e.preventDefault(),e.stopPropagation(),S=!0}function be(e){if(!S||!n(P))return;e.preventDefault();const r=n(P).getBoundingClientRect(),s=e.touches[0].clientX-r.left;g(R,Math.max(0,Math.min(100,s/r.width*100)))}function xe(){S=!1}function N(e,r){const s=e.getStyle();if(s?.layers)for(const i of s.layers){if(!i.id.endsWith("-layer"))continue;e.getLayer(i.id)&&e.removeLayer(i.id);const c=i.source;c&&e.getSource(c)&&e.removeSource(c)}r.layers.forEach(i=>{const c=i.id,E=`${i.id}-layer`;e.getSource(c)||e.addSource(c,{type:"raster",tiles:[`${i.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(E)||e.addLayer({id:E,type:"raster",source:c,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(i=>{const c=`${i.id}-layer`;e.getLayer(c)&&e.moveLayer(c)});const u=r.layers.map(i=>`${i.id}-layer`);let f=0;const W=u.length,ee=()=>{f++,f>=W&&u.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",1)})},Y=i=>{i.isSourceLoaded&&i.sourceId&&r.layers.some(c=>c.id===i.sourceId)&&ee()};e.on("sourcedata",Y),setTimeout(()=>{e.off("sourcedata",Y),u.forEach(i=>{e.getLayer(i)&&e.getPaintProperty(i,"raster-opacity")===0&&e.setPaintProperty(i,"raster-opacity",1)})},2e3)}function $e(e){if(!a)return;const r=m.find(s=>s.id===e);if(r&&(N(a,r),g(C,e),typeof window<"u"&&a)){const s=a.getCenter(),u=a.getZoom();window.location.hash=`${s.lat.toFixed(6)},${s.lng.toFixed(6)},${u.toFixed(2)}z,${n(C)},${n(L)}`}}function Ce(e){if(!x)return;const r=m.find(s=>s.id===e);if(r&&(N(x,r),g(L,e),typeof window<"u"&&a)){const s=a.getCenter(),u=a.getZoom();window.location.hash=`${s.lat.toFixed(6)},${s.lng.toFixed(6)},${u.toFixed(2)}z,${n(C)},${n(L)}`}}Ee(async()=>{let e=!1;const r=new Map,s=[[2.75,49.45],[6.5,50.85]],u=[[2,49],[7.2,51.3]];let f=null;const W=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const l=parseFloat(t[0]),p=parseFloat(t[1]),w=parseFloat(t[2].replace("z",""));if(!isNaN(l)&&!isNaN(p)&&!isNaN(w)){if(f={center:[p,l],zoom:w},t.length>=5){const j=t[3],re=t[4];m.find(M=>M.id===j)&&g(C,j),m.find(M=>M.id===re)&&g(L,re)}return!0}}return!1};W()||(await new Promise(o=>setTimeout(o,10)),W());const ee=m.find(o=>o.id===n(C)),Y=m.find(o=>o.id===n(L));a=new k.Map({container:n(B),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:s,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:u,attributionControl:!1}),x=new k.Map({container:n(D),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:s,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:u,interactive:!1,attributionControl:!1}),a.once("load",()=>N(a,ee)),x.once("load",()=>N(x,Y)),a.addControl(new k.NavigationControl,"bottom-left"),a.addControl(new k.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const i={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(r.has(t))return r.get(t);const l=[];try{const w=encodeURIComponent(t);if(!w)return{type:"FeatureCollection",features:l};const j=`https://nominatim.openstreetmap.org/search?q=${w}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,M=await(await fetch(j,{headers:{"Accept-Language":"fr"}})).json(),Pe=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const y of M.features??[]){const ne=y.properties?.address?.state,Ae=y.properties?.address?.county;if(!(ne==="Wallonie"||ne==="Région wallonne"||Pe.some(b=>Ae?.includes(b)||ne?.includes(b))))continue;const se=y.bbox,$=Array.isArray(se)&&se.length===4?se.map(Number):void 0;let A;if($)A=[$[0]+($[2]-$[0])/2,$[1]+($[3]-$[1])/2];else if(y.geometry?.type==="Point"&&Array.isArray(y.geometry.coordinates))A=[Number(y.geometry.coordinates[0]),Number(y.geometry.coordinates[1])];else{const b=[],ue=d=>{d&&(d.type==="Point"?b.push([+d.coordinates[0],+d.coordinates[1]]):d.type==="LineString"||d.type==="MultiPoint"?d.coordinates.forEach(h=>b.push([+h[0],+h[1]])):d.type==="Polygon"||d.type==="MultiLineString"?d.coordinates.flat(1).forEach(h=>b.push([+h[0],+h[1]])):d.type==="MultiPolygon"?d.coordinates.flat(2).forEach(h=>b.push([+h[0],+h[1]])):d.type==="GeometryCollection"&&(d.geometries||[]).forEach(ue))};if(ue(y.geometry),b.length){const d=b.map(ie=>ie[0]),h=b.map(ie=>ie[1]),T=[Math.min(...d),Math.min(...h),Math.max(...d),Math.max(...h)];A=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2]}else A=[4.4699,50.5039]}l.push({type:"Feature",geometry:{type:"Point",coordinates:A},place_name:y.properties?.display_name,properties:{...y.properties,bbox:$},text:y.properties?.display_name,place_type:["place"],center:A,bbox:$})}}catch(w){console.error("forwardGeocode error:",w)}const p={type:"FeatureCollection",features:l};if(r.size>=50){const w=r.keys().next().value;w!==void 0&&r.delete(w)}return r.set(t,p),p}},c=new ke(i,{maplibregl:k,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl(c,"top-left");const E=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:o.center,zoom:15,duration:1200})};let F=[],v=0;c.on("results",o=>{F=o.features||[],v=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(l=>l.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const l=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&F.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const p=F[v];p&&(E(p),t.target.value="",c.clear(),F=[])}else t.key==="ArrowDown"&&l.length>0?(t.preventDefault(),v=Math.min(v+1,F.length-1),l.forEach(p=>p.classList.remove("active")),l[v]&&l[v].classList.add("active")):t.key==="ArrowUp"&&l.length>0&&(t.preventDefault(),v=Math.max(v-1,0),l.forEach(p=>p.classList.remove("active")),l[v]&&l[v].classList.add("active"))},!0)},100),c.on("result",o=>{const t=o.result;E(t),setTimeout(()=>{const l=document.querySelector(".maplibregl-ctrl-geocoder input");l&&(l.value=""),c.clear()},100)});const Se=(o,t)=>{e||(e=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{e=!1}))};a.on("move",()=>{!S&&!e&&Se(a,x);const o=a.getCenter();g(X,{lng:o.lng,lat:o.lat}),g(J,a.getZoom()),typeof window<"u"&&(window.location.hash=`${o.lat.toFixed(6)},${o.lng.toFixed(6)},${n(J).toFixed(2)}z,${n(C)},${n(L)}`)});let te=null;const oe=()=>{te||(te=window.setTimeout(()=>{a&&a.resize(),x&&x.resize(),te=null},250))};return setTimeout(oe,100),window.addEventListener("resize",oe),()=>{window.removeEventListener("resize",oe),a.remove(),x.remove()}}),Me();var V=Re();_("mousemove",O,ge),_("mouseup",O,ve),_("touchmove",O,be),_("touchend",O,xe);var G=U(V),le=U(G);ae(le,e=>g(B,e),()=>n(B));var Q=I(le,2);ae(Q,e=>g(D,e),()=>n(D));var Z=I(Q,2),ce=U(Z);H(Z);var Le=I(Z,2);Ie(Le,{get lat(){return n(X).lat},get lng(){return n(X).lng},get zoom(){return n(J)},get yearBefore(){return n(C)},get yearAfter(){return n(L)},shareText:""}),H(G),ae(G,e=>g(P,e),()=>n(P));var de=I(G,2);pe(de,{side:"left",get groups(){return m},get selectedId(){return n(C)},$$events:{select:e=>$e(e.detail.id)}});var ze=I(de,2);pe(ze,{side:"right",get groups(){return m},get selectedId(){return n(L)},$$events:{select:e=>Ce(e.detail.id)}}),H(V),_e(()=>{fe(Q,`clip-path: inset(0 0 0 ${n(R)??""}%)`),fe(Z,`left: ${n(R)??""}%`)}),_("mousedown",ce,he),_("touchstart",ce,we),ye(K,V),qe()}var Ge=me('<div class="page-container svelte-q4ucql"><!></div>');function Qe(K){var q=Ge();Fe(D=>{Be.title="Timelapse - Comparaison d'orthophotos"});var B=U(q);Ne(B,{}),H(q),ye(K,q)}export{Qe as component};
