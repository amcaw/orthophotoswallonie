import"../chunks/DsnmJJEf.js";import"../chunks/CoDSuzm1.js";import{I as Ue,K as M,A as Me,B as je,C as $e,J as Je,F as ee,D as H,w as d,M as v,G as te,an as Ke}from"../chunks/BILf7VAl.js";import{o as Ve,e as Q,h as Xe}from"../chunks/XYDQtagk.js";import{s as Pe}from"../chunks/MQgf3nuD.js";import{b as ve}from"../chunks/B7CElIPH.js";import{i as Qe}from"../chunks/MHw7BI_m.js";import{S as et,m as D,M as tt}from"../chunks/CccdXG49.js";import{o as ot}from"../chunks/CUZUMNKG.js";import{Y as Ee}from"../chunks/gDwRjMFD.js";var rt=Me('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function nt(oe,k){Ue(k,!1);let R=M(),Y=M(),O=M(),a,m,re=M(50),Z=!1,U=null,ne=null;function qe(e){v(re,e),ne&&cancelAnimationFrame(ne),ne=requestAnimationFrame(()=>{m&&m.triggerRepaint()})}let se=M({lng:4.5,lat:50.5}),we=M(8);const be=new WeakMap;function _e(e){let o=be.get(e);return o||(o=new Set,be.set(e,o)),o}function Fe(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let Le=new Set;function Ne(e,o,c=3e3){return new Promise(f=>{let i=!1;const A=()=>{i||(i=!0,q(),Le.delete(x),f())},x=()=>{i||(console.log("Tile wait cancelled - user is interacting"),A())};Le.add(x);const l=()=>{o.every(V=>{const X=V.replace(/-layer$/,"");return!!e.getSource(X)&&e.isSourceLoaded(X)})&&e.areTilesLoaded()&&A()},P=()=>{console.log("Map movement detected - finishing tile wait early"),A()},$=setTimeout(A,c),q=()=>{e.off("idle",l),e.off("movestart",P),clearTimeout($)};e.on("idle",l),e.on("movestart",P),l()})}function Be(e,o,c=512){const f=o.id,i=`${o.id}-layer`;return e.getSource(f)||e.addSource(f,{type:"raster",tiles:[Fe(o,c)],tileSize:c,maxzoom:18}),e.getLayer(i)||e.addLayer({id:i,type:"raster",source:f,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),i}const h=ot.orthophotos.reduce((e,o)=>{const c=o.year.split(" ")[0],f=e.find(i=>i.year===c);return f?f.layers.push(o):e.push({id:c,year:c,displayYear:c,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,c)=>{const f=i=>/Printemps/i.test(i)?0:/Été|Ete/i.test(i)?1:2;return f(o.year)-f(c.year)})}));let I=M(h[0].id),z=M(h[h.length-1].id);function ke(e){e.currentTarget.setPointerCapture(e.pointerId),U=e.pointerId,Z=!0}function Re(e){if(!Z||U!==e.pointerId||!d(O))return;const o=d(O).getBoundingClientRect(),c=e.clientX-o.left;qe(Math.max(0,Math.min(100,c/o.width*100)))}function xe(e){if(U===e.pointerId){const o=e.currentTarget;try{o.releasePointerCapture(e.pointerId)}catch{}Z=!1,U=null}}const ae=new WeakMap;async function F(e,o){const c=ae.get(e);c&&(console.log("Waiting for previous layer change to complete..."),await c);const f=(async()=>{const i=_e(e),A=[...i],x=o.layers.map(l=>Be(e,l,512));requestAnimationFrame(()=>{x.forEach(l=>{e.getLayer(l)&&e.moveLayer(l)})}),await Ne(e,x,1500),requestAnimationFrame(()=>{x.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",1)}),A.forEach(l=>{e.getLayer(l)&&e.setPaintProperty(l,"raster-opacity",0)})}),setTimeout(()=>{A.forEach(l=>{if(!x.includes(l)){const P=l.replace(/-layer$/,"");e.getLayer(l)&&e.removeLayer(l),e.getSource(P)&&e.removeSource(P),i.delete(l)}}),x.forEach(l=>i.add(l))},400)})();ae.set(e,f),await f,ae.delete(e)}let W=null;function We(e){if(!a)return;const o=h.find(c=>c.id===e);o&&(F(a,o),v(I,e),W&&W(!0))}function Ge(e){if(!m)return;const o=h.find(c=>c.id===e);o&&(F(m,o),v(z,e),W&&W(!0))}Ve(()=>{let e=!1;const o=new Map,c=[[2.75,49.45],[6.5,50.85]],f=[[2,49],[7.2,51.3]];let i=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)){if(i={center:[s,n],zoom:u},t.length>=5){const g=t[3],y=t[4];h.find(w=>w.id===g)&&v(I,g),h.find(w=>w.id===y)&&v(z,y)}return!0}}return!1})();const x=h.find(r=>r.id===d(I)),l=h.find(r=>r.id===d(z)),P={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},$={container:d(R),style:P,minZoom:7,maxZoom:17,maxBounds:f,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?($.center=i.center,$.zoom=i.zoom):($.bounds=c,$.fitBoundsOptions={padding:-50}),a=new D.Map($);const q={container:d(Y),style:JSON.parse(JSON.stringify(P)),minZoom:7,maxZoom:17,maxBounds:f,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};i?(q.center=i.center,q.zoom=i.zoom):(q.bounds=c,q.fitBoundsOptions={padding:-50}),m=new D.Map(q);const ce=new Map,V=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ce.get(t.sourceId)||0;n<2&&(ce.set(t.sourceId,n+1),setTimeout(()=>{const s=r.getSource(t.sourceId);s&&"reload"in s&&s.reload()},1e3*(n+1)))}};a.on("error",V(a)),m.on("error",V(m)),a.once("load",()=>F(a,x)),m.once("load",()=>F(m,l)),a.addControl(new D.NavigationControl,"bottom-left"),a.addControl(new D.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const X={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const u=encodeURIComponent(t);if(!u)return{type:"FeatureCollection",features:n};const g=`https://nominatim.openstreetmap.org/search?q=${u}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,w=await(await fetch(g,{headers:{"Accept-Language":"fr"}})).json(),G=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const b of w.features??[]){const he=b.properties?.address?.state,Ze=b.properties?.address?.county;if(!(he==="Wallonie"||he==="Région wallonne"||G.some(S=>Ze?.includes(S)||he?.includes(S))))continue;const ye=b.bbox,T=Array.isArray(ye)&&ye.length===4?ye.map(Number):void 0;let N;if(T)N=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2];else if(b.geometry?.type==="Point"&&Array.isArray(b.geometry.coordinates))N=[Number(b.geometry.coordinates[0]),Number(b.geometry.coordinates[1])];else{const S=[],Ae=p=>{p&&(p.type==="Point"?S.push([+p.coordinates[0],+p.coordinates[1]]):p.type==="LineString"||p.type==="MultiPoint"?p.coordinates.forEach(L=>S.push([+L[0],+L[1]])):p.type==="Polygon"||p.type==="MultiLineString"?p.coordinates.flat(1).forEach(L=>S.push([+L[0],+L[1]])):p.type==="MultiPolygon"?p.coordinates.flat(2).forEach(L=>S.push([+L[0],+L[1]])):p.type==="GeometryCollection"&&(p.geometries||[]).forEach(Ae))};if(Ae(b.geometry),S.length){const p=S.map(ge=>ge[0]),L=S.map(ge=>ge[1]),B=[Math.min(...p),Math.min(...L),Math.max(...p),Math.max(...L)];N=[B[0]+(B[2]-B[0])/2,B[1]+(B[3]-B[1])/2]}else N=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:N},place_name:b.properties?.display_name,properties:{...b.properties,bbox:T},text:b.properties?.display_name,place_type:["place"],center:N,bbox:T})}}catch(u){console.error("forwardGeocode error:",u)}const s={type:"FeatureCollection",features:n};if(o.size>=50){const u=o.keys().next().value;u!==void 0&&o.delete(u)}return o.set(t,s),s}},_=new tt(X,{maplibregl:D,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl(_,"top-left");const de=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:r.center,zoom:15,duration:1200})};let E=[],C=0;_.on("results",r=>{E=r.features||[],C=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"),t.forEach((n,s)=>{const u=g=>{if(g.preventDefault(),g.stopPropagation(),E[s]){const y=document.querySelector(".maplibregl-ctrl-geocoder input");y&&y.blur(),de(E[s]),setTimeout(()=>{y&&(y.value=""),_.clear(),E=[]},100)}};n.removeEventListener("touchend",u),n.removeEventListener("click",u),n.addEventListener("touchend",u,{passive:!1}),n.addEventListener("click",u)}))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&E.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const s=E[C];s&&(de(s),t.target.value="",_.clear(),E=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),C=Math.min(C+1,E.length-1),n.forEach(s=>s.classList.remove("active")),n[C]&&n[C].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),C=Math.max(C-1,0),n.forEach(s=>s.classList.remove("active")),n[C]&&n[C].classList.add("active"))},!0)},100),_.on("result",r=>{const t=r.result;de(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),_.clear()},100)});const Ye=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let ue=null,Te="";const fe=(r=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),n=a.getZoom(),s=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${d(I)},${d(z)}`;s!==Te&&(Te=s,r?window.location.hash=s:history.replaceState(null,"",`#${s}`))};W=fe;let Ie=0;a.on("move",()=>{!Z&&!e&&Ye(a,m);const r=a.getCenter();v(se,{lng:r.lng,lat:r.lat}),v(we,a.getZoom());const t=performance.now();t-Ie>120&&(fe(!1),Ie=t),ue&&clearTimeout(ue),ue=window.setTimeout(()=>{fe(!0)},800)});let pe=null;const me=()=>{pe||(pe=window.setTimeout(()=>{a&&a.resize(),m&&m.resize(),pe=null},250))};setTimeout(me,100),window.addEventListener("resize",me);const ze=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)&&(a&&a.flyTo({center:[s,n],zoom:u,duration:1e3}),t.length>=5)){const g=t[3],y=t[4];if(g&&g!==d(I)){const w=h.find(G=>G.id===g);w&&(v(I,g),F(a,w))}if(y&&y!==d(z)){const w=h.find(G=>G.id===y);w&&(v(z,y),F(m,w))}}}};window.addEventListener("hashchange",ze);const Oe=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",me),window.removeEventListener("hashchange",ze),clearInterval(Oe),a.remove(),m.remove()}}),Qe();var ie=rt(),j=ee(ie),Ce=ee(j);ve(Ce,e=>v(R,e),()=>d(R));var le=H(Ce,2);ve(le,e=>v(Y,e),()=>d(Y));var J=H(le,2),K=ee(J);te(J);var He=H(J,2);et(He,{get lat(){return d(se).lat},get lng(){return d(se).lng},get zoom(){return d(we)},get yearBefore(){return d(I)},get yearAfter(){return d(z)},shareText:""}),te(j),ve(j,e=>v(O,e),()=>d(O));var Se=H(j,2);Ee(Se,{side:"left",get groups(){return h},get selectedId(){return d(I)},$$events:{select:e=>We(e.detail.id)}});var De=H(Se,2);Ee(De,{side:"right",get groups(){return h},get selectedId(){return d(z)},$$events:{select:e=>Ge(e.detail.id)}}),te(ie),je(()=>{Pe(le,`clip-path: inset(0 0 0 calc(${d(re)??""}% - 0.5px))`),Pe(J,`left: ${d(re)??""}%`)}),Q("pointerdown",K,ke),Q("pointermove",K,Re),Q("pointerup",K,xe),Q("pointercancel",K,xe),$e(oe,ie),Je()}var st=Me('<div class="page-container svelte-q4ucql"><!></div>');function gt(oe){var k=st();Xe(Y=>{Ke.title="Timelapse - Comparaison d'orthophotos"});var R=ee(k);nt(R,{}),te(k),$e(oe,k)}export{gt as component};
