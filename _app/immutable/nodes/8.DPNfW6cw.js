import"../chunks/DsnmJJEf.js";import"../chunks/C1X7ZH2G.js";import{I as Se,K as x,A as ue,B as Ae,C as fe,J as _e,au as Y,F as Z,D as B,w as s,M as y,G as j,aw as qe}from"../chunks/sZzwH-X8.js";import{h as Te}from"../chunks/Xjmt66yp.js";import{o as Pe,e as A}from"../chunks/DPlkaXRH.js";import{s as ce}from"../chunks/B_ypSufT.js";import{b as re}from"../chunks/DlGDAnrT.js";import{i as Ee}from"../chunks/B2bDIl6U.js";import{S as Be,m as I,M as Ie}from"../chunks/vupgCqCY.js";import{o as Re}from"../chunks/CUZUMNKG.js";import{Y as de}from"../chunks/BeJWcgwJ.js";var ke=ue('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function De(O,_){Se(_,!1);let q=x(),R=x(),L=x(),c,b,k=x(50),C=!1,U=x({lng:4.5,lat:50.5}),K=x(8);const f=Re.orthophotos.reduce((e,o)=>{const a=o.year.split(" ")[0],n=e.find(l=>l.year===a);return n?n.layers.push(o):e.push({id:a,year:a,displayYear:a,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,a)=>{const n=l=>/Printemps/i.test(l)?0:/Été|Ete/i.test(l)?1:2;return n(o.year)-n(a.year)})}));let z=x(f[0].id),M=x(f[f.length-1].id);function pe(e){e.preventDefault(),e.stopPropagation(),C=!0}function me(e){if(!C||!s(L))return;e.preventDefault();const o=s(L).getBoundingClientRect(),a=e.clientX-o.left;y(k,Math.max(0,Math.min(100,a/o.width*100)))}function ye(){C=!1}function he(e){e.preventDefault(),e.stopPropagation(),C=!0}function ge(e){if(!C||!s(L))return;e.preventDefault();const o=s(L).getBoundingClientRect(),a=e.touches[0].clientX-o.left;y(k,Math.max(0,Math.min(100,a/o.width*100)))}function ve(){C=!1}function D(e,o){const a=e.getStyle();if(a?.layers)for(const n of a.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const l=n.source;l&&e.getSource(l)&&e.removeSource(l)}o.layers.forEach(n=>{const l=n.id,G=`${n.id}-layer`;e.getSource(l)||e.addSource(l,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(G)||e.addLayer({id:G,type:"raster",source:l,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),o.layers.forEach(n=>{const l=`${n.id}-layer`;e.getLayer(l)&&e.moveLayer(l)}),o.layers.forEach(n=>{const l=`${n.id}-layer`;e.setPaintProperty(l,"raster-opacity",1)})}function be(e){if(!c)return;const o=f.find(a=>a.id===e);o&&(D(c,o),y(z,e))}function we(e){if(!b)return;const o=f.find(a=>a.id===e);o&&(D(b,o),y(M,e))}Pe(()=>{let e=!1;const o=new Map,a=[[2.75,49.45],[6.5,50.85]];let n=null;if(typeof window<"u"&&window.location.hash){const t=window.location.hash.slice(1).split(",");if(t.length>=3){const i=parseFloat(t[0]),u=parseFloat(t[1]),g=parseFloat(t[2].replace("z",""));if(!isNaN(i)&&!isNaN(u)&&!isNaN(g)&&(n={center:[u,i],zoom:g}),t.length>=5){const W=t[3],Q=t[4];f.find(E=>E.id===W)&&y(z,W),f.find(E=>E.id===Q)&&y(M,Q)}}}const l=f.find(r=>r.id===s(z)),G=f.find(r=>r.id===s(M));c=new I.Map({container:s(q),style:{version:8,sources:{},layers:[]},...n?{center:n.center,zoom:n.zoom}:{bounds:a,fitBoundsOptions:{padding:0}},minZoom:8,maxZoom:17,attributionControl:!1}),b=new I.Map({container:s(R),style:{version:8,sources:{},layers:[]},...n?{center:n.center,zoom:n.zoom}:{bounds:a,fitBoundsOptions:{padding:0}},minZoom:8,maxZoom:17,interactive:!1,attributionControl:!1}),c.once("load",()=>D(c,l)),b.once("load",()=>D(b,G)),c.addControl(new I.NavigationControl,"bottom-left"),c.addControl(new I.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const Le={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const i=[];try{const g=encodeURIComponent(t);if(!g)return{type:"FeatureCollection",features:i};const W=`https://nominatim.openstreetmap.org/search?q=${g}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,E=await(await fetch(W,{headers:{"Accept-Language":"fr"}})).json(),Me=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const p of E.features??[]){const ee=p.properties?.address?.state,$e=p.properties?.address?.county;if(!(ee==="Wallonie"||ee==="Région wallonne"||Me.some(v=>$e?.includes(v)||ee?.includes(v))))continue;const te=p.bbox,w=Array.isArray(te)&&te.length===4?te.map(Number):void 0;let $;if(w)$=[w[0]+(w[2]-w[0])/2,w[1]+(w[3]-w[1])/2];else if(p.geometry?.type==="Point"&&Array.isArray(p.geometry.coordinates))$=[Number(p.geometry.coordinates[0]),Number(p.geometry.coordinates[1])];else{const v=[],le=d=>{d&&(d.type==="Point"?v.push([+d.coordinates[0],+d.coordinates[1]]):d.type==="LineString"||d.type==="MultiPoint"?d.coordinates.forEach(m=>v.push([+m[0],+m[1]])):d.type==="Polygon"||d.type==="MultiLineString"?d.coordinates.flat(1).forEach(m=>v.push([+m[0],+m[1]])):d.type==="MultiPolygon"?d.coordinates.flat(2).forEach(m=>v.push([+m[0],+m[1]])):d.type==="GeometryCollection"&&(d.geometries||[]).forEach(le))};if(le(p.geometry),v.length){const d=v.map(oe=>oe[0]),m=v.map(oe=>oe[1]),S=[Math.min(...d),Math.min(...m),Math.max(...d),Math.max(...m)];$=[S[0]+(S[2]-S[0])/2,S[1]+(S[3]-S[1])/2]}else $=[4.4699,50.5039]}i.push({type:"Feature",geometry:{type:"Point",coordinates:$},place_name:p.properties?.display_name,properties:{...p.properties,bbox:w},text:p.properties?.display_name,place_type:["place"],center:$,bbox:w})}}catch(g){console.error("forwardGeocode error:",g)}const u={type:"FeatureCollection",features:i};if(o.size>=50){const g=o.keys().next().value;g!==void 0&&o.delete(g)}return o.set(t,u),u}},T=new Ie(Le,{maplibregl:I,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});c.addControl(T,"top-left");const ie=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?c.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):c.flyTo({center:r.center,zoom:15,duration:1200})};let P=[],h=0;T.on("results",r=>{P=r.features||[],h=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(i=>i.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const i=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&P.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const u=P[h];u&&(ie(u),t.target.value="",T.clear(),P=[])}else t.key==="ArrowDown"&&i.length>0?(t.preventDefault(),h=Math.min(h+1,P.length-1),i.forEach(u=>u.classList.remove("active")),i[h]&&i[h].classList.add("active")):t.key==="ArrowUp"&&i.length>0&&(t.preventDefault(),h=Math.max(h-1,0),i.forEach(u=>u.classList.remove("active")),i[h]&&i[h].classList.add("active"))},!0)},100),T.on("result",r=>{const t=r.result;ie(t),setTimeout(()=>{const i=document.querySelector(".maplibregl-ctrl-geocoder input");i&&(i.value=""),T.clear()},100)});const ze=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};c.on("move",()=>{!C&&!e&&ze(c,b);const r=c.getCenter();y(U,{lng:r.lng,lat:r.lat}),y(K,c.getZoom()),typeof window<"u"&&(window.location.hash=`${r.lat.toFixed(6)},${r.lng.toFixed(6)},${s(K).toFixed(2)}z,${s(z)},${s(M)}`)});let J=null;const V=()=>{J||(J=window.setTimeout(()=>{c&&c.resize(),b&&b.resize(),J=null},250))};return setTimeout(V,100),window.addEventListener("resize",V),()=>{window.removeEventListener("resize",V),c.remove(),b.remove()}}),Ee();var X=ke();A("mousemove",Y,me),A("mouseup",Y,ye),A("touchmove",Y,ge),A("touchend",Y,ve);var F=Z(X),ne=Z(F);re(ne,e=>y(q,e),()=>s(q));var H=B(ne,2);re(H,e=>y(R,e),()=>s(R));var N=B(H,2),se=Z(N);j(N);var xe=B(N,2);Be(xe,{get lat(){return s(U).lat},get lng(){return s(U).lng},get zoom(){return s(K)},get yearBefore(){return s(z)},get yearAfter(){return s(M)},shareText:""}),j(F),re(F,e=>y(L,e),()=>s(L));var ae=B(F,2);de(ae,{side:"left",get groups(){return f},get selectedId(){return s(z)},$$events:{select:e=>be(e.detail.id)}});var Ce=B(ae,2);de(Ce,{side:"right",get groups(){return f},get selectedId(){return s(M)},$$events:{select:e=>we(e.detail.id)}}),j(X),Ae(()=>{ce(H,`clip-path: inset(0 0 0 ${s(k)??""}%)`),ce(N,`left: ${s(k)??""}%`)}),A("mousedown",se,pe),A("touchstart",se,he),fe(O,X),_e()}var Fe=ue('<div class="page-container svelte-q4ucql"><!></div>');function Ve(O){var _=Fe();Te(R=>{qe.title="Timelapse - Comparaison d'orthophotos"});var q=Z(_);De(q,{}),j(_),fe(O,_)}export{Ve as component};
