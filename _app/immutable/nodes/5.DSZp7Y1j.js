import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Qe,K as R,A as _e,B as et,C as Ne,J as tt,am as U,F as ee,D as Z,w as c,M as y,G as te}from"../chunks/Ehb9Q6W5.js";import{o as ot,e as z}from"../chunks/BKIJojkU.js";import{s as Re}from"../chunks/yJVuIktW.js";import{b as ye}from"../chunks/m2zDNTuv.js";import{i as rt}from"../chunks/D631TkqT.js";import{S as nt,m as V,M as st}from"../chunks/VYvS0YDk.js";import{o as $e}from"../chunks/C4AmPXCP.js";import{Y as Pe}from"../chunks/Br037vyA.js";var at=_e('<div class="timelapse-container svelte-1awtn06"><div class="map-wrapper svelte-1awtn06"><div class="map-container before svelte-1awtn06"></div> <div class="map-container after svelte-1awtn06"></div> <div class="compare-slider svelte-1awtn06"><div class="slider-handle svelte-1awtn06" role="button" tabindex="0"><span class="slider-arrows svelte-1awtn06">◄ ►</span></div></div> <!></div> <!> <!></div>');function it(oe,H){Qe(H,!1);let Y=R(),re=R(),F=R(),s,p,ne=R(50),$=!1,C=null,se=null;function ve(e){y(ne,e),se&&cancelAnimationFrame(se),se=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let ae=R({lng:4.35,lat:50.85}),we=R(11);function ze(e,r=512){const a=$e;return e.service==="urban-brussels"&&e.crs==="EPSG:31370"?`${a.wmsUrbanBrusselsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=${r}&HEIGHT=${r}&BBOX={bbox-epsg-3857}`:`${a.wmsBaseUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=${r}&HEIGHT=${r}&BBOX={bbox-epsg-3857}`}const be=new WeakMap;function Fe(e){let r=be.get(e);return r||(r=new Set,be.set(e,r)),r}let Te=new Set;function Ge(e,r,a=3e3){return new Promise(d=>{let m=!1;const b=()=>{m||(m=!0,_(),Te.delete(T),d())},T=()=>{m||(console.log("Tile wait cancelled - user is interacting"),b())};Te.add(T);const i=()=>{r.every(J=>{const K=J.replace(/-layer$/,"");return!!e.getSource(K)&&e.isSourceLoaded(K)})&&e.areTilesLoaded()&&b()},M=()=>{console.log("Map movement detected - finishing tile wait early"),b()},P=setTimeout(b,a),_=()=>{e.off("idle",i),e.off("movestart",M),clearTimeout(P)};e.on("idle",i),e.on("movestart",M),i()})}function ke(e,r,a=512){const d=r.id,m=`${r.id}-layer`;return e.getSource(d)||e.addSource(d,{type:"raster",tiles:[ze(r,a)],tileSize:a,maxzoom:20}),e.getLayer(m)||e.addLayer({id:m,type:"raster",source:d,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),m}const g=$e.orthophotos.map(e=>({id:e.id,year:e.year,displayYear:e.year,layers:[e]}));let B=R(g[0].id),L=R(g[g.length-1].id);function A(){$=!1,C!==null&&(clearTimeout(C),C=null)}function De(e){e.preventDefault(),e.stopPropagation(),$=!0,C!==null&&clearTimeout(C),C=window.setTimeout(()=>{console.warn("Drag timeout - forcing reset"),A()},1e4)}function Oe(e){if(!$||!c(F))return;e.preventDefault();const r=c(F).getBoundingClientRect(),a=e.clientX-r.left;ve(Math.max(0,Math.min(100,a/r.width*100)))}function He(){A()}function Ye(e){$=!0,C!==null&&clearTimeout(C),C=window.setTimeout(()=>{console.warn("Touch timeout - forcing reset"),A()},1e4)}function qe(e){if(!$||!c(F))return;if(!e.touches||e.touches.length===0){A();return}const r=c(F).getBoundingClientRect(),a=e.touches[0].clientX-r.left;ve(Math.max(0,Math.min(100,a/r.width*100)))}function We(){A()}function Ue(){A()}function Se(){document.hidden&&$&&(console.log("Page hidden - resetting drag state"),A())}const ie=new WeakMap;async function G(e,r){const a=ie.get(e);a&&(console.log("Waiting for previous layer change to complete..."),await a);const d=(async()=>{const m=Fe(e),b=[...m],T=r.layers.map(i=>ke(e,i,512));requestAnimationFrame(()=>{T.forEach(i=>{e.getLayer(i)&&e.moveLayer(i)})}),await Ge(e,T,1500),requestAnimationFrame(()=>{T.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",1)}),b.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",0)})}),setTimeout(()=>{b.forEach(i=>{if(!T.includes(i)){const M=i.replace(/-layer$/,"");e.getLayer(i)&&e.removeLayer(i),e.getSource(M)&&e.removeSource(M),m.delete(i)}}),T.forEach(i=>m.add(i))},400)})();ie.set(e,d),await d,ie.delete(e)}let q=null;function Ze(e){if(!s)return;const r=g.find(a=>a.id===e);r&&(G(s,r),y(B,e),q&&q(!0))}function Ve(e){if(!p)return;const r=g.find(a=>a.id===e);r&&(G(p,r),y(L,e),q&&q(!0))}ot(()=>{let e=null;(()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)){if(e={center:[l,n],zoom:h},t.length>=5){const E=t[3],I=t[4];g.find(v=>v.id===E)&&y(B,E),g.find(v=>v.id===I)&&y(L,I)}return!0}}return!1})();let a=!1;const d=new Map,m=[[4.243,50.764],[4.482,50.913]],b=[[4.05,50.65],[4.68,51.05]],T=g.find(o=>o.id===c(B)),i=g.find(o=>o.id===c(L)),M={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},P={container:c(Y),style:M,minZoom:10,maxZoom:20,maxBounds:b,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};e?(P.center=e.center,P.zoom=e.zoom):(P.bounds=m,P.fitBoundsOptions={padding:0}),s=new V.Map(P);const _={container:c(re),style:JSON.parse(JSON.stringify(M)),minZoom:10,maxZoom:20,maxBounds:b,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};e?(_.center=e.center,_.zoom=e.zoom):(_.bounds=m,_.fitBoundsOptions={padding:0}),p=new V.Map(_);const ue=new Map,J=o=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ue.get(t.sourceId)||0;n<2&&(ue.set(t.sourceId,n+1),setTimeout(()=>{const l=o.getSource(t.sourceId);l&&"reload"in l&&l.reload()},1e3*(n+1)))}};s.on("error",J(s)),p.on("error",J(p)),s.once("load",()=>G(s,T)),p.once("load",()=>G(p,i)),s.addControl(new V.NavigationControl,"bottom-left"),s.addControl(new V.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Creative Commons Attribution (CC-BY) - <a href="https://be.brussels/en/about-region/structure-and-organisations/administrations-and-institutions-region/paradigm" target="_blank">Paradigm</a> - <a href="https://bruciel.brussels/" target="_blank">Bruciel</a>'}),"bottom-right");const K={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(d.has(t))return d.get(t);const n=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:n};const E=`https://nominatim.openstreetmap.org/search?q=${h}, Bruxelles&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,v=await(await fetch(E,{headers:{"Accept-Language":"fr"}})).json();for(const f of v.features??[]){const Me=f.properties?.address?.region,Q=f.properties?.address?.state;if(!(Me?.includes("Bruxelles")||Me?.includes("Brussels")||Q==="Bruxelles-Capitale"||Q==="Brussels Hoofdstedelijk Gewest"||Q==="Région de Bruxelles-Capitale"||Q==="Brussels-Capital"))continue;const ge=f.bbox,x=Array.isArray(ge)&&ge.length===4?ge.map(Number):void 0;let D;if(x)D=[x[0]+(x[2]-x[0])/2,x[1]+(x[3]-x[1])/2];else if(f.geometry?.type==="Point"&&Array.isArray(f.geometry.coordinates))D=[Number(f.geometry.coordinates[0]),Number(f.geometry.coordinates[1])];else{const N=[],Ie=u=>{u&&(u.type==="Point"?N.push([+u.coordinates[0],+u.coordinates[1]]):u.type==="LineString"||u.type==="MultiPoint"?u.coordinates.forEach(w=>N.push([+w[0],+w[1]])):u.type==="Polygon"||u.type==="MultiLineString"?u.coordinates.flat(1).forEach(w=>N.push([+w[0],+w[1]])):u.type==="MultiPolygon"?u.coordinates.flat(2).forEach(w=>N.push([+w[0],+w[1]])):u.type==="GeometryCollection"&&(u.geometries||[]).forEach(Ie))};if(Ie(f.geometry),N.length){const u=N.map(he=>he[0]),w=N.map(he=>he[1]),O=[Math.min(...u),Math.min(...w),Math.max(...u),Math.max(...w)];D=[O[0]+(O[2]-O[0])/2,O[1]+(O[3]-O[1])/2]}else D=[4.3517,50.8503]}n.push({type:"Feature",geometry:{type:"Point",coordinates:D},place_name:f.properties?.display_name,properties:{...f.properties,bbox:x},text:f.properties?.display_name,place_type:["place"],center:D,bbox:x})}}catch(h){console.error("forwardGeocode error:",h)}const l={type:"FeatureCollection",features:n};if(d.size>=50){const h=d.keys().next().value;h!==void 0&&d.delete(h)}return d.set(t,l),l}},k=new st(K,{maplibregl:V,placeholder:"Cherchez une adresse à Bruxelles",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});s.addControl(k,"top-left");const Be=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?s.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):s.flyTo({center:o.center,zoom:15,duration:1200})};let W=[],S=0;k.on("results",o=>{W=o.features||[],S=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&W.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=W[S];l&&(Be(l),t.target.value="",k.clear(),W=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),S=Math.min(S+1,W.length-1),n.forEach(l=>l.classList.remove("active")),n[S]&&n[S].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),S=Math.max(S-1,0),n.forEach(l=>l.classList.remove("active")),n[S]&&n[S].classList.add("active"))},!0)},100),k.on("result",o=>{const t=o.result;Be(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),k.clear()},100)});const Je=(o,t)=>{a||(a=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{a=!1}))};let de=null,Le="";const fe=(o=!1)=>{if(typeof window>"u"||!s)return;const t=s.getCenter(),n=s.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${c(B)},${c(L)}`;l!==Le&&(Le=l,o?window.location.hash=l:history.replaceState(null,"",`#${l}`))};q=fe,s.on("move",()=>{!$&&!a&&Je(s,p);const o=s.getCenter();y(ae,{lng:o.lng,lat:o.lat}),y(we,s.getZoom()),fe(!1),de&&clearTimeout(de),de=window.setTimeout(()=>{fe(!0)},1e3)});let pe=null;const me=()=>{pe||(pe=window.setTimeout(()=>{s&&s.resize(),p&&p.resize(),pe=null},250))};setTimeout(me,100),window.addEventListener("resize",me);const Ae=()=>{if(typeof window>"u")return;const o=window.location.hash.slice(1);if(!o)return;const t=o.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)&&(s&&s.flyTo({center:[l,n],zoom:h,duration:1e3}),t.length>=5)){const E=t[3],I=t[4];if(E&&E!==c(B)){const v=g.find(f=>f.id===E);v&&(y(B,E),G(s,v))}if(I&&I!==c(L)){const v=g.find(f=>f.id===I);v&&(y(L,I),G(p,v))}}}};window.addEventListener("hashchange",Ae),document.addEventListener("visibilitychange",Se);const Ke=setInterval(()=>{a&&(console.warn("isSyncing stuck - forcing reset"),a=!1)},5e3);return()=>{window.removeEventListener("resize",me),window.removeEventListener("hashchange",Ae),document.removeEventListener("visibilitychange",Se),clearInterval(Ke),A(),s.remove(),p.remove()}}),rt();var le=at();z("mousemove",U,Oe),z("mouseup",U,He),z("touchmove",U,qe),z("touchend",U,We),z("touchcancel",U,Ue);var j=ee(le),Ce=ee(j);ye(Ce,e=>y(Y,e),()=>c(Y));var ce=Z(Ce,2);ye(ce,e=>y(re,e),()=>c(re));var X=Z(ce,2),Ee=ee(X);te(X);var je=Z(X,2);nt(je,{get lat(){return c(ae).lat},get lng(){return c(ae).lng},get zoom(){return c(we)},get yearBefore(){return c(B)},get yearAfter(){return c(L)}}),te(j),ye(j,e=>y(F,e),()=>c(F));var xe=Z(j,2);Pe(xe,{side:"left",get groups(){return g},get selectedId(){return c(B)},$$events:{select:e=>Ze(e.detail.id)}});var Xe=Z(xe,2);Pe(Xe,{side:"right",get groups(){return g},get selectedId(){return c(L)},$$events:{select:e=>Ve(e.detail.id)}}),te(le),et(()=>{Re(ce,`clip-path: inset(0 0 0 calc(${c(ne)??""}% - 0.5px))`),Re(X,`left: ${c(ne)??""}%`)}),z("mousedown",Ee,De),z("touchstart",Ee,Ye),Ne(oe,le),tt()}var lt=_e('<div class="page-container svelte-1ewpa8p"><!></div>');function bt(oe){var H=lt(),Y=ee(H);it(Y,{}),te(H),Ne(oe,H)}export{bt as component};
