import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Te,K as C,A as me,B as _e,C as ye,J as qe,am as j,F as O,D as k,w as s,M as g,G as H,ao as Be}from"../chunks/Ehb9Q6W5.js";import{o as Ee,e as _,h as Me}from"../chunks/BKIJojkU.js";import{s as fe}from"../chunks/yJVuIktW.js";import{b as ae}from"../chunks/m2zDNTuv.js";import{i as Ie}from"../chunks/D631TkqT.js";import{S as ke,m as D,M as De}from"../chunks/VYvS0YDk.js";import{o as Re}from"../chunks/CUZUMNKG.js";import{Y as pe}from"../chunks/Br037vyA.js";var Fe=me('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function Ne(U,q){Te(q,!1);let B=C(),R=C(),z=C(),c,x,F=C(50),S=!1,K=C({lng:4.5,lat:50.5}),X=C(8);const m=Re.orthophotos.reduce((e,o)=>{const a=o.year.split(" ")[0],f=e.find(u=>u.year===a);return f?f.layers.push(o):e.push({id:a,year:a,displayYear:a,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,a)=>{const f=u=>/Printemps/i.test(u)?0:/Été|Ete/i.test(u)?1:2;return f(o.year)-f(a.year)})}));let P=C(m[0].id),$=C(m[m.length-1].id);function he(e){e.preventDefault(),e.stopPropagation(),S=!0}function ge(e){if(!S||!s(z))return;e.preventDefault();const o=s(z).getBoundingClientRect(),a=e.clientX-o.left;g(F,Math.max(0,Math.min(100,a/o.width*100)))}function ve(){S=!1}function be(e){e.preventDefault(),e.stopPropagation(),S=!0}function we(e){if(!S||!s(z))return;e.preventDefault();const o=s(z).getBoundingClientRect(),a=e.touches[0].clientX-o.left;g(F,Math.max(0,Math.min(100,a/o.width*100)))}function xe(){S=!1}function N(e,o){const a=e.getStyle();if(a?.layers)for(const n of a.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const l=n.source;l&&e.getSource(l)&&e.removeSource(l)}o.layers.forEach(n=>{const l=n.id,E=`${n.id}-layer`;e.getSource(l)||e.addSource(l,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(E)||e.addLayer({id:E,type:"raster",source:l,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),o.layers.forEach(n=>{const l=`${n.id}-layer`;e.getLayer(l)&&e.moveLayer(l)});const f=o.layers.map(n=>`${n.id}-layer`);let u=0;const de=f.length,Q=()=>{u++,u>=de&&f.forEach(n=>{e.getLayer(n)&&e.setPaintProperty(n,"raster-opacity",1)})},Y=n=>{n.isSourceLoaded&&n.sourceId&&o.layers.some(l=>l.id===n.sourceId)&&Q()};e.on("sourcedata",Y),setTimeout(()=>{e.off("sourcedata",Y),f.forEach(n=>{e.getLayer(n)&&e.getPaintProperty(n,"raster-opacity")===0&&e.setPaintProperty(n,"raster-opacity",1)})},2e3)}function Le(e){if(!c)return;const o=m.find(a=>a.id===e);o&&(N(c,o),g(P,e))}function Ce(e){if(!x)return;const o=m.find(a=>a.id===e);o&&(N(x,o),g($,e))}Ee(()=>{let e=!1;const o=new Map,a=[[2.75,49.45],[6.5,50.85]],f=[[2,49],[7.2,51.3]];let u=null;(()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const i=parseFloat(t[0]),p=parseFloat(t[1]),b=parseFloat(t[2].replace("z",""));if(!isNaN(i)&&!isNaN(p)&&!isNaN(b)&&(u={center:[p,i],zoom:b}),t.length>=5){const Z=t[3],oe=t[4];m.find(I=>I.id===Z)&&g(P,Z),m.find(I=>I.id===oe)&&g($,oe)}}})();const Q=m.find(r=>r.id===s(P)),Y=m.find(r=>r.id===s($));c=new D.Map({container:s(B),style:{version:8,sources:{},layers:[]},...u?{center:u.center,zoom:u.zoom}:{bounds:a,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:f,attributionControl:!1}),x=new D.Map({container:s(R),style:{version:8,sources:{},layers:[]},...u?{center:u.center,zoom:u.zoom}:{bounds:a,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:f,interactive:!1,attributionControl:!1}),c.once("load",()=>N(c,Q)),x.once("load",()=>N(x,Y)),c.addControl(new D.NavigationControl,"bottom-left"),c.addControl(new D.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const n={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const i=[];try{const b=encodeURIComponent(t);if(!b)return{type:"FeatureCollection",features:i};const Z=`https://nominatim.openstreetmap.org/search?q=${b}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,I=await(await fetch(Z,{headers:{"Accept-Language":"fr"}})).json(),$e=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const y of I.features??[]){const re=y.properties?.address?.state,Ae=y.properties?.address?.county;if(!(re==="Wallonie"||re==="Région wallonne"||$e.some(w=>Ae?.includes(w)||re?.includes(w))))continue;const ne=y.bbox,L=Array.isArray(ne)&&ne.length===4?ne.map(Number):void 0;let A;if(L)A=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(y.geometry?.type==="Point"&&Array.isArray(y.geometry.coordinates))A=[Number(y.geometry.coordinates[0]),Number(y.geometry.coordinates[1])];else{const w=[],ue=d=>{d&&(d.type==="Point"?w.push([+d.coordinates[0],+d.coordinates[1]]):d.type==="LineString"||d.type==="MultiPoint"?d.coordinates.forEach(h=>w.push([+h[0],+h[1]])):d.type==="Polygon"||d.type==="MultiLineString"?d.coordinates.flat(1).forEach(h=>w.push([+h[0],+h[1]])):d.type==="MultiPolygon"?d.coordinates.flat(2).forEach(h=>w.push([+h[0],+h[1]])):d.type==="GeometryCollection"&&(d.geometries||[]).forEach(ue))};if(ue(y.geometry),w.length){const d=w.map(se=>se[0]),h=w.map(se=>se[1]),T=[Math.min(...d),Math.min(...h),Math.max(...d),Math.max(...h)];A=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2]}else A=[4.4699,50.5039]}i.push({type:"Feature",geometry:{type:"Point",coordinates:A},place_name:y.properties?.display_name,properties:{...y.properties,bbox:L},text:y.properties?.display_name,place_type:["place"],center:A,bbox:L})}}catch(b){console.error("forwardGeocode error:",b)}const p={type:"FeatureCollection",features:i};if(o.size>=50){const b=o.keys().next().value;b!==void 0&&o.delete(b)}return o.set(t,p),p}},l=new De(n,{maplibregl:D,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});c.addControl(l,"top-left");const E=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?c.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):c.flyTo({center:r.center,zoom:15,duration:1200})};let M=[],v=0;l.on("results",r=>{M=r.features||[],v=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(i=>i.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const i=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&M.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const p=M[v];p&&(E(p),t.target.value="",l.clear(),M=[])}else t.key==="ArrowDown"&&i.length>0?(t.preventDefault(),v=Math.min(v+1,M.length-1),i.forEach(p=>p.classList.remove("active")),i[v]&&i[v].classList.add("active")):t.key==="ArrowUp"&&i.length>0&&(t.preventDefault(),v=Math.max(v-1,0),i.forEach(p=>p.classList.remove("active")),i[v]&&i[v].classList.add("active"))},!0)},100),l.on("result",r=>{const t=r.result;E(t),setTimeout(()=>{const i=document.querySelector(".maplibregl-ctrl-geocoder input");i&&(i.value=""),l.clear()},100)});const Pe=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};c.on("move",()=>{!S&&!e&&Pe(c,x);const r=c.getCenter();g(K,{lng:r.lng,lat:r.lat}),g(X,c.getZoom()),typeof window<"u"&&(window.location.hash=`${r.lat.toFixed(6)},${r.lng.toFixed(6)},${s(X).toFixed(2)}z,${s(P)},${s($)}`)});let ee=null;const te=()=>{ee||(ee=window.setTimeout(()=>{c&&c.resize(),x&&x.resize(),ee=null},250))};return setTimeout(te,100),window.addEventListener("resize",te),()=>{window.removeEventListener("resize",te),c.remove(),x.remove()}}),Ie();var J=Fe();_("mousemove",j,ge),_("mouseup",j,ve),_("touchmove",j,we),_("touchend",j,xe);var G=O(J),ie=O(G);ae(ie,e=>g(B,e),()=>s(B));var V=k(ie,2);ae(V,e=>g(R,e),()=>s(R));var W=k(V,2),le=O(W);H(W);var Se=k(W,2);ke(Se,{get lat(){return s(K).lat},get lng(){return s(K).lng},get zoom(){return s(X)},get yearBefore(){return s(P)},get yearAfter(){return s($)},shareText:""}),H(G),ae(G,e=>g(z,e),()=>s(z));var ce=k(G,2);pe(ce,{side:"left",get groups(){return m},get selectedId(){return s(P)},$$events:{select:e=>Le(e.detail.id)}});var ze=k(ce,2);pe(ze,{side:"right",get groups(){return m},get selectedId(){return s($)},$$events:{select:e=>Ce(e.detail.id)}}),H(J),_e(()=>{fe(V,`clip-path: inset(0 0 0 ${s(F)??""}%)`),fe(W,`left: ${s(F)??""}%`)}),_("mousedown",le,he),_("touchstart",le,be),ye(U,J),qe()}var Ge=me('<div class="page-container svelte-q4ucql"><!></div>');function Qe(U){var q=Ge();Me(R=>{Be.title="Timelapse - Comparaison d'orthophotos"});var B=O(q);Ne(B,{}),H(q),ye(U,q)}export{Qe as component};
