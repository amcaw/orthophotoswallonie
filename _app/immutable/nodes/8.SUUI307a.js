import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Te,K as C,A as me,B as _e,C as ye,J as qe,am as O,F as U,D as k,w as s,M as g,G as H,ao as Be}from"../chunks/Ehb9Q6W5.js";import{o as Ee,e as _,h as Me}from"../chunks/BKIJojkU.js";import{s as fe}from"../chunks/yJVuIktW.js";import{b as ie}from"../chunks/m2zDNTuv.js";import{i as Ie}from"../chunks/D631TkqT.js";import{S as ke,m as D,M as De}from"../chunks/VYvS0YDk.js";import{o as Re}from"../chunks/CUZUMNKG.js";import{Y as pe}from"../chunks/Br037vyA.js";var Fe=me('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function Ne(K,q){Te(q,!1);let B=C(),R=C(),z=C(),c,x,F=C(50),S=!1,X=C({lng:4.5,lat:50.5}),J=C(8);const m=Re.orthophotos.reduce((e,r)=>{const a=r.year.split(" ")[0],f=e.find(u=>u.year===a);return f?f.layers.push(r):e.push({id:a,year:a,displayYear:a,layers:[r]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((r,a)=>{const f=u=>/Printemps/i.test(u)?0:/Été|Ete/i.test(u)?1:2;return f(r.year)-f(a.year)})}));let P=C(m[0].id),$=C(m[m.length-1].id);function he(e){e.preventDefault(),e.stopPropagation(),S=!0}function ge(e){if(!S||!s(z))return;e.preventDefault();const r=s(z).getBoundingClientRect(),a=e.clientX-r.left;g(F,Math.max(0,Math.min(100,a/r.width*100)))}function ve(){S=!1}function we(e){e.preventDefault(),e.stopPropagation(),S=!0}function be(e){if(!S||!s(z))return;e.preventDefault();const r=s(z).getBoundingClientRect(),a=e.touches[0].clientX-r.left;g(F,Math.max(0,Math.min(100,a/r.width*100)))}function xe(){S=!1}function N(e,r){const a=e.getStyle();if(a?.layers)for(const n of a.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const l=n.source;l&&e.getSource(l)&&e.removeSource(l)}r.layers.forEach(n=>{const l=n.id,E=`${n.id}-layer`;e.getSource(l)||e.addSource(l,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(E)||e.addLayer({id:E,type:"raster",source:l,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(n=>{const l=`${n.id}-layer`;e.getLayer(l)&&e.moveLayer(l)});const f=r.layers.map(n=>`${n.id}-layer`);let u=0;const Y=f.length,ee=()=>{u++,u>=Y&&f.forEach(n=>{e.getLayer(n)&&e.setPaintProperty(n,"raster-opacity",1)})},Z=n=>{n.isSourceLoaded&&n.sourceId&&r.layers.some(l=>l.id===n.sourceId)&&ee()};e.on("sourcedata",Z),setTimeout(()=>{e.off("sourcedata",Z),f.forEach(n=>{e.getLayer(n)&&e.getPaintProperty(n,"raster-opacity")===0&&e.setPaintProperty(n,"raster-opacity",1)})},2e3)}function Le(e){if(!c)return;const r=m.find(a=>a.id===e);r&&(N(c,r),g(P,e))}function Ce(e){if(!x)return;const r=m.find(a=>a.id===e);r&&(N(x,r),g($,e))}Ee(async()=>{let e=!1;const r=new Map,a=[[2.75,49.45],[6.5,50.85]],f=[[2,49],[7.2,51.3]];let u=null;const Y=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const i=parseFloat(t[0]),p=parseFloat(t[1]),w=parseFloat(t[2].replace("z",""));if(!isNaN(i)&&!isNaN(p)&&!isNaN(w)){if(u={center:[p,i],zoom:w},t.length>=5){const j=t[3],re=t[4];m.find(I=>I.id===j)&&g(P,j),m.find(I=>I.id===re)&&g($,re)}return!0}}return!1};Y()||(await new Promise(o=>setTimeout(o,10)),Y());const ee=m.find(o=>o.id===s(P)),Z=m.find(o=>o.id===s($));c=new D.Map({container:s(B),style:{version:8,sources:{},layers:[]},...u?{center:u.center,zoom:u.zoom}:{bounds:a,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:f,attributionControl:!1}),x=new D.Map({container:s(R),style:{version:8,sources:{},layers:[]},...u?{center:u.center,zoom:u.zoom}:{bounds:a,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:f,interactive:!1,attributionControl:!1}),c.once("load",()=>N(c,ee)),x.once("load",()=>N(x,Z)),c.addControl(new D.NavigationControl,"bottom-left"),c.addControl(new D.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const n={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(r.has(t))return r.get(t);const i=[];try{const w=encodeURIComponent(t);if(!w)return{type:"FeatureCollection",features:i};const j=`https://nominatim.openstreetmap.org/search?q=${w}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,I=await(await fetch(j,{headers:{"Accept-Language":"fr"}})).json(),$e=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const y of I.features??[]){const ne=y.properties?.address?.state,Ae=y.properties?.address?.county;if(!(ne==="Wallonie"||ne==="Région wallonne"||$e.some(b=>Ae?.includes(b)||ne?.includes(b))))continue;const se=y.bbox,L=Array.isArray(se)&&se.length===4?se.map(Number):void 0;let A;if(L)A=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(y.geometry?.type==="Point"&&Array.isArray(y.geometry.coordinates))A=[Number(y.geometry.coordinates[0]),Number(y.geometry.coordinates[1])];else{const b=[],ue=d=>{d&&(d.type==="Point"?b.push([+d.coordinates[0],+d.coordinates[1]]):d.type==="LineString"||d.type==="MultiPoint"?d.coordinates.forEach(h=>b.push([+h[0],+h[1]])):d.type==="Polygon"||d.type==="MultiLineString"?d.coordinates.flat(1).forEach(h=>b.push([+h[0],+h[1]])):d.type==="MultiPolygon"?d.coordinates.flat(2).forEach(h=>b.push([+h[0],+h[1]])):d.type==="GeometryCollection"&&(d.geometries||[]).forEach(ue))};if(ue(y.geometry),b.length){const d=b.map(ae=>ae[0]),h=b.map(ae=>ae[1]),T=[Math.min(...d),Math.min(...h),Math.max(...d),Math.max(...h)];A=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2]}else A=[4.4699,50.5039]}i.push({type:"Feature",geometry:{type:"Point",coordinates:A},place_name:y.properties?.display_name,properties:{...y.properties,bbox:L},text:y.properties?.display_name,place_type:["place"],center:A,bbox:L})}}catch(w){console.error("forwardGeocode error:",w)}const p={type:"FeatureCollection",features:i};if(r.size>=50){const w=r.keys().next().value;w!==void 0&&r.delete(w)}return r.set(t,p),p}},l=new De(n,{maplibregl:D,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});c.addControl(l,"top-left");const E=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?c.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):c.flyTo({center:o.center,zoom:15,duration:1200})};let M=[],v=0;l.on("results",o=>{M=o.features||[],v=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(i=>i.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const i=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&M.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const p=M[v];p&&(E(p),t.target.value="",l.clear(),M=[])}else t.key==="ArrowDown"&&i.length>0?(t.preventDefault(),v=Math.min(v+1,M.length-1),i.forEach(p=>p.classList.remove("active")),i[v]&&i[v].classList.add("active")):t.key==="ArrowUp"&&i.length>0&&(t.preventDefault(),v=Math.max(v-1,0),i.forEach(p=>p.classList.remove("active")),i[v]&&i[v].classList.add("active"))},!0)},100),l.on("result",o=>{const t=o.result;E(t),setTimeout(()=>{const i=document.querySelector(".maplibregl-ctrl-geocoder input");i&&(i.value=""),l.clear()},100)});const Pe=(o,t)=>{e||(e=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{e=!1}))};c.on("move",()=>{!S&&!e&&Pe(c,x);const o=c.getCenter();g(X,{lng:o.lng,lat:o.lat}),g(J,c.getZoom()),typeof window<"u"&&(window.location.hash=`${o.lat.toFixed(6)},${o.lng.toFixed(6)},${s(J).toFixed(2)}z,${s(P)},${s($)}`)});let te=null;const oe=()=>{te||(te=window.setTimeout(()=>{c&&c.resize(),x&&x.resize(),te=null},250))};return setTimeout(oe,100),window.addEventListener("resize",oe),()=>{window.removeEventListener("resize",oe),c.remove(),x.remove()}}),Ie();var V=Fe();_("mousemove",O,ge),_("mouseup",O,ve),_("touchmove",O,be),_("touchend",O,xe);var G=U(V),le=U(G);ie(le,e=>g(B,e),()=>s(B));var Q=k(le,2);ie(Q,e=>g(R,e),()=>s(R));var W=k(Q,2),ce=U(W);H(W);var Se=k(W,2);ke(Se,{get lat(){return s(X).lat},get lng(){return s(X).lng},get zoom(){return s(J)},get yearBefore(){return s(P)},get yearAfter(){return s($)},shareText:""}),H(G),ie(G,e=>g(z,e),()=>s(z));var de=k(G,2);pe(de,{side:"left",get groups(){return m},get selectedId(){return s(P)},$$events:{select:e=>Le(e.detail.id)}});var ze=k(de,2);pe(ze,{side:"right",get groups(){return m},get selectedId(){return s($)},$$events:{select:e=>Ce(e.detail.id)}}),H(V),_e(()=>{fe(Q,`clip-path: inset(0 0 0 ${s(F)??""}%)`),fe(W,`left: ${s(F)??""}%`)}),_("mousedown",ce,he),_("touchstart",ce,we),ye(K,V),qe()}var Ge=me('<div class="page-container svelte-q4ucql"><!></div>');function Qe(K){var q=Ge();Me(R=>{Be.title="Timelapse - Comparaison d'orthophotos"});var B=U(q);Ne(B,{}),H(q),ye(K,q)}export{Qe as component};
