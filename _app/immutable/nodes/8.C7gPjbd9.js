import"../chunks/DsnmJJEf.js";import"../chunks/CQmyZwkG.js";import{I as Ke,K as I,A as _e,B as Ve,C as $e,J as Xe,F as oe,D as k,w as i,M as g,G as re,an as Qe}from"../chunks/CwdBl0A7.js";import{o as et,e as ee,h as tt}from"../chunks/CWmqxiNW.js";import{s as qe}from"../chunks/CrLrFCfu.js";import{b as te}from"../chunks/Cgb6JafD.js";import{i as ot}from"../chunks/Ci2bA8W4.js";import{S as rt,m as D,M as nt}from"../chunks/TnEXErsI.js";import{o as st}from"../chunks/CUZUMNKG.js";import{Y as Me}from"../chunks/REWA9YJ2.js";var at=_e('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="geocoder-overlay svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function it(ne,R){Ke(R,!1);let W=I(),Y=I(),O=I(),Z=I(),a,m,se=I(50),U=!1,j=null,ae=null;function Fe(e){g(se,e),ae&&cancelAnimationFrame(ae),ae=requestAnimationFrame(()=>{m&&m.triggerRepaint()})}let ie=I({lng:4.5,lat:50.5}),be=I(8);const Le=new WeakMap;function Ne(e){let o=Le.get(e);return o||(o=new Set,Le.set(e,o)),o}function Be(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let xe=new Set;function ke(e,o,d=3e3){return new Promise(f=>{let l=!1;const E=()=>{l||(l=!0,_(),xe.delete(x),f())},x=()=>{l||(console.log("Tile wait cancelled - user is interacting"),E())};xe.add(x);const c=()=>{o.every(X=>{const Q=X.replace(/-layer$/,"");return!!e.getSource(Q)&&e.isSourceLoaded(Q)})&&e.areTilesLoaded()&&E()},P=()=>{console.log("Map movement detected - finishing tile wait early"),E()},M=setTimeout(E,d),_=()=>{e.off("idle",c),e.off("movestart",P),clearTimeout(M)};e.on("idle",c),e.on("movestart",P),c()})}function Re(e,o,d=512){const f=o.id,l=`${o.id}-layer`;return e.getSource(f)||e.addSource(f,{type:"raster",tiles:[Be(o,d)],tileSize:d,maxzoom:18}),e.getLayer(l)||e.addLayer({id:l,type:"raster",source:f,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),l}const h=st.orthophotos.reduce((e,o)=>{const d=o.year.split(" ")[0],f=e.find(l=>l.year===d);return f?f.layers.push(o):e.push({id:d,year:d,displayYear:d,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,d)=>{const f=l=>/Printemps/i.test(l)?0:/Été|Ete/i.test(l)?1:2;return f(o.year)-f(d.year)})}));let A=I(h[0].id),z=I(h[h.length-1].id);function We(e){e.currentTarget.setPointerCapture(e.pointerId),j=e.pointerId,U=!0}function Ge(e){if(!U||j!==e.pointerId||!i(O))return;const o=i(O).getBoundingClientRect(),d=e.clientX-o.left;Fe(Math.max(0,Math.min(100,d/o.width*100)))}function Ce(e){if(j===e.pointerId){const o=e.currentTarget;try{o.releasePointerCapture(e.pointerId)}catch{}U=!1,j=null}}const le=new WeakMap;async function F(e,o){const d=le.get(e);d&&(console.log("Waiting for previous layer change to complete..."),await d);const f=(async()=>{const l=Ne(e),E=[...l],x=o.layers.map(c=>Re(e,c,512));requestAnimationFrame(()=>{x.forEach(c=>{e.getLayer(c)&&e.moveLayer(c)})}),await ke(e,x,1500),requestAnimationFrame(()=>{x.forEach(c=>{e.getLayer(c)&&e.setPaintProperty(c,"raster-opacity",1)}),E.forEach(c=>{e.getLayer(c)&&e.setPaintProperty(c,"raster-opacity",0)})}),setTimeout(()=>{E.forEach(c=>{if(!x.includes(c)){const P=c.replace(/-layer$/,"");e.getLayer(c)&&e.removeLayer(c),e.getSource(P)&&e.removeSource(P),l.delete(c)}}),x.forEach(c=>l.add(c))},400)})();le.set(e,f),await f,le.delete(e)}let G=null;function He(e){if(!a)return;const o=h.find(d=>d.id===e);o&&(F(a,o),g(A,e),G&&G(!0))}function De(e){if(!m)return;const o=h.find(d=>d.id===e);o&&(F(m,o),g(z,e),G&&G(!0))}et(()=>{let e=!1;const o=new Map,d=[[2.75,49.45],[6.5,50.85]],f=[[2,49],[7.2,51.3]];let l=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)){if(l={center:[s,n],zoom:u},t.length>=5){const v=t[3],y=t[4];h.find(w=>w.id===v)&&g(A,v),h.find(w=>w.id===y)&&g(z,y)}return!0}}return!1})();const x=h.find(r=>r.id===i(A)),c=h.find(r=>r.id===i(z)),P={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},M={container:i(W),style:P,minZoom:7,maxZoom:17,maxBounds:f,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};l?(M.center=l.center,M.zoom=l.zoom):(M.bounds=d,M.fitBoundsOptions={padding:-50}),a=new D.Map(M);const _={container:i(Y),style:JSON.parse(JSON.stringify(P)),minZoom:7,maxZoom:17,maxBounds:f,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};l?(_.center=l.center,_.zoom=l.zoom):(_.bounds=d,_.fitBoundsOptions={padding:-50}),m=new D.Map(_);const ue=new Map,X=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ue.get(t.sourceId)||0;n<2&&(ue.set(t.sourceId,n+1),setTimeout(()=>{const s=r.getSource(t.sourceId);s&&"reload"in s&&s.reload()},1e3*(n+1)))}};a.on("error",X(a)),m.on("error",X(m)),a.once("load",()=>F(a,x)),m.once("load",()=>F(m,c)),a.addControl(new D.NavigationControl,"bottom-left"),a.addControl(new D.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const Q={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const u=encodeURIComponent(t);if(!u)return{type:"FeatureCollection",features:n};const v=`https://nominatim.openstreetmap.org/search?q=${u}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,w=await(await fetch(v,{headers:{"Accept-Language":"fr"}})).json(),H=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const b of w.features??[]){const ge=b.properties?.address?.state,Je=b.properties?.address?.county;if(!(ge==="Wallonie"||ge==="Région wallonne"||H.some(S=>Je?.includes(S)||ge?.includes(S))))continue;const ve=b.bbox,T=Array.isArray(ve)&&ve.length===4?ve.map(Number):void 0;let N;if(T)N=[T[0]+(T[2]-T[0])/2,T[1]+(T[3]-T[1])/2];else if(b.geometry?.type==="Point"&&Array.isArray(b.geometry.coordinates))N=[Number(b.geometry.coordinates[0]),Number(b.geometry.coordinates[1])];else{const S=[],Pe=p=>{p&&(p.type==="Point"?S.push([+p.coordinates[0],+p.coordinates[1]]):p.type==="LineString"||p.type==="MultiPoint"?p.coordinates.forEach(L=>S.push([+L[0],+L[1]])):p.type==="Polygon"||p.type==="MultiLineString"?p.coordinates.flat(1).forEach(L=>S.push([+L[0],+L[1]])):p.type==="MultiPolygon"?p.coordinates.flat(2).forEach(L=>S.push([+L[0],+L[1]])):p.type==="GeometryCollection"&&(p.geometries||[]).forEach(Pe))};if(Pe(b.geometry),S.length){const p=S.map(we=>we[0]),L=S.map(we=>we[1]),B=[Math.min(...p),Math.min(...L),Math.max(...p),Math.max(...L)];N=[B[0]+(B[2]-B[0])/2,B[1]+(B[3]-B[1])/2]}else N=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:N},place_name:b.properties?.display_name,properties:{...b.properties,bbox:T},text:b.properties?.display_name,place_type:["place"],center:N,bbox:T})}}catch(u){console.error("forwardGeocode error:",u)}const s={type:"FeatureCollection",features:n};if(o.size>=50){const u=o.keys().next().value;u!==void 0&&o.delete(u)}return o.set(t,s),s}},$=new nt(Q,{maplibregl:D,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1}),Ze=$.onAdd(a);i(Z)&&i(Z).appendChild(Ze);const fe=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:r.center,zoom:15,duration:1200})};let q=[],C=0;$.on("results",r=>{q=r.features||[],C=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"),t.forEach((n,s)=>{const u=v=>{if(v.preventDefault(),v.stopPropagation(),q[s]){const y=document.querySelector(".maplibregl-ctrl-geocoder input");y&&y.blur(),fe(q[s]),setTimeout(()=>{y&&(y.value=""),$.clear(),q=[]},100)}};n.removeEventListener("touchend",u),n.removeEventListener("click",u),n.addEventListener("touchend",u,{passive:!1}),n.addEventListener("click",u)}))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&q.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const s=q[C];s&&(fe(s),t.target.value="",$.clear(),q=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),C=Math.min(C+1,q.length-1),n.forEach(s=>s.classList.remove("active")),n[C]&&n[C].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),C=Math.max(C-1,0),n.forEach(s=>s.classList.remove("active")),n[C]&&n[C].classList.add("active"))},!0)},100),$.on("result",r=>{const t=r.result;fe(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),$.clear()},100)});const Ue=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let pe=null,Ae="";const me=(r=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),n=a.getZoom(),s=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${i(A)},${i(z)}`;s!==Ae&&(Ae=s,r?window.location.hash=s:history.replaceState(null,"",`#${s}`))};G=me;let ze=0;a.on("move",()=>{!U&&!e&&Ue(a,m);const r=a.getCenter();g(ie,{lng:r.lng,lat:r.lat}),g(be,a.getZoom());const t=performance.now();t-ze>120&&(me(!1),ze=t),pe&&clearTimeout(pe),pe=window.setTimeout(()=>{me(!0)},800)});let he=null;const ye=()=>{he||(he=window.setTimeout(()=>{a&&a.resize(),m&&m.resize(),he=null},250))};setTimeout(ye,100),window.addEventListener("resize",ye);const Ee=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),s=parseFloat(t[1]),u=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(s)&&!isNaN(u)&&(a&&a.flyTo({center:[s,n],zoom:u,duration:1e3}),t.length>=5)){const v=t[3],y=t[4];if(v&&v!==i(A)){const w=h.find(H=>H.id===v);w&&(g(A,v),F(a,w))}if(y&&y!==i(z)){const w=h.find(H=>H.id===y);w&&(g(z,y),F(m,w))}}}};window.addEventListener("hashchange",Ee);const je=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",ye),window.removeEventListener("hashchange",Ee),clearInterval(je),a.remove(),m.remove()}}),ot();var ce=at(),J=oe(ce),Se=oe(J);te(Se,e=>g(W,e),()=>i(W));var de=k(Se,2);te(de,e=>g(Y,e),()=>i(Y));var Te=k(de,2);te(Te,e=>g(Z,e),()=>i(Z));var K=k(Te,2),V=oe(K);re(K);var Ye=k(K,2);rt(Ye,{get lat(){return i(ie).lat},get lng(){return i(ie).lng},get zoom(){return i(be)},get yearBefore(){return i(A)},get yearAfter(){return i(z)},shareText:""}),re(J),te(J,e=>g(O,e),()=>i(O));var Ie=k(J,2);Me(Ie,{side:"left",get groups(){return h},get selectedId(){return i(A)},$$events:{select:e=>He(e.detail.id)}});var Oe=k(Ie,2);Me(Oe,{side:"right",get groups(){return h},get selectedId(){return i(z)},$$events:{select:e=>De(e.detail.id)}}),re(ce),Ve(()=>{qe(de,`clip-path: inset(0 0 0 calc(${i(se)??""}% - 0.5px))`),qe(K,`left: ${i(se)??""}%`)}),ee("pointerdown",V,We),ee("pointermove",V,Ge),ee("pointerup",V,Ce),ee("pointercancel",V,Ce),$e(ne,ce),Xe()}var lt=_e('<div class="page-container svelte-q4ucql"><!></div>');function bt(ne){var R=lt();tt(Y=>{Qe.title="Timelapse - Comparaison d'orthophotos"});var W=oe(R);it(W,{}),re(R),$e(ne,R)}export{bt as component};
