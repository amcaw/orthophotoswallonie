import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Xe,K as A,A as _e,B as Qe,C as Pe,J as et,am as U,F as te,D as j,w as c,M as g,G as oe,ao as tt}from"../chunks/Ehb9Q6W5.js";import{o as ot,e as q,h as rt}from"../chunks/BKIJojkU.js";import{s as $e}from"../chunks/yJVuIktW.js";import{b as ye}from"../chunks/m2zDNTuv.js";import{i as nt}from"../chunks/D631TkqT.js";import{S as st,m as J,M as at}from"../chunks/VYvS0YDk.js";import{o as it}from"../chunks/CUZUMNKG.js";import{Y as Ee}from"../chunks/Br037vyA.js";var lt=_e('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function ct(re,D){Xe(D,!1);let G=A(),V=A(),B=A(),i,p,ne=A(50),$=!1,x=null,se=null;function ve(e){g(ne,e),se&&cancelAnimationFrame(se),se=requestAnimationFrame(()=>{p&&p.triggerRepaint()})}let ae=A({lng:4.5,lat:50.5}),we=A(8);const be=new WeakMap;function qe(e){let o=be.get(e);return o||(o=new Set,be.set(e,o)),o}function Be(e,o=512){return`${e.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=${o},${o}&format=png32&transparent=true&f=image`}let Te=new Set;function Fe(e,o,s=3e3){return new Promise(u=>{let a=!1;const d=()=>{a||(a=!0,P(),Te.delete(E),u())},E=()=>{a||(console.log("Tile wait cancelled - user is interacting"),d())};Te.add(E);const Y=()=>{o.every(Q=>{const ee=Q.replace(/-layer$/,"");return!!e.getSource(ee)&&e.isSourceLoaded(ee)})&&e.areTilesLoaded()&&d()},O=()=>{console.log("Map movement detected - finishing tile wait early"),d()},_=setTimeout(d,s),P=()=>{e.off("idle",Y),e.off("movestart",O),clearTimeout(_)};e.on("idle",Y),e.on("movestart",O),Y()})}function Ne(e,o,s=512){const u=o.id,a=`${o.id}-layer`;return e.getSource(u)||e.addSource(u,{type:"raster",tiles:[Be(o,s)],tileSize:s,maxzoom:18}),e.getLayer(a)||e.addLayer({id:a,type:"raster",source:u,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),a}const m=it.orthophotos.reduce((e,o)=>{const s=o.year.split(" ")[0],u=e.find(a=>a.year===s);return u?u.layers.push(o):e.push({id:s,year:s,displayYear:s,layers:[o]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((o,s)=>{const u=a=>/Printemps/i.test(a)?0:/Été|Ete/i.test(a)?1:2;return u(o.year)-u(s.year)})}));let M=A(m[0].id),S=A(m[m.length-1].id);function z(){$=!1,x!==null&&(clearTimeout(x),x=null)}function Re(e){e.preventDefault(),e.stopPropagation(),$=!0,x!==null&&clearTimeout(x),x=window.setTimeout(()=>{console.warn("Drag timeout - forcing reset"),z()},1e4)}function ke(e){if(!$||!c(B))return;e.preventDefault();const o=c(B).getBoundingClientRect(),s=e.clientX-o.left;ve(Math.max(0,Math.min(100,s/o.width*100)))}function De(){z()}function Ge(e){$=!0,x!==null&&clearTimeout(x),x=window.setTimeout(()=>{console.warn("Touch timeout - forcing reset"),z()},1e4)}function We(e){if(!$||!c(B))return;if(!e.touches||e.touches.length===0){z();return}const o=c(B).getBoundingClientRect(),s=e.touches[0].clientX-o.left;ve(Math.max(0,Math.min(100,s/o.width*100)))}function Ye(){z()}function Oe(){z()}function xe(){document.hidden&&$&&(console.log("Page hidden - resetting drag state"),z())}async function F(e,o){const s=qe(e),u=[...s],a=o.layers.map(d=>Ne(e,d,512));a.forEach(d=>e.moveLayer(d)),await Fe(e,a,3e3),a.forEach(d=>{e.getLayer(d)&&e.setPaintProperty(d,"raster-opacity",1)}),u.forEach(d=>{e.getLayer(d)&&e.setPaintProperty(d,"raster-opacity",0)}),setTimeout(()=>{u.forEach(d=>{if(!a.includes(d)){const E=d.replace(/-layer$/,"");e.getLayer(d)&&e.removeLayer(d),e.getSource(E)&&e.removeSource(E),s.delete(d)}}),a.forEach(d=>s.add(d))},400)}let W=null;function Ze(e){if(!i)return;const o=m.find(s=>s.id===e);o&&(F(i,o),g(M,e),W&&W(!0))}function He(e){if(!p)return;const o=m.find(s=>s.id===e);o&&(F(p,o),g(S,e),W&&W(!0))}ot(()=>{let e=!1;const o=new Map,s=[[2.75,49.45],[6.5,50.85]],u=[[2,49],[7.2,51.3]];let a=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)){if(a={center:[l,n],zoom:h},t.length>=5){const C=t[3],I=t[4];m.find(y=>y.id===C)&&g(M,C),m.find(y=>y.id===I)&&g(S,I)}return!0}}return!1})();const E=m.find(r=>r.id===c(M)),Y=m.find(r=>r.id===c(S)),O={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},_={container:c(G),style:O,minZoom:7,maxZoom:17,maxBounds:u,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};a?(_.center=a.center,_.zoom=a.zoom):(_.bounds=s,_.fitBoundsOptions={padding:-50}),i=new J.Map(_);const P={container:c(V),style:JSON.parse(JSON.stringify(O)),minZoom:7,maxZoom:17,maxBounds:u,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};a?(P.center=a.center,P.zoom=a.zoom):(P.bounds=s,P.fitBoundsOptions={padding:-50}),p=new J.Map(P);const ce=new Map,Q=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const n=ce.get(t.sourceId)||0;n<2&&(ce.set(t.sourceId,n+1),setTimeout(()=>{const l=r.getSource(t.sourceId);l&&"reload"in l&&l.reload()},1e3*(n+1)))}};i.on("error",Q(i)),p.on("error",Q(p)),i.once("load",()=>F(i,E)),p.once("load",()=>F(p,Y)),i.addControl(new J.NavigationControl,"bottom-left"),i.addControl(new J.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const ee={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(o.has(t))return o.get(t);const n=[];try{const h=encodeURIComponent(t);if(!h)return{type:"FeatureCollection",features:n};const C=`https://nominatim.openstreetmap.org/search?q=${h}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,y=await(await fetch(C,{headers:{"Accept-Language":"fr"}})).json(),H=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of y.features??[]){const me=v.properties?.address?.state,Ke=v.properties?.address?.county;if(!(me==="Wallonie"||me==="Région wallonne"||H.some(T=>Ke?.includes(T)||me?.includes(T))))continue;const he=v.bbox,L=Array.isArray(he)&&he.length===4?he.map(Number):void 0;let R;if(L)R=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))R=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const T=[],Ae=f=>{f&&(f.type==="Point"?T.push([+f.coordinates[0],+f.coordinates[1]]):f.type==="LineString"||f.type==="MultiPoint"?f.coordinates.forEach(w=>T.push([+w[0],+w[1]])):f.type==="Polygon"||f.type==="MultiLineString"?f.coordinates.flat(1).forEach(w=>T.push([+w[0],+w[1]])):f.type==="MultiPolygon"?f.coordinates.flat(2).forEach(w=>T.push([+w[0],+w[1]])):f.type==="GeometryCollection"&&(f.geometries||[]).forEach(Ae))};if(Ae(v.geometry),T.length){const f=T.map(ge=>ge[0]),w=T.map(ge=>ge[1]),k=[Math.min(...f),Math.min(...w),Math.max(...f),Math.max(...w)];R=[k[0]+(k[2]-k[0])/2,k[1]+(k[3]-k[1])/2]}else R=[4.4699,50.5039]}n.push({type:"Feature",geometry:{type:"Point",coordinates:R},place_name:v.properties?.display_name,properties:{...v.properties,bbox:L},text:v.properties?.display_name,place_type:["place"],center:R,bbox:L})}}catch(h){console.error("forwardGeocode error:",h)}const l={type:"FeatureCollection",features:n};if(o.size>=50){const h=o.keys().next().value;h!==void 0&&o.delete(h)}return o.set(t,l),l}},N=new at(ee,{maplibregl:J,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});i.addControl(N,"top-left");const Se=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?i.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):i.flyTo({center:r.center,zoom:15,duration:1200})};let Z=[],b=0;N.on("results",r=>{Z=r.features||[],b=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(n=>n.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const n=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&Z.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=Z[b];l&&(Se(l),t.target.value="",N.clear(),Z=[])}else t.key==="ArrowDown"&&n.length>0?(t.preventDefault(),b=Math.min(b+1,Z.length-1),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active")):t.key==="ArrowUp"&&n.length>0&&(t.preventDefault(),b=Math.max(b-1,0),n.forEach(l=>l.classList.remove("active")),n[b]&&n[b].classList.add("active"))},!0)},100),N.on("result",r=>{const t=r.result;Se(t),setTimeout(()=>{const n=document.querySelector(".maplibregl-ctrl-geocoder input");n&&(n.value=""),N.clear()},100)});const Je=(r,t)=>{e||(e=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let de=null,ze="";const ue=(r=!1)=>{if(typeof window>"u"||!i)return;const t=i.getCenter(),n=i.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${n.toFixed(2)}z,${c(M)},${c(S)}`;l!==ze&&(ze=l,r?window.location.hash=l:history.replaceState(null,"",`#${l}`))};W=ue,i.on("move",()=>{!$&&!e&&Je(i,p);const r=i.getCenter();g(ae,{lng:r.lng,lat:r.lat}),g(we,i.getZoom()),ue(!1),de&&clearTimeout(de),de=window.setTimeout(()=>{ue(!0)},1e3)});let fe=null;const pe=()=>{fe||(fe=window.setTimeout(()=>{i&&i.resize(),p&&p.resize(),fe=null},250))};setTimeout(pe,100),window.addEventListener("resize",pe);const Ie=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const n=parseFloat(t[0]),l=parseFloat(t[1]),h=parseFloat(t[2].replace("z",""));if(!isNaN(n)&&!isNaN(l)&&!isNaN(h)&&(i&&i.flyTo({center:[l,n],zoom:h,duration:1e3}),t.length>=5)){const C=t[3],I=t[4];if(C&&C!==c(M)){const y=m.find(H=>H.id===C);y&&(g(M,C),F(i,y))}if(I&&I!==c(S)){const y=m.find(H=>H.id===I);y&&(g(S,I),F(p,y))}}}};window.addEventListener("hashchange",Ie),document.addEventListener("visibilitychange",xe);const Ve=setInterval(()=>{e&&(console.warn("isSyncing stuck - forcing reset"),e=!1)},5e3);return()=>{window.removeEventListener("resize",pe),window.removeEventListener("hashchange",Ie),document.removeEventListener("visibilitychange",xe),clearInterval(Ve),z(),i.remove(),p.remove()}}),nt();var ie=lt();q("mousemove",U,ke),q("mouseup",U,De),q("touchmove",U,We),q("touchend",U,Ye),q("touchcancel",U,Oe);var K=te(ie),Ce=te(K);ye(Ce,e=>g(G,e),()=>c(G));var le=j(Ce,2);ye(le,e=>g(V,e),()=>c(V));var X=j(le,2),Le=te(X);oe(X);var Ue=j(X,2);st(Ue,{get lat(){return c(ae).lat},get lng(){return c(ae).lng},get zoom(){return c(we)},get yearBefore(){return c(M)},get yearAfter(){return c(S)},shareText:""}),oe(K),ye(K,e=>g(B,e),()=>c(B));var Me=j(K,2);Ee(Me,{side:"left",get groups(){return m},get selectedId(){return c(M)},$$events:{select:e=>Ze(e.detail.id)}});var je=j(Me,2);Ee(je,{side:"right",get groups(){return m},get selectedId(){return c(S)},$$events:{select:e=>He(e.detail.id)}}),oe(ie),Qe(()=>{$e(le,`clip-path: inset(0 0 0 calc(${c(ne)??""}% - 0.5px))`),$e(X,`left: ${c(ne)??""}%`)}),q("mousedown",Le,Re),q("touchstart",Le,Ge),Pe(re,ie),et()}var dt=_e('<div class="page-container svelte-q4ucql"><!></div>');function xt(re){var D=dt();rt(V=>{tt.title="Timelapse - Comparaison d'orthophotos"});var G=te(D);ct(G,{}),oe(D),Pe(re,D)}export{xt as component};
