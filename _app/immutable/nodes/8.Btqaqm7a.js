import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Ee,K as C,A as ve,B as Me,C as we,J as Ie,am as O,F as U,D,w as a,M as g,G as K,ao as ke}from"../chunks/Ehb9Q6W5.js";import{o as De,e as _,h as Fe}from"../chunks/BKIJojkU.js";import{s as he}from"../chunks/yJVuIktW.js";import{b as ce}from"../chunks/m2zDNTuv.js";import{i as Re}from"../chunks/D631TkqT.js";import{S as Ne,m as F,M as Ge}from"../chunks/VYvS0YDk.js";import{o as We}from"../chunks/CUZUMNKG.js";import{Y as ge}from"../chunks/Br037vyA.js";var Ze=ve('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function Ye(X,q){Ee(q,!1);let B=C(),R=C(),z=C(),i,x,N=C(50),S=!1,J=C({lng:4.5,lat:50.5}),de=C(8);const m=We.orthophotos.reduce((e,r)=>{const l=r.year.split(" ")[0],p=e.find(f=>f.year===l);return p?p.layers.push(r):e.push({id:l,year:l,displayYear:l,layers:[r]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((r,l)=>{const p=f=>/Printemps/i.test(f)?0:/Été|Ete/i.test(f)?1:2;return p(r.year)-p(l.year)})}));let T=C(m[0].id),P=C(m[m.length-1].id);function be(e){e.preventDefault(),e.stopPropagation(),S=!0}function xe(e){if(!S||!a(z))return;e.preventDefault();const r=a(z).getBoundingClientRect(),l=e.clientX-r.left;g(N,Math.max(0,Math.min(100,l/r.width*100)))}function Le(){S=!1}function Ce(e){e.preventDefault(),e.stopPropagation(),S=!0}function Se(e){if(!S||!a(z))return;e.preventDefault();const r=a(z).getBoundingClientRect(),l=e.touches[0].clientX-r.left;g(N,Math.max(0,Math.min(100,l/r.width*100)))}function ze(){S=!1}function G(e,r){const l=e.getStyle();if(l?.layers)for(const n of l.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const c=n.source;c&&e.getSource(c)&&e.removeSource(c)}r.layers.forEach(n=>{const c=n.id,M=`${n.id}-layer`;e.getSource(c)||e.addSource(c,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(M)||e.addLayer({id:M,type:"raster",source:c,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(n=>{const c=`${n.id}-layer`;e.getLayer(c)&&e.moveLayer(c)});const p=r.layers.map(n=>`${n.id}-layer`);let f=0;const Y=p.length,ee=()=>{f++,f>=Y&&p.forEach(n=>{e.getLayer(n)&&e.setPaintProperty(n,"raster-opacity",1)})},H=n=>{n.isSourceLoaded&&n.sourceId&&r.layers.some(c=>c.id===n.sourceId)&&ee()};e.on("sourcedata",H),setTimeout(()=>{e.off("sourcedata",H),p.forEach(n=>{e.getLayer(n)&&e.getPaintProperty(n,"raster-opacity")===0&&e.setPaintProperty(n,"raster-opacity",1)})},2e3)}let E=null;function Te(e){if(!i)return;const r=m.find(l=>l.id===e);r&&(G(i,r),g(T,e),E&&E(!0))}function Pe(e){if(!x)return;const r=m.find(l=>l.id===e);r&&(G(x,r),g(P,e),E&&E(!0))}De(async()=>{let e=!1;const r=new Map,l=[[2.75,49.45],[6.5,50.85]],p=[[2,49],[7.2,51.3]];let f=null;const Y=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),d=parseFloat(t[1]),w=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(d)&&!isNaN(w)){if(f={center:[d,s],zoom:w},t.length>=5){const j=t[3],se=t[4];m.find(k=>k.id===j)&&g(T,j),m.find(k=>k.id===se)&&g(P,se)}return!0}}return!1};Y()||(await new Promise(o=>setTimeout(o,10)),Y());const ee=m.find(o=>o.id===a(T)),H=m.find(o=>o.id===a(P));i=new F.Map({container:a(B),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:p,attributionControl:!1}),x=new F.Map({container:a(R),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:p,interactive:!1,attributionControl:!1}),i.once("load",()=>G(i,ee)),x.once("load",()=>G(x,H)),i.addControl(new F.NavigationControl,"bottom-left"),i.addControl(new F.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const n={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(r.has(t))return r.get(t);const s=[];try{const w=encodeURIComponent(t);if(!w)return{type:"FeatureCollection",features:s};const j=`https://nominatim.openstreetmap.org/search?q=${w}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,k=await(await fetch(j,{headers:{"Accept-Language":"fr"}})).json(),qe=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const y of k.features??[]){const ae=y.properties?.address?.state,Be=y.properties?.address?.county;if(!(ae==="Wallonie"||ae==="Région wallonne"||qe.some(b=>Be?.includes(b)||ae?.includes(b))))continue;const ie=y.bbox,L=Array.isArray(ie)&&ie.length===4?ie.map(Number):void 0;let $;if(L)$=[L[0]+(L[2]-L[0])/2,L[1]+(L[3]-L[1])/2];else if(y.geometry?.type==="Point"&&Array.isArray(y.geometry.coordinates))$=[Number(y.geometry.coordinates[0]),Number(y.geometry.coordinates[1])];else{const b=[],ye=u=>{u&&(u.type==="Point"?b.push([+u.coordinates[0],+u.coordinates[1]]):u.type==="LineString"||u.type==="MultiPoint"?u.coordinates.forEach(h=>b.push([+h[0],+h[1]])):u.type==="Polygon"||u.type==="MultiLineString"?u.coordinates.flat(1).forEach(h=>b.push([+h[0],+h[1]])):u.type==="MultiPolygon"?u.coordinates.flat(2).forEach(h=>b.push([+h[0],+h[1]])):u.type==="GeometryCollection"&&(u.geometries||[]).forEach(ye))};if(ye(y.geometry),b.length){const u=b.map(le=>le[0]),h=b.map(le=>le[1]),A=[Math.min(...u),Math.min(...h),Math.max(...u),Math.max(...h)];$=[A[0]+(A[2]-A[0])/2,A[1]+(A[3]-A[1])/2]}else $=[4.4699,50.5039]}s.push({type:"Feature",geometry:{type:"Point",coordinates:$},place_name:y.properties?.display_name,properties:{...y.properties,bbox:L},text:y.properties?.display_name,place_type:["place"],center:$,bbox:L})}}catch(w){console.error("forwardGeocode error:",w)}const d={type:"FeatureCollection",features:s};if(r.size>=50){const w=r.keys().next().value;w!==void 0&&r.delete(w)}return r.set(t,d),d}},c=new Ge(n,{maplibregl:F,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});i.addControl(c,"top-left");const M=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?i.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):i.flyTo({center:o.center,zoom:15,duration:1200})};let I=[],v=0;c.on("results",o=>{I=o.features||[],v=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(s=>s.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const s=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&I.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const d=I[v];d&&(M(d),t.target.value="",c.clear(),I=[])}else t.key==="ArrowDown"&&s.length>0?(t.preventDefault(),v=Math.min(v+1,I.length-1),s.forEach(d=>d.classList.remove("active")),s[v]&&s[v].classList.add("active")):t.key==="ArrowUp"&&s.length>0&&(t.preventDefault(),v=Math.max(v-1,0),s.forEach(d=>d.classList.remove("active")),s[v]&&s[v].classList.add("active"))},!0)},100),c.on("result",o=>{const t=o.result;M(t),setTimeout(()=>{const s=document.querySelector(".maplibregl-ctrl-geocoder input");s&&(s.value=""),c.clear()},100)});const _e=(o,t)=>{e||(e=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let te=null,me="";const oe=(o=!1)=>{if(typeof window>"u"||!i)return;const t=i.getCenter(),s=i.getZoom(),d=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${s.toFixed(2)}z,${a(T)},${a(P)}`;d!==me&&(me=d,o?window.location.hash=d:history.replaceState(null,"",`#${d}`))};E=oe,i.on("move",()=>{!S&&!e&&_e(i,x);const o=i.getCenter();g(J,{lng:o.lng,lat:o.lat}),g(de,i.getZoom()),oe(!1),te&&clearTimeout(te),te=window.setTimeout(()=>{oe(!0)},1e3)});let re=null;const ne=()=>{re||(re=window.setTimeout(()=>{i&&i.resize(),x&&x.resize(),re=null},250))};return setTimeout(ne,100),window.addEventListener("resize",ne),()=>{window.removeEventListener("resize",ne),i.remove(),x.remove()}}),Re();var V=Ze();_("mousemove",O,xe),_("mouseup",O,Le),_("touchmove",O,Se),_("touchend",O,ze);var W=U(V),ue=U(W);ce(ue,e=>g(B,e),()=>a(B));var Q=D(ue,2);ce(Q,e=>g(R,e),()=>a(R));var Z=D(Q,2),fe=U(Z);K(Z);var $e=D(Z,2);Ne($e,{get lat(){return a(J).lat},get lng(){return a(J).lng},get zoom(){return a(de)},get yearBefore(){return a(T)},get yearAfter(){return a(P)},shareText:""}),K(W),ce(W,e=>g(z,e),()=>a(z));var pe=D(W,2);ge(pe,{side:"left",get groups(){return m},get selectedId(){return a(T)},$$events:{select:e=>Te(e.detail.id)}});var Ae=D(pe,2);ge(Ae,{side:"right",get groups(){return m},get selectedId(){return a(P)},$$events:{select:e=>Pe(e.detail.id)}}),K(V),Me(()=>{he(Q,`clip-path: inset(0 0 0 ${a(N)??""}%)`),he(Z,`left: ${a(N)??""}%`)}),_("mousedown",fe,be),_("touchstart",fe,Ce),we(X,V),Ie()}var He=ve('<div class="page-container svelte-q4ucql"><!></div>');function rt(X){var q=He();Fe(R=>{ke.title="Timelapse - Comparaison d'orthophotos"});var B=U(q);Ye(B,{}),K(q),we(X,q)}export{rt as component};
