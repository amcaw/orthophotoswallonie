import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Me,K as A,A as be,B as Fe,C as xe,J as Ie,am as D,F as X,D as Y,w as a,M as h,G as J,ao as ke}from"../chunks/Ehb9Q6W5.js";import{o as Ge,e as E,h as Re}from"../chunks/BKIJojkU.js";import{s as ve}from"../chunks/yJVuIktW.js";import{b as de}from"../chunks/m2zDNTuv.js";import{i as De}from"../chunks/D631TkqT.js";import{S as Ye,m as W,M as We}from"../chunks/VYvS0YDk.js";import{o as Ze}from"../chunks/CUZUMNKG.js";import{Y as we}from"../chunks/Br037vyA.js";var He=be('<div class="timelapse-container svelte-qt8w5r"><div class="map-wrapper svelte-qt8w5r"><div class="map-container before svelte-qt8w5r"></div> <div class="map-container after svelte-qt8w5r"></div> <div class="compare-slider svelte-qt8w5r"><div class="slider-handle svelte-qt8w5r" role="button" tabindex="0"><span class="slider-arrows svelte-qt8w5r">◄ ►</span></div></div> <!></div> <!> <!></div>');function je(V,M){Me(M,!1);let F=A(),Z=A(),_=A(),i,b,H=A(50),T=!1,Q=A({lng:4.5,lat:50.5}),ue=A(8);const p=Ze.orthophotos.reduce((e,r)=>{const l=r.year.split(" ")[0],y=e.find(f=>f.year===l);return y?y.layers.push(r):e.push({id:l,year:l,displayYear:l,layers:[r]}),e},[]).map(e=>({...e,layers:e.layers.slice().sort((r,l)=>{const y=f=>/Printemps/i.test(f)?0:/Été|Ete/i.test(f)?1:2;return y(r.year)-y(l.year)})}));let S=A(p[0].id),$=A(p[p.length-1].id);function Le(e){e.preventDefault(),e.stopPropagation(),T=!0}function Ce(e){if(!T||!a(_))return;e.preventDefault();const r=a(_).getBoundingClientRect(),l=e.clientX-r.left;h(H,Math.max(0,Math.min(100,l/r.width*100)))}function ze(){T=!1}function Te(e){T=!0}function Se(e){if(!T||!a(_))return;const r=a(_).getBoundingClientRect(),l=e.touches[0].clientX-r.left;h(H,Math.max(0,Math.min(100,l/r.width*100)))}function $e(){T=!1}function Pe(){T=!1}function q(e,r){const l=e.getStyle();if(l?.layers)for(const n of l.layers){if(!n.id.endsWith("-layer"))continue;e.getLayer(n.id)&&e.removeLayer(n.id);const d=n.source;d&&e.getSource(d)&&e.removeSource(d)}r.layers.forEach(n=>{const d=n.id,k=`${n.id}-layer`;e.getSource(d)||e.addSource(d,{type:"raster",tiles:[`${n.url}/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&f=image`],tileSize:256,maxzoom:18}),e.getLayer(k)||e.addLayer({id:k,type:"raster",source:d,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),r.layers.forEach(n=>{const d=`${n.id}-layer`;e.getLayer(d)&&e.moveLayer(d)});const y=r.layers.map(n=>`${n.id}-layer`);let f=0;const U=y.length,oe=()=>{f++,f>=U&&y.forEach(n=>{e.getLayer(n)&&e.setPaintProperty(n,"raster-opacity",1)})},K=n=>{n.isSourceLoaded&&n.sourceId&&r.layers.some(d=>d.id===n.sourceId)&&oe()};e.on("sourcedata",K),setTimeout(()=>{e.off("sourcedata",K),y.forEach(n=>{e.getLayer(n)&&e.getPaintProperty(n,"raster-opacity")===0&&e.setPaintProperty(n,"raster-opacity",1)})},2e3)}let I=null;function Ae(e){if(!i)return;const r=p.find(l=>l.id===e);r&&(q(i,r),h(S,e),I&&I(!0))}function Ee(e){if(!b)return;const r=p.find(l=>l.id===e);r&&(q(b,r),h($,e),I&&I(!0))}Ge(async()=>{let e=!1;const r=new Map,l=[[2.75,49.45],[6.5,50.85]],y=[[2,49],[7.2,51.3]];let f=null;const U=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),c=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(c)&&!isNaN(m)){if(f={center:[c,s],zoom:m},t.length>=5){const C=t[3],P=t[4];p.find(g=>g.id===C)&&h(S,C),p.find(g=>g.id===P)&&h($,P)}return!0}}return!1};U()||(await new Promise(o=>setTimeout(o,10)),U());const oe=p.find(o=>o.id===a(S)),K=p.find(o=>o.id===a($));i=new W.Map({container:a(F),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:y,attributionControl:!1}),b=new W.Map({container:a(Z),style:{version:8,sources:{},layers:[]},...f?{center:f.center,zoom:f.zoom}:{bounds:l,fitBoundsOptions:{padding:-50}},minZoom:7,maxZoom:17,maxBounds:y,interactive:!1,attributionControl:!1}),i.once("load",()=>q(i,oe)),b.once("load",()=>q(b,K)),i.addControl(new W.NavigationControl,"bottom-left"),i.addControl(new W.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Service public de Wallonie (Licence CC-BY 4.0)'}),"bottom-right");const n={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(r.has(t))return r.get(t);const s=[];try{const m=encodeURIComponent(t);if(!m)return{type:"FeatureCollection",features:s};const C=`https://nominatim.openstreetmap.org/search?q=${m}, Wallonie&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,g=await(await fetch(C,{headers:{"Accept-Language":"fr"}})).json(),R=["Hainaut","Liège","Luxembourg","Namur","Brabant wallon"];for(const v of g.features??[]){const ie=v.properties?.address?.state,Ne=v.properties?.address?.county;if(!(ie==="Wallonie"||ie==="Région wallonne"||R.some(L=>Ne?.includes(L)||ie?.includes(L))))continue;const le=v.bbox,z=Array.isArray(le)&&le.length===4?le.map(Number):void 0;let B;if(z)B=[z[0]+(z[2]-z[0])/2,z[1]+(z[3]-z[1])/2];else if(v.geometry?.type==="Point"&&Array.isArray(v.geometry.coordinates))B=[Number(v.geometry.coordinates[0]),Number(v.geometry.coordinates[1])];else{const L=[],ge=u=>{u&&(u.type==="Point"?L.push([+u.coordinates[0],+u.coordinates[1]]):u.type==="LineString"||u.type==="MultiPoint"?u.coordinates.forEach(w=>L.push([+w[0],+w[1]])):u.type==="Polygon"||u.type==="MultiLineString"?u.coordinates.flat(1).forEach(w=>L.push([+w[0],+w[1]])):u.type==="MultiPolygon"?u.coordinates.flat(2).forEach(w=>L.push([+w[0],+w[1]])):u.type==="GeometryCollection"&&(u.geometries||[]).forEach(ge))};if(ge(v.geometry),L.length){const u=L.map(ce=>ce[0]),w=L.map(ce=>ce[1]),N=[Math.min(...u),Math.min(...w),Math.max(...u),Math.max(...w)];B=[N[0]+(N[2]-N[0])/2,N[1]+(N[3]-N[1])/2]}else B=[4.4699,50.5039]}s.push({type:"Feature",geometry:{type:"Point",coordinates:B},place_name:v.properties?.display_name,properties:{...v.properties,bbox:z},text:v.properties?.display_name,place_type:["place"],center:B,bbox:z})}}catch(m){console.error("forwardGeocode error:",m)}const c={type:"FeatureCollection",features:s};if(r.size>=50){const m=r.keys().next().value;m!==void 0&&r.delete(m)}return r.set(t,c),c}},d=new We(n,{maplibregl:W,placeholder:"Cherchez une adresse en Wallonie",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});i.addControl(d,"top-left");const k=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?i.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):i.flyTo({center:o.center,zoom:15,duration:1200})};let G=[],x=0;d.on("results",o=>{G=o.features||[],x=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(s=>s.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const s=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&G.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const c=G[x];c&&(k(c),t.target.value="",d.clear(),G=[])}else t.key==="ArrowDown"&&s.length>0?(t.preventDefault(),x=Math.min(x+1,G.length-1),s.forEach(c=>c.classList.remove("active")),s[x]&&s[x].classList.add("active")):t.key==="ArrowUp"&&s.length>0&&(t.preventDefault(),x=Math.max(x-1,0),s.forEach(c=>c.classList.remove("active")),s[x]&&s[x].classList.add("active"))},!0)},100),d.on("result",o=>{const t=o.result;k(t),setTimeout(()=>{const s=document.querySelector(".maplibregl-ctrl-geocoder input");s&&(s.value=""),d.clear()},100)});const Be=(o,t)=>{e||(e=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{e=!1}))};let re=null,he="";const ne=(o=!1)=>{if(typeof window>"u"||!i)return;const t=i.getCenter(),s=i.getZoom(),c=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${s.toFixed(2)}z,${a(S)},${a($)}`;c!==he&&(he=c,o?window.location.hash=c:history.replaceState(null,"",`#${c}`))};I=ne,i.on("move",()=>{!T&&!e&&Be(i,b);const o=i.getCenter();h(Q,{lng:o.lng,lat:o.lat}),h(ue,i.getZoom()),ne(!1),re&&clearTimeout(re),re=window.setTimeout(()=>{ne(!0)},1e3)});let se=null;const ae=()=>{se||(se=window.setTimeout(()=>{i&&i.resize(),b&&b.resize(),se=null},250))};setTimeout(ae,100),window.addEventListener("resize",ae);const ye=()=>{if(typeof window>"u")return;const o=window.location.hash.slice(1);if(!o)return;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),c=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(c)&&!isNaN(m)&&(i&&i.flyTo({center:[c,s],zoom:m,duration:1e3}),t.length>=5)){const C=t[3],P=t[4];if(C&&C!==a(S)){const g=p.find(R=>R.id===C);g&&(h(S,C),q(i,g))}if(P&&P!==a($)){const g=p.find(R=>R.id===P);g&&(h($,P),q(b,g))}}}};return window.addEventListener("hashchange",ye),()=>{window.removeEventListener("resize",ae),window.removeEventListener("hashchange",ye),i.remove(),b.remove()}}),De();var ee=He();E("mousemove",D,Ce),E("mouseup",D,ze),E("touchmove",D,Se),E("touchend",D,$e),E("touchcancel",D,Pe);var j=X(ee),fe=X(j);de(fe,e=>h(F,e),()=>a(F));var te=Y(fe,2);de(te,e=>h(Z,e),()=>a(Z));var O=Y(te,2),pe=X(O);J(O);var _e=Y(O,2);Ye(_e,{get lat(){return a(Q).lat},get lng(){return a(Q).lng},get zoom(){return a(ue)},get yearBefore(){return a(S)},get yearAfter(){return a($)},shareText:""}),J(j),de(j,e=>h(_,e),()=>a(_));var me=Y(j,2);we(me,{side:"left",get groups(){return p},get selectedId(){return a(S)},$$events:{select:e=>Ae(e.detail.id)}});var qe=Y(me,2);we(qe,{side:"right",get groups(){return p},get selectedId(){return a($)},$$events:{select:e=>Ee(e.detail.id)}}),J(ee),Fe(()=>{ve(te,`clip-path: inset(0 0 0 ${a(H)??""}%)`),ve(O,`left: ${a(H)??""}%`)}),E("mousedown",pe,Le),E("touchstart",pe,Te),xe(V,ee),Ie()}var Oe=be('<div class="page-container svelte-q4ucql"><!></div>');function st(V){var M=Oe();Re(Z=>{ke.title="Timelapse - Comparaison d'orthophotos"});var F=X(M);je(F,{}),J(M),xe(V,M)}export{st as component};
