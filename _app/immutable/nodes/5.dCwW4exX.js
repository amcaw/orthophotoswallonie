import"../chunks/DsnmJJEf.js";import"../chunks/z-ChGS7w.js";import{I as Ie,K as x,A as Se,B as _e,C as Ee,J as Ge,am as j,F as V,D,w as n,M as h,G as X}from"../chunks/Ehb9Q6W5.js";import{o as Fe,e as N}from"../chunks/BKIJojkU.js";import{s as ve}from"../chunks/yJVuIktW.js";import{b as ce}from"../chunks/m2zDNTuv.js";import{i as ke}from"../chunks/D631TkqT.js";import{S as De,m as H,M as He}from"../chunks/VYvS0YDk.js";import{o as we}from"../chunks/C4AmPXCP.js";import{Y as be}from"../chunks/Br037vyA.js";var Ye=Se('<div class="timelapse-container svelte-1awtn06"><div class="map-wrapper svelte-1awtn06"><div class="map-container before svelte-1awtn06"></div> <div class="map-container after svelte-1awtn06"></div> <div class="compare-slider svelte-1awtn06"><div class="slider-handle svelte-1awtn06" role="button" tabindex="0"><span class="slider-arrows svelte-1awtn06">◄ ►</span></div></div> <!></div> <!> <!></div>');function Oe(K,$){Ie($,!1);let I=x(),Q=x(),P=x(),a,v,Y=x(50),L=!1,J=x({lng:4.35,lat:50.85}),de=x(11);function Ce(e){const i=we;return e.service==="urban-brussels"&&e.crs==="EPSG:31370"?`${i.wmsUrbanBrusselsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=256&HEIGHT=256&BBOX={bbox-epsg-3857}`:`${i.wmsBaseUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=256&HEIGHT=256&BBOX={bbox-epsg-3857}`}const p=we.orthophotos.map(e=>({id:e.id,year:e.year,displayYear:e.year,layers:[e]}));let C=x(p[0].id),T=x(p[p.length-1].id);function Te(e){e.preventDefault(),e.stopPropagation(),L=!0}function Be(e){if(!L||!n(P))return;e.preventDefault();const i=n(P).getBoundingClientRect(),u=e.clientX-i.left;h(Y,Math.max(0,Math.min(100,u/i.width*100)))}function xe(){L=!1}function Le(e){e.preventDefault(),e.stopPropagation(),L=!0}function Ae(e){if(!L||!n(P))return;e.preventDefault();const i=n(P).getBoundingClientRect(),u=e.touches[0].clientX-i.left;h(Y,Math.max(0,Math.min(100,u/i.width*100)))}function Pe(){L=!1}function R(e,i){const u=e.getStyle();if(u?.layers)for(const r of u.layers){if(!r.id.endsWith("-layer"))continue;e.getLayer(r.id)&&e.removeLayer(r.id);const c=r.source;c&&e.getSource(c)&&e.removeSource(c)}i.layers.forEach(r=>{const c=r.id,F=`${r.id}-layer`;e.getSource(c)||e.addSource(c,{type:"raster",tiles:[Ce(r)],tileSize:256,maxzoom:20}),e.getLayer(F)||e.addLayer({id:F,type:"raster",source:c,paint:{"raster-opacity":0,"raster-fade-duration":0,"raster-resampling":"nearest"}})}),i.layers.forEach(r=>{const c=`${r.id}-layer`;e.getLayer(c)&&e.moveLayer(c)});const w=i.layers.map(r=>`${r.id}-layer`);let G=0;const q=w.length,oe=()=>{G++,G>=q&&w.forEach(r=>{e.getLayer(r)&&e.setPaintProperty(r,"raster-opacity",1)})},Z=r=>{r.isSourceLoaded&&r.sourceId&&i.layers.some(c=>c.id===r.sourceId)&&oe()};e.on("sourcedata",Z),setTimeout(()=>{e.off("sourcedata",Z),w.forEach(r=>{e.getLayer(r)&&e.getPaintProperty(r,"raster-opacity")===0&&e.setPaintProperty(r,"raster-opacity",1)})},2e3)}let _=null;function Re(e){if(!a)return;const i=p.find(u=>u.id===e);i&&(R(a,i),h(C,e),_&&_(!0))}function ze(e){if(!v)return;const i=p.find(u=>u.id===e);i&&(R(v,i),h(T,e),_&&_(!0))}Fe(async()=>{let e=null;const i=()=>{if(typeof window>"u")return!1;const o=window.location.hash.slice(1);if(!o)return!1;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),l=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(l)&&!isNaN(m)){if(e={center:[l,s],zoom:m},t.length>=5){const S=t[3],B=t[4];p.find(g=>g.id===S)&&h(C,S),p.find(g=>g.id===B)&&h(T,B)}return!0}}return!1};i()||(await new Promise(o=>setTimeout(o,10)),i());let u=!1;const w=new Map,G=[[4.243,50.764],[4.482,50.913]],q=[[4.05,50.65],[4.68,51.05]],oe=p.find(o=>o.id===n(C)),Z=p.find(o=>o.id===n(T));a=new H.Map({container:n(I),style:{version:8,sources:{},layers:[]},...e?{center:e.center,zoom:e.zoom}:{bounds:G,fitBoundsOptions:{padding:0}},minZoom:10,maxZoom:20,maxBounds:q,attributionControl:!1}),v=new H.Map({container:n(Q),style:{version:8,sources:{},layers:[]},...e?{center:e.center,zoom:e.zoom}:{bounds:G,fitBoundsOptions:{padding:0}},minZoom:10,maxZoom:20,maxBounds:q,interactive:!1,attributionControl:!1}),a.once("load",()=>R(a,oe)),v.once("load",()=>R(v,Z)),a.addControl(new H.NavigationControl,"bottom-left"),a.addControl(new H.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Creative Commons Attribution (CC-BY) - <a href="https://be.brussels/en/about-region/structure-and-organisations/administrations-and-institutions-region/paradigm" target="_blank">Paradigm</a> - <a href="https://bruciel.brussels/" target="_blank">Bruciel</a>'}),"bottom-right");const r={forwardGeocode:async o=>{const t=(o.query??"").trim().toLowerCase();if(w.has(t))return w.get(t);const s=[];try{const m=encodeURIComponent(t);if(!m)return{type:"FeatureCollection",features:s};const S=`https://nominatim.openstreetmap.org/search?q=${m}, Bruxelles&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,g=await(await fetch(S,{headers:{"Accept-Language":"fr"}})).json();for(const f of g.features??[]){const ge=f.properties?.address?.region,W=f.properties?.address?.state;if(!(ge?.includes("Bruxelles")||ge?.includes("Brussels")||W==="Bruxelles-Capitale"||W==="Brussels Hoofdstedelijk Gewest"||W==="Région de Bruxelles-Capitale"||W==="Brussels-Capital"))continue;const ie=f.bbox,E=Array.isArray(ie)&&ie.length===4?ie.map(Number):void 0;let z;if(E)z=[E[0]+(E[2]-E[0])/2,E[1]+(E[3]-E[1])/2];else if(f.geometry?.type==="Point"&&Array.isArray(f.geometry.coordinates))z=[Number(f.geometry.coordinates[0]),Number(f.geometry.coordinates[1])];else{const A=[],ye=d=>{d&&(d.type==="Point"?A.push([+d.coordinates[0],+d.coordinates[1]]):d.type==="LineString"||d.type==="MultiPoint"?d.coordinates.forEach(y=>A.push([+y[0],+y[1]])):d.type==="Polygon"||d.type==="MultiLineString"?d.coordinates.flat(1).forEach(y=>A.push([+y[0],+y[1]])):d.type==="MultiPolygon"?d.coordinates.flat(2).forEach(y=>A.push([+y[0],+y[1]])):d.type==="GeometryCollection"&&(d.geometries||[]).forEach(ye))};if(ye(f.geometry),A.length){const d=A.map(le=>le[0]),y=A.map(le=>le[1]),M=[Math.min(...d),Math.min(...y),Math.max(...d),Math.max(...y)];z=[M[0]+(M[2]-M[0])/2,M[1]+(M[3]-M[1])/2]}else z=[4.3517,50.8503]}s.push({type:"Feature",geometry:{type:"Point",coordinates:z},place_name:f.properties?.display_name,properties:{...f.properties,bbox:E},text:f.properties?.display_name,place_type:["place"],center:z,bbox:E})}}catch(m){console.error("forwardGeocode error:",m)}const l={type:"FeatureCollection",features:s};if(w.size>=50){const m=w.keys().next().value;m!==void 0&&w.delete(m)}return w.set(t,l),l}},c=new He(r,{maplibregl:H,placeholder:"Cherchez une adresse à Bruxelles",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl(c,"top-left");const F=o=>{const t=o.bbox??o.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:o.center,zoom:15,duration:1200})};let k=[],b=0;c.on("results",o=>{k=o.features||[],b=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(s=>s.classList.remove("active")),t[0].classList.add("active"))},50)}),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&o.addEventListener("keydown",t=>{const s=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&k.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=k[b];l&&(F(l),t.target.value="",c.clear(),k=[])}else t.key==="ArrowDown"&&s.length>0?(t.preventDefault(),b=Math.min(b+1,k.length-1),s.forEach(l=>l.classList.remove("active")),s[b]&&s[b].classList.add("active")):t.key==="ArrowUp"&&s.length>0&&(t.preventDefault(),b=Math.max(b-1,0),s.forEach(l=>l.classList.remove("active")),s[b]&&s[b].classList.add("active"))},!0)},100),c.on("result",o=>{const t=o.result;F(t),setTimeout(()=>{const s=document.querySelector(".maplibregl-ctrl-geocoder input");s&&(s.value=""),c.clear()},100)});const $e=(o,t)=>{u||(u=!0,t.jumpTo({center:o.getCenter(),zoom:o.getZoom(),bearing:o.getBearing(),pitch:o.getPitch()}),requestAnimationFrame(()=>{u=!1}))};let re=null,me="";const se=(o=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),s=a.getZoom(),l=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${s.toFixed(2)}z,${n(C)},${n(T)}`;l!==me&&(me=l,o?window.location.hash=l:history.replaceState(null,"",`#${l}`))};_=se,a.on("move",()=>{!L&&!u&&$e(a,v);const o=a.getCenter();h(J,{lng:o.lng,lat:o.lat}),h(de,a.getZoom()),se(!1),re&&clearTimeout(re),re=window.setTimeout(()=>{se(!0)},1e3)});let ne=null;const ae=()=>{ne||(ne=window.setTimeout(()=>{a&&a.resize(),v&&v.resize(),ne=null},250))};setTimeout(ae,100),window.addEventListener("resize",ae);const he=()=>{if(typeof window>"u")return;const o=window.location.hash.slice(1);if(!o)return;const t=o.split(",");if(t.length>=3){const s=parseFloat(t[0]),l=parseFloat(t[1]),m=parseFloat(t[2].replace("z",""));if(!isNaN(s)&&!isNaN(l)&&!isNaN(m)&&(a&&a.flyTo({center:[l,s],zoom:m,duration:1e3}),t.length>=5)){const S=t[3],B=t[4];if(S&&S!==n(C)){const g=p.find(f=>f.id===S);g&&(h(C,S),R(a,g))}if(B&&B!==n(T)){const g=p.find(f=>f.id===B);g&&(h(T,B),R(v,g))}}}};return window.addEventListener("hashchange",he),()=>{window.removeEventListener("resize",ae),window.removeEventListener("hashchange",he),a.remove(),v.remove()}}),ke();var ee=Ye();N("mousemove",j,Be),N("mouseup",j,xe),N("touchmove",j,Ae),N("touchend",j,Pe);var O=V(ee),ue=V(O);ce(ue,e=>h(I,e),()=>n(I));var te=D(ue,2);ce(te,e=>h(Q,e),()=>n(Q));var U=D(te,2),fe=V(U);X(U);var Me=D(U,2);De(Me,{get lat(){return n(J).lat},get lng(){return n(J).lng},get zoom(){return n(de)},get yearBefore(){return n(C)},get yearAfter(){return n(T)}}),X(O),ce(O,e=>h(P,e),()=>n(P));var pe=D(O,2);be(pe,{side:"left",get groups(){return p},get selectedId(){return n(C)},$$events:{select:e=>Re(e.detail.id)}});var Ne=D(pe,2);be(Ne,{side:"right",get groups(){return p},get selectedId(){return n(T)},$$events:{select:e=>ze(e.detail.id)}}),X(ee),_e(()=>{ve(te,`clip-path: inset(0 0 0 ${n(Y)??""}%)`),ve(U,`left: ${n(Y)??""}%`)}),N("mousedown",fe,Te),N("touchstart",fe,Le),Ee(K,ee),Ge()}var Ue=Se('<div class="page-container svelte-1ewpa8p"><!></div>');function ot(K){var $=Ue(),I=V($);Oe(I,{}),X($),Ee(K,$)}export{ot as component};
