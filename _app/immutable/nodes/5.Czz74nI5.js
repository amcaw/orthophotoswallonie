import"../chunks/DsnmJJEf.js";import"../chunks/CQmyZwkG.js";import{I as Ze,K as R,A as Me,B as je,C as $e,J as Ve,F as Q,D as O,w as c,M as w,G as ee}from"../chunks/CwdBl0A7.js";import{o as Je,e as K}from"../chunks/CFz4bSAm.js";import{s as Ae}from"../chunks/RwkDEKZ4.js";import{b as ye}from"../chunks/Cgb6JafD.js";import{i as Xe}from"../chunks/Ci2bA8W4.js";import{S as Ke,m as q,M as Qe}from"../chunks/DdJ4ZmzT.js";import{o as Re}from"../chunks/C4AmPXCP.js";import{Y as Pe}from"../chunks/BfrHnrU3.js";var et=Me('<div class="timelapse-container svelte-1awtn06"><div class="map-wrapper svelte-1awtn06"><div class="map-container before svelte-1awtn06"></div> <div class="map-container after svelte-1awtn06"></div> <div class="compare-slider svelte-1awtn06"><div class="slider-handle svelte-1awtn06" role="button" tabindex="0"><span class="slider-arrows svelte-1awtn06">◄ ►</span></div></div> <!></div> <!> <!></div>');function tt(te,k){Ze(k,!1);let G=R(),re=R(),Y=R(),a,m,oe=R(50),D=!1,W=null,ne=null;function Ne(e){w(oe,e),ne&&cancelAnimationFrame(ne),ne=requestAnimationFrame(()=>{m&&m.triggerRepaint()})}let se=R({lng:4.35,lat:50.85}),ve=R(11);function _e(e,n=512){const l=Re;return e.service==="urban-brussels"&&e.crs==="EPSG:31370"?`${l.wmsUrbanBrusselsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=${n}&HEIGHT=${n}&BBOX={bbox-epsg-3857}`:`${l.wmsBaseUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${e.layer}&CRS=EPSG:3857&STYLES=&WIDTH=${n}&HEIGHT=${n}&BBOX={bbox-epsg-3857}`}const we=new WeakMap;function ze(e){let n=we.get(e);return n||(n=new Set,we.set(e,n)),n}let be=new Set;function Fe(e,n,l=3e3){return new Promise(f=>{let g=!1;const E=()=>{g||(g=!0,M(),be.delete(T),f())},T=()=>{g||(console.log("Tile wait cancelled - user is interacting"),E())};be.add(T);const i=()=>{n.every(V=>{const J=V.replace(/-layer$/,"");return!!e.getSource(J)&&e.isSourceLoaded(J)})&&e.areTilesLoaded()&&E()},B=()=>{console.log("Map movement detected - finishing tile wait early"),E()},P=setTimeout(E,l),M=()=>{e.off("idle",i),e.off("movestart",B),clearTimeout(P)};e.on("idle",i),e.on("movestart",B),i()})}function ke(e,n,l=512){const f=n.id,g=`${n.id}-layer`;return e.getSource(f)||e.addSource(f,{type:"raster",tiles:[_e(n,l)],tileSize:l,maxzoom:20}),e.getLayer(g)||e.addLayer({id:g,type:"raster",source:f,layout:{visibility:"visible"},paint:{"raster-opacity":0,"raster-fade-duration":300,"raster-resampling":"nearest"}}),g}const h=Re.orthophotos.map(e=>({id:e.id,year:e.year,displayYear:e.year,layers:[e]}));let L=R(h[0].id),x=R(h[h.length-1].id);function Ge(e){e.currentTarget.setPointerCapture(e.pointerId),W=e.pointerId,D=!0}function He(e){if(!D||W!==e.pointerId||!c(Y))return;const n=c(Y).getBoundingClientRect(),l=e.clientX-n.left;Ne(Math.max(0,Math.min(100,l/n.width*100)))}function Se(e){if(W===e.pointerId){const n=e.currentTarget;try{n.releasePointerCapture(e.pointerId)}catch{}D=!1,W=null}}const ae=new WeakMap;async function _(e,n){const l=ae.get(e);l&&(console.log("Waiting for previous layer change to complete..."),await l);const f=(async()=>{const g=ze(e),E=[...g],T=n.layers.map(i=>ke(e,i,512));requestAnimationFrame(()=>{T.forEach(i=>{e.getLayer(i)&&e.moveLayer(i)})}),await Fe(e,T,1500),requestAnimationFrame(()=>{T.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",1)}),E.forEach(i=>{e.getLayer(i)&&e.setPaintProperty(i,"raster-opacity",0)})}),setTimeout(()=>{E.forEach(i=>{if(!T.includes(i)){const B=i.replace(/-layer$/,"");e.getLayer(i)&&e.removeLayer(i),e.getSource(B)&&e.removeSource(B),g.delete(i)}}),T.forEach(i=>g.add(i))},400)})();ae.set(e,f),await f,ae.delete(e)}let H=null;function Oe(e){if(!a)return;const n=h.find(l=>l.id===e);n&&(_(a,n),w(L,e),H&&H(!0))}function qe(e){if(!m)return;const n=h.find(l=>l.id===e);n&&(_(m,n),w(x,e),H&&H(!0))}Je(()=>{let e=null;(()=>{if(typeof window>"u")return!1;const r=window.location.hash.slice(1);if(!r)return!1;const t=r.split(",");if(t.length>=3){const o=parseFloat(t[0]),s=parseFloat(t[1]),d=parseFloat(t[2].replace("z",""));if(!isNaN(o)&&!isNaN(s)&&!isNaN(d)){if(e={center:[s,o],zoom:d},t.length>=5){const v=t[3],y=t[4];h.find(b=>b.id===v)&&w(L,v),h.find(b=>b.id===y)&&w(x,y)}return!0}}return!1})();let l=!1;const f=new Map,g=[[4.243,50.764],[4.482,50.913]],E=[[4.05,50.65],[4.68,51.05]],T=h.find(r=>r.id===c(L)),i=h.find(r=>r.id===c(x)),B={version:8,sources:{positron:{type:"raster",tiles:["https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png","https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],tileSize:256,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"positron-layer",type:"raster",source:"positron",paint:{"raster-opacity":1}}]},P={container:c(G),style:B,minZoom:10,maxZoom:20,maxBounds:E,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};e?(P.center=e.center,P.zoom=e.zoom):(P.bounds=g,P.fitBoundsOptions={padding:0}),a=new q.Map(P);const M={container:c(re),style:JSON.parse(JSON.stringify(B)),minZoom:10,maxZoom:20,maxBounds:E,interactive:!1,attributionControl:!1,renderWorldCopies:!1,fadeDuration:0};e?(M.center=e.center,M.zoom=e.zoom):(M.bounds=g,M.fitBoundsOptions={padding:0}),m=new q.Map(M);const ce=new Map,V=r=>t=>{if(console.warn("Map error:",t?.error?.status,t?.sourceId),t.sourceId&&t.error?.status>=500){const o=ce.get(t.sourceId)||0;o<2&&(ce.set(t.sourceId,o+1),setTimeout(()=>{const s=r.getSource(t.sourceId);s&&"reload"in s&&s.reload()},1e3*(o+1)))}};a.on("error",V(a)),m.on("error",V(m)),a.once("load",()=>_(a,T)),m.once("load",()=>_(m,i)),a.addControl(new q.NavigationControl,"bottom-left"),a.addControl(new q.AttributionControl({customAttribution:'Made by <a href="https://bsky.app/profile/amcaw.bsky.social" target="_blank">@amcaw</a> - Creative Commons Attribution (CC-BY) - <a href="https://be.brussels/en/about-region/structure-and-organisations/administrations-and-institutions-region/paradigm" target="_blank">Paradigm</a> - <a href="https://bruciel.brussels/" target="_blank">Bruciel</a>'}),"bottom-right");const J={forwardGeocode:async r=>{const t=(r.query??"").trim().toLowerCase();if(f.has(t))return f.get(t);const o=[];try{const d=encodeURIComponent(t);if(!d)return{type:"FeatureCollection",features:o};const v=`https://nominatim.openstreetmap.org/search?q=${d}, Bruxelles&format=geojson&polygon_geojson=1&addressdetails=1&countrycodes=be&limit=20`,b=await(await fetch(v,{headers:{"Accept-Language":"fr"}})).json();for(const p of b.features??[]){const xe=p.properties?.address?.region,X=p.properties?.address?.state;if(!(xe?.includes("Bruxelles")||xe?.includes("Brussels")||X==="Bruxelles-Capitale"||X==="Brussels Hoofdstedelijk Gewest"||X==="Région de Bruxelles-Capitale"||X==="Brussels-Capital"))continue;const ge=p.bbox,I=Array.isArray(ge)&&ge.length===4?ge.map(Number):void 0;let z;if(I)z=[I[0]+(I[2]-I[0])/2,I[1]+(I[3]-I[1])/2];else if(p.geometry?.type==="Point"&&Array.isArray(p.geometry.coordinates))z=[Number(p.geometry.coordinates[0]),Number(p.geometry.coordinates[1])];else{const N=[],Be=u=>{u&&(u.type==="Point"?N.push([+u.coordinates[0],+u.coordinates[1]]):u.type==="LineString"||u.type==="MultiPoint"?u.coordinates.forEach(S=>N.push([+S[0],+S[1]])):u.type==="Polygon"||u.type==="MultiLineString"?u.coordinates.flat(1).forEach(S=>N.push([+S[0],+S[1]])):u.type==="MultiPolygon"?u.coordinates.flat(2).forEach(S=>N.push([+S[0],+S[1]])):u.type==="GeometryCollection"&&(u.geometries||[]).forEach(Be))};if(Be(p.geometry),N.length){const u=N.map(he=>he[0]),S=N.map(he=>he[1]),F=[Math.min(...u),Math.min(...S),Math.max(...u),Math.max(...S)];z=[F[0]+(F[2]-F[0])/2,F[1]+(F[3]-F[1])/2]}else z=[4.3517,50.8503]}o.push({type:"Feature",geometry:{type:"Point",coordinates:z},place_name:p.properties?.display_name,properties:{...p.properties,bbox:I},text:p.properties?.display_name,place_type:["place"],center:z,bbox:I})}}catch(d){console.error("forwardGeocode error:",d)}const s={type:"FeatureCollection",features:o};if(f.size>=50){const d=f.keys().next().value;d!==void 0&&f.delete(d)}return f.set(t,s),s}},$=new Qe(J,{maplibregl:q,placeholder:"Cherchez une adresse à Bruxelles",flyTo:!1,showResultsWhileTyping:!0,marker:!1,debounceSearch:400,minLength:2,showResultMarkers:!1});a.addControl($,"top-left");const de=r=>{const t=r.bbox??r.properties?.bbox;t&&Array.isArray(t)&&t.length===4?a.fitBounds([[t[0],t[1]],[t[2],t[3]]],{padding:50,maxZoom:16,duration:1200}):a.flyTo({center:r.center,zoom:15,duration:1200})};let A=[],C=0;$.on("results",r=>{A=r.features||[],C=0,setTimeout(()=>{const t=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");t.length>0&&(t.forEach(o=>o.classList.remove("active")),t[0].classList.add("active"),t.forEach((o,s)=>{const d=v=>{if(v.preventDefault(),v.stopPropagation(),A[s]){const y=document.querySelector(".maplibregl-ctrl-geocoder input");y&&y.blur(),de(A[s]),setTimeout(()=>{y&&(y.value=""),$.clear(),A=[]},100)}};o.removeEventListener("touchend",d),o.removeEventListener("click",d),o.addEventListener("touchend",d,{passive:!1}),o.addEventListener("click",d)}))},50)}),setTimeout(()=>{const r=document.querySelector(".maplibregl-ctrl-geocoder input");r&&r.addEventListener("keydown",t=>{const o=document.querySelectorAll(".maplibregl-ctrl-geocoder .suggestions > li");if(t.key==="Enter"&&A.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const s=A[C];s&&(de(s),t.target.value="",$.clear(),A=[])}else t.key==="ArrowDown"&&o.length>0?(t.preventDefault(),C=Math.min(C+1,A.length-1),o.forEach(s=>s.classList.remove("active")),o[C]&&o[C].classList.add("active")):t.key==="ArrowUp"&&o.length>0&&(t.preventDefault(),C=Math.max(C-1,0),o.forEach(s=>s.classList.remove("active")),o[C]&&o[C].classList.add("active"))},!0)},100),$.on("result",r=>{const t=r.result;de(t),setTimeout(()=>{const o=document.querySelector(".maplibregl-ctrl-geocoder input");o&&(o.value=""),$.clear()},100)});const We=(r,t)=>{l||(l=!0,t.jumpTo({center:r.getCenter(),zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}),requestAnimationFrame(()=>{l=!1}))};let ue=null,Ce="";const fe=(r=!1)=>{if(typeof window>"u"||!a)return;const t=a.getCenter(),o=a.getZoom(),s=`${t.lat.toFixed(6)},${t.lng.toFixed(6)},${o.toFixed(2)}z,${c(L)},${c(x)}`;s!==Ce&&(Ce=s,r?window.location.hash=s:history.replaceState(null,"",`#${s}`))};H=fe;let Ie=0;a.on("move",()=>{!D&&!l&&We(a,m);const r=a.getCenter();w(se,{lng:r.lng,lat:r.lat}),w(ve,a.getZoom());const t=performance.now();t-Ie>120&&(fe(!1),Ie=t),ue&&clearTimeout(ue),ue=window.setTimeout(()=>{fe(!0)},800)});let pe=null;const me=()=>{pe||(pe=window.setTimeout(()=>{a&&a.resize(),m&&m.resize(),pe=null},250))};setTimeout(me,100),window.addEventListener("resize",me);const Le=()=>{if(typeof window>"u")return;const r=window.location.hash.slice(1);if(!r)return;const t=r.split(",");if(t.length>=3){const o=parseFloat(t[0]),s=parseFloat(t[1]),d=parseFloat(t[2].replace("z",""));if(!isNaN(o)&&!isNaN(s)&&!isNaN(d)&&(a&&a.flyTo({center:[s,o],zoom:d,duration:1e3}),t.length>=5)){const v=t[3],y=t[4];if(v&&v!==c(L)){const b=h.find(p=>p.id===v);b&&(w(L,v),_(a,b))}if(y&&y!==c(x)){const b=h.find(p=>p.id===y);b&&(w(x,y),_(m,b))}}}};window.addEventListener("hashchange",Le);const Ue=setInterval(()=>{l&&(console.warn("isSyncing stuck - forcing reset"),l=!1)},5e3);return()=>{window.removeEventListener("resize",me),window.removeEventListener("hashchange",Le),clearInterval(Ue),a.remove(),m.remove()}}),Xe();var ie=et(),U=Q(ie),Ee=Q(U);ye(Ee,e=>w(G,e),()=>c(G));var le=O(Ee,2);ye(le,e=>w(re,e),()=>c(re));var Z=O(le,2),j=Q(Z);ee(Z);var Ye=O(Z,2);Ke(Ye,{get lat(){return c(se).lat},get lng(){return c(se).lng},get zoom(){return c(ve)},get yearBefore(){return c(L)},get yearAfter(){return c(x)}}),ee(U),ye(U,e=>w(Y,e),()=>c(Y));var Te=O(U,2);Pe(Te,{side:"left",get groups(){return h},get selectedId(){return c(L)},$$events:{select:e=>Oe(e.detail.id)}});var De=O(Te,2);Pe(De,{side:"right",get groups(){return h},get selectedId(){return c(x)},$$events:{select:e=>qe(e.detail.id)}}),ee(ie),je(()=>{Ae(le,`clip-path: inset(0 0 0 calc(${c(oe)??""}% - 0.5px))`),Ae(Z,`left: ${c(oe)??""}%`)}),K("pointerdown",j,Ge),K("pointermove",j,He),K("pointerup",j,Se),K("pointercancel",j,Se),$e(te,ie),Ve()}var rt=Me('<div class="page-container svelte-1ewpa8p"><!></div>');function mt(te){var k=rt(),G=Q(k);tt(G,{}),ee(k),$e(te,k)}export{mt as component};
